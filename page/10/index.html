<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  

  
  <title>Hexo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta property="og:type" content="website">
<meta property="og:title" content="Hexo">
<meta property="og:url" content="http://yoursite.com/page/10/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="John Doe">
<meta name="twitter:card" content="summary">
  
    <link rel="alternate" href="/atom.xml" title="Hexo" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  
<link rel="stylesheet" href="/css/style.css">

<meta name="generator" content="Hexo 4.2.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Hexo</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://yoursite.com"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main">
  
    <article id="default-2018-5-1-hive" class="article article-type-default" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018/05/01/2018-5-1-hive/" class="article-date">
  <time datetime="2018-04-30T16:00:00.000Z" itemprop="datePublished">2018-05-01</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2018/05/01/2018-5-1-hive/">hive</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="hive"><a href="#hive" class="headerlink" title="hive"></a>hive</h1><p>把查询转化为一个MapReduce作业，并为我们执行这个作业。</p>
<p>在文件系统级别，分区只是表目录下嵌套的子目录。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2018/05/01/2018-5-1-hive/" data-id="ck521h13d004olc7k5nlxebo4" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="default-2018-4-30-dbcp" class="article article-type-default" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018/04/30/2018-4-30-dbcp/" class="article-date">
  <time datetime="2018-04-29T16:00:00.000Z" itemprop="datePublished">2018-04-30</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2018/04/30/2018-4-30-dbcp/">dbcp</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="tomcat数据库连接池DBCP"><a href="#tomcat数据库连接池DBCP" class="headerlink" title="tomcat数据库连接池DBCP"></a>tomcat数据库连接池DBCP</h1><h2 id="连接的生命周期"><a href="#连接的生命周期" class="headerlink" title="连接的生命周期"></a>连接的生命周期</h2><h3 id="出生"><a href="#出生" class="headerlink" title="出生"></a>出生</h3><h3 id="校验"><a href="#校验" class="headerlink" title="校验"></a>校验</h3><h3 id="激活"><a href="#激活" class="headerlink" title="激活"></a>激活</h3><h3 id="借用"><a href="#借用" class="headerlink" title="借用"></a>借用</h3><h3 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h3><h3 id="归还"><a href="#归还" class="headerlink" title="归还"></a>归还</h3><h3 id="钝化"><a href="#钝化" class="headerlink" title="钝化"></a>钝化</h3><h3 id="销毁"><a href="#销毁" class="headerlink" title="销毁"></a>销毁</h3>
      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2018/04/30/2018-4-30-dbcp/" data-id="ck521h13b004llc7kgkppaebo" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="default-2018-4-30-server框架" class="article article-type-default" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018/04/30/2018-4-30-server%E6%A1%86%E6%9E%B6/" class="article-date">
  <time datetime="2018-04-29T16:00:00.000Z" itemprop="datePublished">2018-04-30</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2018/04/30/2018-4-30-server%E6%A1%86%E6%9E%B6/">server</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="web-server框架"><a href="#web-server框架" class="headerlink" title="web server框架"></a>web server框架</h1><h2 id="nginx-php"><a href="#nginx-php" class="headerlink" title="nginx + php"></a>nginx + php</h2><p>yii2</p>
<p>thinkphp</p>
<h2 id="python"><a href="#python" class="headerlink" title="python"></a>python</h2><p>flask</p>
<h2 id="net"><a href="#net" class="headerlink" title=".net"></a>.net</h2><p>servicestack</p>
<h2 id="java"><a href="#java" class="headerlink" title="java"></a>java</h2><p>jetty</p>
<p>tomcat</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2018/04/30/2018-4-30-server%E6%A1%86%E6%9E%B6/" data-id="ck521h13b004mlc7kczmgaz3h" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="default-2018-4-30-web-program" class="article article-type-default" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018/04/30/2018-4-30-web-program/" class="article-date">
  <time datetime="2018-04-29T16:00:00.000Z" itemprop="datePublished">2018-04-30</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2018/04/30/2018-4-30-web-program/">网络编程</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="linux网络编程基础"><a href="#linux网络编程基础" class="headerlink" title="linux网络编程基础"></a>linux网络编程基础</h1><h2 id="最原始的web服务器"><a href="#最原始的web服务器" class="headerlink" title="最原始的web服务器"></a>最原始的web服务器</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; 监听端口</span><br><span class="line">open_listenfd()</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; 不断循环</span><br><span class="line">while(1) &#123;</span><br><span class="line">	</span><br><span class="line">	&#x2F;&#x2F; 新连接</span><br><span class="line">	fd &#x3D; accept()</span><br><span class="line">	&#x2F;&#x2F; 处理连接</span><br><span class="line">	doit(fd)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; 处理连接</span><br><span class="line">doit() &#123;</span><br><span class="line">	&#x2F;&#x2F; 读http header</span><br><span class="line">	Rio_readline()</span><br><span class="line">	</span><br><span class="line">	&#x2F;&#x2F; 解析uri</span><br><span class="line">	parse_uri()</span><br><span class="line">	</span><br><span class="line">	&#x2F;&#x2F; 如果是静态内容,则验证该文件是静态文件，然后返回文件内容</span><br><span class="line">	serve_static()</span><br><span class="line">	</span><br><span class="line">	&#x2F;&#x2F; 如果是动态内容，则验证该文件是可执行文件</span><br><span class="line">	serve_dynamic()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; 处理动态内容</span><br><span class="line">serve_dynamic() &#123;</span><br><span class="line">	&#x2F;&#x2F; 创建子进程</span><br><span class="line">	Fork()		</span><br><span class="line">	&#x2F;&#x2F; 设置uri参数到环境变量</span><br><span class="line">	setenv()</span><br><span class="line">	&#x2F;&#x2F; 重定向子进程标准输出到描述符fd</span><br><span class="line">	Dup2(fd, STDOUT_FILENO)</span><br><span class="line">	&#x2F;&#x2F; 运行可执行文件</span><br><span class="line">	Execve()	</span><br><span class="line">	&#x2F;&#x2F; 父进程等待子进程结束</span><br><span class="line">	Wait()					</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="引入并发编程改进web服务器"><a href="#引入并发编程改进web服务器" class="headerlink" title="引入并发编程改进web服务器"></a>引入并发编程改进web服务器</h2><h3 id="基于进程"><a href="#基于进程" class="headerlink" title="基于进程"></a>基于进程</h3><h3 id="基于IO多路复用"><a href="#基于IO多路复用" class="headerlink" title="基于IO多路复用"></a>基于IO多路复用</h3><p>同时知道listenfd监听描述符和readfd读描述符是否准备好，并做相应处理</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">Open_listenfd()</span><br><span class="line"></span><br><span class="line">init_pool()</span><br><span class="line"></span><br><span class="line">while(1) &#123;</span><br><span class="line"></span><br><span class="line">	select()</span><br><span class="line">	</span><br><span class="line">	if(listenfd) &#123;</span><br><span class="line">	</span><br><span class="line">		Accept()</span><br><span class="line">		&#x2F;&#x2F; 新连接	</span><br><span class="line">		add_client()</span><br><span class="line">	&#125;</span><br><span class="line">	&#x2F;&#x2F; 处理连接</span><br><span class="line">	check_clients()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="基于线程"><a href="#基于线程" class="headerlink" title="基于线程"></a>基于线程</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Open_listenfd()</span><br><span class="line"></span><br><span class="line">while(1) &#123;</span><br><span class="line">	</span><br><span class="line">	Accept()</span><br><span class="line">	</span><br><span class="line">	Pthread_create()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2018/04/30/2018-4-30-web-program/" data-id="ck521h13c004nlc7k6a980cri" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="default-2018-4-21-tomcat" class="article article-type-default" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018/04/21/2018-4-21-tomcat/" class="article-date">
  <time datetime="2018-04-20T16:00:00.000Z" itemprop="datePublished">2018-04-21</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2018/04/21/2018-4-21-tomcat/">tomcat</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="tomcat原理"><a href="#tomcat原理" class="headerlink" title="tomcat原理"></a>tomcat原理</h2><p>Tomcat 的本质其实就是一个 WEB 服务器 + 一个 Servlet 容器，那么它必然需要处理网络的连接与 Servlet 的管理，因此，Tomcat 设计了两个核心组件来实现这两个功能，分别是<strong><em>连接器</em></strong>和<strong><em>容器</em></strong>，连接器用来处理外部网络连接，容器用来处理内部 Servlet。</p>
<p><img src="https://github.com/garydai/garydai.github.com/raw/master/_posts/pic/image-20191116091507766.png" alt="image-20191116091507766"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Connector</span> <span class="keyword">extends</span> <span class="title">LifecycleMBeanBase</span>  </span>&#123;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Coyote protocol handler.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="comment">// 协议的handler</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">final</span> ProtocolHandler protocolHandler;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Coyote adapter.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">protected</span> Adapter adapter = <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>根据protocol=”HTTP/1.1”，生成ProtocolHandler的子类Http11NioProtocol</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;Connector port=<span class="string">"8080"</span> protocol=<span class="string">"HTTP/1.1"</span></span><br><span class="line">               connectionTimeout=<span class="string">"20000"</span></span><br><span class="line">               redirectPort=<span class="string">"8443"</span> /&gt;</span><br><span class="line">               </span><br><span class="line">http/<span class="number">1.1</span> -&gt; protocolHandlerClassName = <span class="string">"org.apache.coyote.http11.Http11NioProtocol"</span>;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Http11NioProtocol</span> <span class="keyword">extends</span> <span class="title">AbstractHttp11JsseProtocol</span>&lt;<span class="title">NioChannel</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Http11NioProtocol</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// nioEndpoint 利用nio和reactor模式实现io操作</span></span><br><span class="line">        <span class="keyword">super</span>(<span class="keyword">new</span> NioEndpoint());</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">    <span class="keyword">protected</span> <span class="class"><span class="keyword">class</span> <span class="title">SocketProcessor</span> <span class="keyword">extends</span> <span class="title">SocketProcessorBase</span>&lt;<span class="title">NioChannel</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">       <span class="function"><span class="keyword">public</span> <span class="title">SocketProcessor</span><span class="params">(SocketWrapperBase&lt;NioChannel&gt; socketWrapper, SocketEvent event)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">super</span>(socketWrapper, event);</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doRun</span><span class="params">()</span> </span>&#123;</span><br><span class="line">          </span><br><span class="line">          getHandler().process(socketWrapper, SocketEvent.OPEN_READ);</span><br><span class="line">    &#125;</span><br><span class="line">     </span><br><span class="line">     <span class="comment">// 处理连接的handler</span></span><br><span class="line">     <span class="keyword">protected</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">ConnectionHandler</span>&lt;<span class="title">S</span>&gt; <span class="keyword">implements</span> <span class="title">AbstractEndpoint</span>.<span class="title">Handler</span>&lt;<span class="title">S</span>&gt; </span>&#123;</span><br><span class="line">     </span><br><span class="line">       	Http11Processor processor = <span class="keyword">new</span> Http11Processor(<span class="keyword">this</span>, adapter);</span><br><span class="line">        processor.process(wrapper, status);</span><br><span class="line">     &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>Endpoint 是用来实现 TCP/IP 协议的，Processor 用来实现 HTTP 协议</p>
<p><img src="https://github.com/garydai/garydai.github.com/raw/master/_posts/pic/image-20191116093302140.png" alt="image-20191116093302140"></p>
<p><img src="https://github.com/garydai/garydai.github.com/raw/master/_posts/pic/image-20191116103029764.png" alt="image-20191116103029764"></p>
<p><img src="https://github.com/garydai/garydai.github.com/raw/master/_posts/pic/tomcat1.png" alt=""></p>
<h2 id="连接池处理任务流程"><a href="#连接池处理任务流程" class="headerlink" title="连接池处理任务流程"></a>连接池处理任务流程</h2><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">org.apache.tomcat.util.net.NioEndpoint.SocketProcessor#doRun-&gt;org.apache.coyote.AbstractProtocol.ConnectionHandler#process-&gt;org.apache.coyote.AbstractProcessorLight#process-&gt;org.apache.coyote.AbstractProcessorLight#process-&gt;org.apache.coyote.http11.Http11Processor#service-&gt;</span><br><span class="line">  </span><br><span class="line">org.apache.catalina.connector.CoyoteAdapter#service（设置request的属于哪个host实例）-&gt;</span><br><span class="line">  </span><br><span class="line">connector.getService().getContainer().getPipeline().getFirst().invoke.invoke-&gt;</span><br><span class="line">org.apache.catalina.core.StandardEngineValve#invoke-&gt;</span><br><span class="line">org.apache.catalina.valves.AbstractAccessLogValve#invoke-&gt;</span><br><span class="line">org.apache.catalina.valves.ErrorReportValve#invoke-&gt;</span><br><span class="line">org.apache.catalina.core.StandardHostValve#invoke-&gt;</span><br><span class="line">org.apache.catalina.authenticator.AuthenticatorBase#invoke-&gt;</span><br><span class="line">org.apache.catalina.core.StandardContextValve#invoke-&gt;</span><br><span class="line">org.apache.catalina.core.StandardWrapperValve#invoke-&gt;</span><br><span class="line">org.apache.catalina.core.StandardWrapper#allocate-&gt;</span><br><span class="line">org.apache.catalina.core.StandardWrapper#loadServlet-&gt;</span><br></pre></td></tr></table></figure>

<p>StandardEngineValve</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">invoke</span><span class="params">(Request request, Response response)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> IOException, ServletException </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Select the Host to be used for this Request</span></span><br><span class="line">  			<span class="comment">// 从requets里知道改请求属于哪个host</span></span><br><span class="line">        Host host = request.getHost();</span><br><span class="line">        <span class="keyword">if</span> (host == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">// HTTP 0.9 or HTTP 1.0 request without a host when no default host</span></span><br><span class="line">            <span class="comment">// is defined. This is handled by the CoyoteAdapter.</span></span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (request.isAsyncSupported()) &#123;</span><br><span class="line">            request.setAsyncSupported(host.getPipeline().isAsyncSupported());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Ask this Host to process this request</span></span><br><span class="line">        host.getPipeline().getFirst().invoke(request, response);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>org.apache.catalina.connector.CoyoteAdapter#postParseRequest</p>
<p>从service的host集合中找到匹配当前hostname的<strong>host实例</strong>并找到<strong>uri与wrapper的映射</strong>，并复制到request的MappingData中</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">connector.getService().getMapper().map(serverName, decodedURI,</span><br><span class="line">                    version, request.getMappingData());</span><br></pre></td></tr></table></figure>



<h4 id="定位servlet"><a href="#定位servlet" class="headerlink" title="定位servlet"></a>定位servlet</h4><p>Mapper 组件里保存了 Web 应用的配置信息，其实就是容器组件与访问路径的映射关系，比如 Host 容器里配置的域名、Context 容器里的 Web 应用路径，以及 Wrapper 容器里 Servlet 映射的路径，你可以想象这些配置信息就是一个多层次的 Map</p>
<p>首先，根据协议和端口号选定 Service 和 Engine。我们知道 Tomcat 的每个连接器都监听不同的端口</p>
<p>然后，根据域名选定 Host。Service 和 Engine 确定后，Mapper 组件通过 URL 中的域名去查找相应的 Host 容器</p>
<p>之后，根据 URL 路径找到 Context 组件。Host 确定以后，Mapper 根据 URL 的路径来匹配相应的 Web 应用的路径</p>
<p>最后，根据 URL 路径找到 Wrapper（Servlet）。Context 确定后，Mapper 再根据web.xml中配置的 Servlet 映射路径来找到具体的 Wrapper 和 Servlet。</p>
<p>Pipeline-Valve 是责任链模式，责任链模式是指在一个请求处理的过程中有很多处理者依次对请求进行处理，每个处理者负责做自己相应的处理，处理完之后将再调用下一个处理者继续处理</p>
<p>Valve 表示一个处理点</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Valve</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> Valve <span class="title">getNext</span><span class="params">()</span></span>;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setNext</span><span class="params">(Valve valve)</span></span>;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">invoke</span><span class="params">(Request request, Response response)</span></span></span><br><span class="line"><span class="function">&#125;</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="keyword">public</span> interface Pipeline extends Contained </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addValve</span><span class="params">(Valve valve)</span></span>;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> Valve <span class="title">getBasic</span><span class="params">()</span></span>;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setBasic</span><span class="params">(Valve valve)</span></span>;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> Valve <span class="title">getFirst</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://github.com/garydai/garydai.github.com/raw/master/_posts/pic/image-20191116110643376.png" alt="image-20191116110643376"></p>
<p>整个调用过程由连接器中的 Adapter 触发的，它会调用 Engine 的第一个 Valve</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">// Calling the container</span></span><br><span class="line">connector.getService().getContainer().getPipeline().getFirst().invoke(request, response);</span><br></pre></td></tr></table></figure>

<h5 id="请求流转过程"><a href="#请求流转过程" class="headerlink" title="请求流转过程"></a>请求流转过程</h5><p><img src="https://github.com/garydai/garydai.github.com/raw/master/_posts/pic/image-20191116113706003.png" alt="image-20191116113706003"></p>
<h4 id="启动流程图"><a href="#启动流程图" class="headerlink" title="启动流程图"></a>启动流程图</h4><p><img src="https://github.com/garydai/garydai.github.com/raw/master/_posts/pic/image-20191116145926938.png" alt="image-20191116145926938"></p>
<p><img src="https://github.com/garydai/garydai.github.com/raw/master/_posts/pic/image-20191128162252013.png" alt="image-20191128162252013"></p>
<p>Acceptor</p>
<p>Selector</p>
<p>Processor</p>
<p><img src="https://github.com/garydai/garydai.github.com/raw/master/_posts/pic/image-20191117103831162.png" alt="image-20191117103831162"></p>
<p>ServerSocketChannel 通过 accept() 接受新的连接，accept() 方法返回获得 SocketChannel 对象，然后将 SocketChannel 对象封装在一个 PollerEvent 对象中，并将 PollerEvent 对象压入 Poller 的 Queue 里，这是个典型的“生产者 - 消费者”模式，Acceptor 与 Poller 线程之间通过 Queue 通信。</p>
<h5 id="Poller"><a href="#Poller" class="headerlink" title="Poller"></a>Poller</h5><p>Poller 本质是一个 Selector，它内部维护一个 Queue，这个 Queue 定义如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">private final SynchronizedQueue&lt;PollerEvent&gt; events &#x3D; new SynchronizedQueue&lt;&gt;();</span><br></pre></td></tr></table></figure>

<p>将这些事件注册到select里，进行nio</p>
<h4 id="endpoint"><a href="#endpoint" class="headerlink" title="endpoint"></a>endpoint</h4><p>Socket acceptor thread<br>Socket poller thread<br>Worker threads pool</p>
<p>Endpoint 组件的主要工作就是处理 I/O，而 NioEndpoint 利用 Java NIO API 实现了多路复用 I/O 模型</p>
<p>tomcat处理请求用的线程池使用无界队列，但重写队列，使得达到核心线程数，也能可以新增线程，主要利用记录当然任务数大于当前线程，就能新建线程</p>
<p>当没有空闲线程，则新建线程，不会添加到队列。（加队列的条件，线程池大小达到最大容量，或有空闲线程）</p>
<p>jdk线程池，没有空闲线程概念，（加队列的条件，线程池大小达到最大容量）</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TaskQueue</span> <span class="keyword">extends</span> <span class="title">LinkedBlockingQueue</span>&lt;<span class="title">Runnable</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">  ...</span><br><span class="line">   <span class="meta">@Override</span></span><br><span class="line">  <span class="comment">//线程池调用任务队列的方法时，当前线程数肯定已经大于核心线程数了</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">offer</span><span class="params">(Runnable o)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">      <span class="comment">//如果线程数已经到了最大值，不能创建新线程了，只能把任务添加到任务队列。</span></span><br><span class="line">      <span class="keyword">if</span> (parent.getPoolSize() == parent.getMaximumPoolSize()) </span><br><span class="line">          <span class="keyword">return</span> <span class="keyword">super</span>.offer(o);</span><br><span class="line">          </span><br><span class="line">      <span class="comment">//执行到这里，表明当前线程数大于核心线程数，并且小于最大线程数。</span></span><br><span class="line">      <span class="comment">//表明是可以创建新线程的，那到底要不要创建呢？分两种情况：</span></span><br><span class="line">      </span><br><span class="line">      <span class="comment">//1. 如果已提交的任务数小于当前线程数，表示还有空闲线程，无需创建新线程</span></span><br><span class="line">      <span class="keyword">if</span> (parent.getSubmittedCount()&lt;=(parent.getPoolSize())) </span><br><span class="line">          <span class="keyword">return</span> <span class="keyword">super</span>.offer(o);</span><br><span class="line">          </span><br><span class="line">      <span class="comment">//2. 如果已提交的任务数大于当前线程数，线程不够用了，返回false去创建新线程</span></span><br><span class="line">      <span class="keyword">if</span> (parent.getPoolSize()&lt;parent.getMaximumPoolSize()) </span><br><span class="line">          <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">          </span><br><span class="line">      <span class="comment">//默认情况下总是把任务添加到任务队列</span></span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">super</span>.offer(o);</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h5 id="对象池"><a href="#对象池" class="headerlink" title="对象池"></a>对象池</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SynchronizedStack</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//内部维护一个对象数组,用数组实现栈的功能</span></span><br><span class="line">    <span class="keyword">private</span> Object[] stack;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//这个方法用来归还对象，用synchronized进行线程同步</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">boolean</span> <span class="title">push</span><span class="params">(T obj)</span> </span>&#123;</span><br><span class="line">        index++;</span><br><span class="line">        <span class="keyword">if</span> (index == size) &#123;</span><br><span class="line">            <span class="keyword">if</span> (limit == -<span class="number">1</span> || size &lt; limit) &#123;</span><br><span class="line">                expand();<span class="comment">//对象不够用了，扩展对象数组</span></span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                index--;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        stack[index] = obj;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//这个方法用来获取对象</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> T <span class="title">pop</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (index == -<span class="number">1</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        T result = (T) stack[index];</span><br><span class="line">        stack[index--] = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//扩展对象数组长度，以2倍大小扩展</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">expand</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      <span class="keyword">int</span> newSize = size * <span class="number">2</span>;</span><br><span class="line">      <span class="keyword">if</span> (limit != -<span class="number">1</span> &amp;&amp; newSize &gt; limit) &#123;</span><br><span class="line">          newSize = limit;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">//扩展策略是创建一个数组长度为原来两倍的新数组</span></span><br><span class="line">      Object[] newStack = <span class="keyword">new</span> Object[newSize];</span><br><span class="line">      <span class="comment">//将老数组对象引用复制到新数组</span></span><br><span class="line">      System.arraycopy(stack, <span class="number">0</span>, newStack, <span class="number">0</span>, size);</span><br><span class="line">      <span class="comment">//将stack指向新数组，老数组可以被GC掉了</span></span><br><span class="line">      stack = newStack;</span><br><span class="line">      size = newSize;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="双亲委派"><a href="#双亲委派" class="headerlink" title="双亲委派"></a>双亲委派</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">ClassLoader</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//每个类加载器都有个父加载器</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ClassLoader parent;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> Class&lt;?&gt; loadClass(String name) &#123;</span><br><span class="line">  </span><br><span class="line">        <span class="comment">//查找一下这个类是不是已经加载过了</span></span><br><span class="line">        Class&lt;?&gt; c = findLoadedClass(name);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//如果没有加载过</span></span><br><span class="line">        <span class="keyword">if</span>( c == <span class="keyword">null</span> )&#123;</span><br><span class="line">          <span class="comment">//先委托给父加载器去加载，注意这是个递归调用</span></span><br><span class="line">          <span class="keyword">if</span> (parent != <span class="keyword">null</span>) &#123;</span><br><span class="line">              c = parent.loadClass(name);</span><br><span class="line">          &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">              <span class="comment">// 如果父加载器为空，查找Bootstrap加载器是不是加载过了</span></span><br><span class="line">              c = findBootstrapClassOrNull(name);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 如果父加载器没加载成功，调用自己的findClass去加载</span></span><br><span class="line">        <span class="keyword">if</span> (c == <span class="keyword">null</span>) &#123;</span><br><span class="line">            c = findClass(name);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> c；</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">protected</span> Class&lt;?&gt; findClass(String name)&#123;</span><br><span class="line">       <span class="comment">//1. 根据传入的类名name，到在特定目录下去寻找类文件，把.class文件读入内存</span></span><br><span class="line">          ...</span><br><span class="line">          </span><br><span class="line">       <span class="comment">//2. 调用defineClass将字节数组转成Class对象</span></span><br><span class="line">       <span class="keyword">return</span> defineClass(buf, off, len)；</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 将字节码数组解析成一个Class对象，用native方法实现</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">final</span> Class&lt;?&gt; defineClass(<span class="keyword">byte</span>[] b, <span class="keyword">int</span> off, <span class="keyword">int</span> len)&#123;</span><br><span class="line">       ...</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Tomcat 的自定义类加载器 <strong>WebAppClassLoader的WebappClassLoaderBase属性</strong> 打破了双亲委托机制，它首先自己尝试去加载某个类，如果找不到再代理给父类加载器，其目的是优先加载 Web 应用自己定义的类。具体实现就是重写 ClassLoader 的两个方法：findClass 和 loadClass。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">public</span> Class&lt;?&gt; findClass(String name) <span class="keyword">throws</span> ClassNotFoundException &#123;</span><br><span class="line">    ...</span><br><span class="line">    </span><br><span class="line">    Class&lt;?&gt; clazz = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//1. 先在Web应用目录下查找类 </span></span><br><span class="line">            clazz = findClassInternal(name);</span><br><span class="line">    &#125;  <span class="keyword">catch</span> (RuntimeException e) &#123;</span><br><span class="line">           <span class="keyword">throw</span> e;</span><br><span class="line">       &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (clazz == <span class="keyword">null</span>) &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//2. 如果在本地目录没有找到，交给父加载器去查找</span></span><br><span class="line">            clazz = <span class="keyword">super</span>.findClass(name);</span><br><span class="line">    &#125;  <span class="keyword">catch</span> (RuntimeException e) &#123;</span><br><span class="line">           <span class="keyword">throw</span> e;</span><br><span class="line">       &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//3. 如果父类也没找到，抛出ClassNotFoundException</span></span><br><span class="line">    <span class="keyword">if</span> (clazz == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> ClassNotFoundException(name);</span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> clazz;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>先在 Web 应用本地目录下查找要加载的类。如果没有找到，交给父加载器去查找，它的父加载器就是上面提到的系统类加载器 AppClassLoader。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">public</span> Class&lt;?&gt; loadClass(String name, <span class="keyword">boolean</span> resolve) <span class="keyword">throws</span> ClassNotFoundException &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">synchronized</span> (getClassLoadingLock(name)) &#123;</span><br><span class="line"> </span><br><span class="line">        Class&lt;?&gt; clazz = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//1. 先在本地cache查找该类是否已经加载过</span></span><br><span class="line">        clazz = findLoadedClass0(name);</span><br><span class="line">        <span class="keyword">if</span> (clazz != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (resolve)</span><br><span class="line">                resolveClass(clazz);</span><br><span class="line">            <span class="keyword">return</span> clazz;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//2. 从系统类加载器的cache中查找是否加载过</span></span><br><span class="line">        clazz = findLoadedClass(name);</span><br><span class="line">        <span class="keyword">if</span> (clazz != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (resolve)</span><br><span class="line">                resolveClass(clazz);</span><br><span class="line">            <span class="keyword">return</span> clazz;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3. 尝试用ExtClassLoader类加载器类加载</span></span><br><span class="line">        ClassLoader javaseLoader = getJavaseClassLoader();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            clazz = javaseLoader.loadClass(name);</span><br><span class="line">            <span class="keyword">if</span> (clazz != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (resolve)</span><br><span class="line">                    resolveClass(clazz);</span><br><span class="line">                <span class="keyword">return</span> clazz;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</span><br><span class="line">            <span class="comment">// Ignore</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 4. 尝试在本地目录搜索class并加载</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            clazz = findClass(name);</span><br><span class="line">            <span class="keyword">if</span> (clazz != <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (resolve)</span><br><span class="line">                    resolveClass(clazz);</span><br><span class="line">                <span class="keyword">return</span> clazz;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</span><br><span class="line">            <span class="comment">// Ignore</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 5. 尝试用系统类加载器(也就是AppClassLoader)来加载</span></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                clazz = Class.forName(name, <span class="keyword">false</span>, parent);</span><br><span class="line">                <span class="keyword">if</span> (clazz != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (resolve)</span><br><span class="line">                        resolveClass(clazz);</span><br><span class="line">                    <span class="keyword">return</span> clazz;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</span><br><span class="line">                <span class="comment">// Ignore</span></span><br><span class="line">            &#125;</span><br><span class="line">       &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//6. 上述过程都加载失败，抛出异常</span></span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> ClassNotFoundException(name);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>先在本地目录下加载，为了避免本地目录下的类覆盖 JRE 的核心类，先尝试用 JVM 扩展类加载器 ExtClassLoader 去加载</p>
<p>在stardardContext的startinternal中</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">if</span> (getLoader() == <span class="keyword">null</span>) &#123;</span><br><span class="line">  WebappLoader webappLoader = <span class="keyword">new</span> WebappLoader(getParentClassLoader());</span><br><span class="line">  webappLoader.setDelegate(getDelegate());</span><br><span class="line">  setLoader(webappLoader);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在org.apache.catalina.startup.HostConfig#start-&gt;org.apache.catalina.startup.HostConfig#deployDirectory部署webapps下所有文件夹，一个文件夹一个standardContext，并加入standardHost，每个standardContext都会新建WebApploader，达到隔离app的目的</p>
<h6 id="加载顺序"><a href="#加载顺序" class="headerlink" title="加载顺序"></a>加载顺序</h6><p>ExtClassLoader - 本地目录下加载 - 父加载器加载（sharedclassloader）</p>
<p><img src="https://github.com/garydai/garydai.github.com/raw/master/_posts/pic/image-20191118165432478.png" alt="image-20191118165432478"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">CommonClassLoader对应&lt;Tomcat&gt;/common<span class="comment">/*</span></span><br><span class="line"><span class="comment">CatalinaClassLoader对应 &lt;Tomcat &gt;/server/*</span></span><br><span class="line"><span class="comment">SharedClassLoader对应 &lt;Tomcat &gt;/shared/*</span></span><br><span class="line"><span class="comment">WebAppClassloader对应 &lt;Tomcat &gt;/webapps/&lt;app&gt;/WEB-INF/*目录</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">catalina.properties</span></span><br><span class="line"><span class="comment">common.loader="$&#123;catalina.base&#125;/lib","$&#123;catalina.base&#125;/lib/*.jar","$&#123;catalina.home&#125;/lib","$&#123;catalina.home&#125;/lib/*.jar"</span></span><br><span class="line"><span class="comment">server.loader=</span></span><br><span class="line"><span class="comment">shared.loader=</span></span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">initClassLoaders</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">          	<span class="comment">// parent为null，默认设置 getSystemClassLoader()方法返回的ClassLoader 作为其父类，getSystemClassLoader()返回的 ClassLoader 通常就是 AppClassLoader</span></span><br><span class="line">            commonLoader = createClassLoader(<span class="string">"common"</span>, <span class="keyword">null</span>);</span><br><span class="line">            <span class="keyword">if</span> (commonLoader == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="comment">// no config file, default to this loader - we might be in a 'single' env.</span></span><br><span class="line">                commonLoader = <span class="keyword">this</span>.getClass().getClassLoader();</span><br><span class="line">            &#125;</span><br><span class="line">            catalinaLoader = createClassLoader(<span class="string">"server"</span>, commonLoader);</span><br><span class="line">            sharedLoader = createClassLoader(<span class="string">"shared"</span>, commonLoader);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">            handleThrowable(t);</span><br><span class="line">            log.error(<span class="string">"Class loader creation threw exception"</span>, t);</span><br><span class="line">            System.exit(<span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>



<p>Common类加载器，负责加载Tomcat和Web应用都复用的类</p>
<p>Catalina类加载器，负责加载Tomcat专用的类，而这些被加载的类在Web应用中将不可见</p>
<p>Shared类加载器，负责加载Tomcat下所有的Web应用程序都复用的类，而这些被加载的类在Tomcat中将不可见</p>
<p>WebApp类加载器，负责加载具体的某个Web应用程序所使用到的类，而这些被加载的类在Tomcat和其他的Web应用程序都将不可见</p>
<p>Jsp类加载器，每个jsp页面一个类加载器，不同的jsp页面有不同的类加载器，方便实现jsp页面的热插拔</p>
<h4 id="servlet"><a href="#servlet" class="headerlink" title="servlet"></a>servlet</h4><p>Wrap组件封装了servlet</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">public synchronized Servlet loadServlet() throws ServletException &#123;</span><br><span class="line">    Servlet servlet;</span><br><span class="line">  </span><br><span class="line">    &#x2F;&#x2F;1. 创建一个Servlet实例</span><br><span class="line">    servlet &#x3D; (Servlet) instanceManager.newInstance(servletClass);    </span><br><span class="line">    </span><br><span class="line">    &#x2F;&#x2F;2.调用了Servlet的init方法，这是Servlet规范要求的</span><br><span class="line">    initServlet(servlet);</span><br><span class="line">    </span><br><span class="line">    return servlet;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>当请求到来时，Context 容器的 BasicValve 会调用 Wrapper 容器中 Pipeline 中的第一个 Valve，然后会调用到 StandardWrapperValve</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">invoke</span><span class="params">(Request request, Response response)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//1.实例化Servlet</span></span><br><span class="line">    servlet = wrapper.allocate();</span><br><span class="line">   </span><br><span class="line">    <span class="comment">//2.给当前请求创建一个Filter链</span></span><br><span class="line">    ApplicationFilterChain filterChain =</span><br><span class="line">        ApplicationFilterFactory.createFilterChain(request, wrapper, servlet);</span><br><span class="line"></span><br><span class="line">   <span class="comment">//3. 调用这个Filter链，Filter链中的最后一个Filter会调用Servlet</span></span><br><span class="line">   filterChain.doFilter(request.getRequest(), response.getResponse());</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>连接器是调用 CoyoteAdapter 的 service 方法来处理请求的，而 CoyoteAdapter 会调用容器的 service 方法</p>
<p>当容器的 service 方法返回时，CoyoteAdapter 判断当前的请求是不是异步 Servlet 请求，如果是，就不会销毁 Request 和 Response 对象，也不会把响应信息发到浏览器</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">service</span><span class="params">(org.apache.coyote.Request req, org.apache.coyote.Response res)</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">   <span class="comment">//调用容器的service方法处理请求</span></span><br><span class="line">    connector.getService().getContainer().getPipeline().</span><br><span class="line">           getFirst().invoke(request, response);</span><br><span class="line">   </span><br><span class="line">   <span class="comment">//如果是异步Servlet请求，仅仅设置一个标志，</span></span><br><span class="line">   <span class="comment">//否则说明是同步Servlet请求，就将响应数据刷到浏览器</span></span><br><span class="line">    <span class="keyword">if</span> (request.isAsync()) &#123;</span><br><span class="line">        async = <span class="keyword">true</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        request.finishRequest();</span><br><span class="line">        response.finishResponse();</span><br><span class="line">    &#125;</span><br><span class="line">   </span><br><span class="line">   <span class="comment">//如果不是异步Servlet请求，就销毁Request对象和Response对象</span></span><br><span class="line">    <span class="keyword">if</span> (!async) &#123;</span><br><span class="line">        request.recycle();</span><br><span class="line">        response.recycle();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="logger"><a href="#logger" class="headerlink" title="logger"></a>logger</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="title">LogFactory</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 通过ServiceLoader尝试加载Log的实现类</span></span><br><span class="line">    ServiceLoader&lt;Log&gt; logLoader = ServiceLoader.load(Log<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">    Constructor&lt;? extends Log&gt; m=<span class="keyword">null</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> (Log log: logLoader) &#123;</span><br><span class="line">        Class&lt;? extends Log&gt; c=log.getClass();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            m=c.getConstructor(String<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span> (NoSuchMethodException | SecurityException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> Error(e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//如何没有定义Log的实现类，discoveredLogConstructor为null</span></span><br><span class="line">    discoveredLogConstructor = m;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> Log <span class="title">getInstance</span><span class="params">(String name)</span> <span class="keyword">throws</span> LogConfigurationException </span>&#123;</span><br><span class="line">    <span class="comment">//如果discoveredLogConstructor为null，也就没有定义Log类，默认用DirectJDKLog（封装了jul）</span></span><br><span class="line">    <span class="keyword">if</span> (discoveredLogConstructor == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> DirectJDKLog.getInstance(name);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> discoveredLogConstructor.newInstance(name);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (ReflectiveOperationException | IllegalArgumentException e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> LogConfigurationException(e);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="线程池大小选择"><a href="#线程池大小选择" class="headerlink" title="线程池大小选择"></a>线程池大小选择</h5><p>利特尔法则：系统中的请求数 = 请求的到达速率 × 每个请求处理时间</p>
<p>线程池大小 = 每秒请求数 × 平均请求处理时间</p>
<p>线程池大小 = （线程 I/O 阻塞时间 + 线程 CPU 时间 ）/ 线程 CPU 时间</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">offer</span><span class="params">(Runnable o)</span> </span>&#123;</span><br><span class="line">  <span class="comment">//we can't do any checks</span></span><br><span class="line">    <span class="keyword">if</span> (parent==<span class="keyword">null</span>) <span class="keyword">return</span> <span class="keyword">super</span>.offer(o);</span><br><span class="line">    <span class="comment">//we are maxed out on threads, simply queue the object</span></span><br><span class="line">    <span class="keyword">if</span> (parent.getPoolSize() == parent.getMaximumPoolSize()) <span class="keyword">return</span> <span class="keyword">super</span>.offer(o);</span><br><span class="line">    <span class="comment">//we have idle threads, just add it to the queue</span></span><br><span class="line">    <span class="keyword">if</span> (parent.getSubmittedCount()&lt;=(parent.getPoolSize())) <span class="keyword">return</span> <span class="keyword">super</span>.offer(o);</span><br><span class="line">    <span class="comment">//if we have less threads than maximum force creation of a new thread</span></span><br><span class="line">    <span class="keyword">if</span> (parent.getPoolSize()&lt;parent.getMaximumPoolSize()) <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    <span class="comment">//if we reached here, we need to add it to the queue</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">super</span>.offer(o);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>tomcat工作线程池，如果线程池大小小于最大线程池大小，则不会添加到队列（LinkedBlockingQueue）（和默认的线程池处理不一样，默认的是如果线程池大小等于核心线程池大小的时候，先插入队列，队列满了才添加线程）</p>
<p>如果有空闲线程（parent.getSubmittedCount()&lt;=(parent.getPoolSize())），插入队列，</p>
<p>如果没空闲添加线程</p>
<h4 id="hostconfig"><a href="#hostconfig" class="headerlink" title="hostconfig"></a>hostconfig</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HostConfig</span> <span class="keyword">implements</span> <span class="title">LifecycleListener</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">		<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">lifecycleEvent</span><span class="params">(LifecycleEvent event)</span> </span>&#123;</span><br><span class="line">			<span class="keyword">if</span> (event.getType().equals(Lifecycle.START_EVENT)) &#123;</span><br><span class="line">            start();</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">		<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> </span>&#123;		</span><br><span class="line">		  <span class="keyword">if</span> (host.getDeployOnStartup())</span><br><span class="line">            deployApps();</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>standardhost通过事件通知hostconfig加载webapps</p>
<h4 id="contexConfig"><a href="#contexConfig" class="headerlink" title="contexConfig"></a>contexConfig</h4><p>加载解析/WEB-INF/web.xml</p>
<h4 id="pipeline"><a href="#pipeline" class="headerlink" title="pipeline"></a>pipeline</h4><p>engine，host，context，wrapper；<br>四个容器中每个容器都包含自己的管道对象，管道对象用来存放若干阀门对象，但tomcat会为他们制定一个默认的基础阀门【StandardEngineValve,StandardHostValve,StandardContextValve ,StandardWrapperValve】。四个基础阀门放在各自容器管道的最后一位，用于查找下一级容器的管道.</p>
<h6 id="分类"><a href="#分类" class="headerlink" title="分类"></a>分类</h6><p>一个pipeline包含多个Valve，这些阀共分为两类，一类叫基础阀（通过getBasic、setBasic方法调用），一类是普通阀（通过addValve、removeValve调用）。<br>一个管道一般有一个基础阀（通过setBasic添加），可以有0到多个普通阀（通过addValve添加）。</p>
<p><img src="https://github.com/garydai/garydai.github.com/raw/master/_posts/pic/image-20191126095336752.png" alt="image-20191126095336752"></p>
<p>自定的valve类文件需要发布到CATALINA_HOME/lib目录下而不是应用的发布目录WEB-INF/classes</p>
<h4 id="mapper"><a href="#mapper" class="headerlink" title="mapper"></a>mapper</h4><p>初始化阶段standardContext已经保存所有StandardWrapper信息（path和servlet等信息，servlet默认还未实例化）</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="keyword">volatile</span> Servlet instance = <span class="keyword">null</span>;</span><br></pre></td></tr></table></figure>



<p>启动阶段，start service时mapper监听器启动，mapperListener.start();遍历所有Wrapper把path和对应Wrapper信息放入<strong>StandardService的Mapper</strong>中<strong>hostname-&gt;contextList</strong>(WebResourceRoot，context的描述)</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addContextVersion</span><span class="params">(String hostName, Host host, String path,</span></span></span><br><span class="line"><span class="function"><span class="params">            String version, Context context, String[] welcomeResources,</span></span></span><br><span class="line"><span class="function"><span class="params">            WebResourceRoot resources, Collection&lt;WrapperMappingInfo&gt; wrappers)</span> </span>&#123;&#125;</span><br></pre></td></tr></table></figure>



<p>在mapperLister中注册host，registerHost(host)-&gt;registerContext-&gt;org.apache.catalina.mapper.MapperListener#prepareWrapperMappingInfo</p>
<p>保存path和对应wrapper在WrapperMappingInfo中</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">registerHost</span><span class="params">(Host host)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        String[] aliases = host.findAliases();</span><br><span class="line">        mapper.addHost(host.getName(), aliases, host);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (Container container : host.findChildren()) &#123;</span><br><span class="line">            <span class="keyword">if</span> (container.getState().isAvailable()) &#123;</span><br><span class="line">                registerContext((Context) container);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Default host may have changed</span></span><br><span class="line">        findDefaultHost();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(log.isDebugEnabled()) &#123;</span><br><span class="line">            log.debug(sm.getString(<span class="string">"mapperListener.registerHost"</span>,</span><br><span class="line">                    host.getName(), domain, service));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"> <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">prepareWrapperMappingInfo</span><span class="params">(Context context, Wrapper wrapper,</span></span></span><br><span class="line"><span class="function"><span class="params">            List&lt;WrapperMappingInfo&gt; wrappers)</span> </span>&#123;</span><br><span class="line">        String wrapperName = wrapper.getName();</span><br><span class="line">        <span class="keyword">boolean</span> resourceOnly = context.isResourceOnlyServlet(wrapperName);</span><br><span class="line">        String[] mappings = wrapper.findMappings();</span><br><span class="line">        <span class="keyword">for</span> (String mapping : mappings) &#123;</span><br><span class="line">            <span class="keyword">boolean</span> jspWildCard = (wrapperName.equals(<span class="string">"jsp"</span>)</span><br><span class="line">                                   &amp;&amp; mapping.endsWith(<span class="string">"/*"</span>));</span><br><span class="line">            wrappers.add(<span class="keyword">new</span> WrapperMappingInfo(mapping, wrapper, jspWildCard,</span><br><span class="line">                    resourceOnly));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WrapperMappingInfo</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String mapping;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Wrapper wrapper;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">boolean</span> jspWildCard;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">boolean</span> resourceOnly;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">WrapperMappingInfo</span><span class="params">(String mapping, Wrapper wrapper,</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">boolean</span> jspWildCard, <span class="keyword">boolean</span> resourceOnly)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.mapping = mapping;</span><br><span class="line">        <span class="keyword">this</span>.wrapper = wrapper;</span><br><span class="line">        <span class="keyword">this</span>.jspWildCard = jspWildCard;</span><br><span class="line">        <span class="keyword">this</span>.resourceOnly = resourceOnly;</span><br><span class="line">      </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="请求处理"><a href="#请求处理" class="headerlink" title="请求处理"></a>请求处理</h4><p>org.apache.coyote.AbstractProcessorLight#process-&gt;org.apache.coyote.http11.Http11Processor#service-&gt;org.apache.catalina.connector.CoyoteAdapter#service-&gt;engine.getPipeline().getFirst().invoke</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">connector.getService().getContainer().getPipeline().getFirst().invoke(</span><br><span class="line">                       request, response);</span><br></pre></td></tr></table></figure>



<p>org.apache.catalina.core.StandardEngineValve#invoke-&gt;org.apache.catalina.valves.AbstractAccessLogValve#invoke-&gt;org.apache.catalina.valves.ErrorReportValve#invoke-&gt;org.apache.catalina.core.StandardHostValve#invoke-&gt;org.apache.catalina.authenticator.AuthenticatorBase#invoke-&gt;org.apache.catalina.core.StandardContextValve#invoke-&gt;org.apache.catalina.core.StandardWrapperValve#invoke-&gt;org.apache.catalina.core.StandardWrapper#allocate-&gt;org.apache.catalina.core.StandardWrapper#loadServlet</p>
<h6 id="路径映射"><a href="#路径映射" class="headerlink" title="路径映射"></a>路径映射</h6><p>org.apache.catalina.connector.CoyoteAdapter#service-&gt;org.apache.catalina.connector.CoyoteAdapter#postParseRequest处理host+uri到wrapper的映射</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">connector.getService().getMapper().map(serverName, decodedURI,</span><br><span class="line">                   version, request.getMappingData());</span><br></pre></td></tr></table></figure>



<h5 id="response"><a href="#response" class="headerlink" title="response"></a>response</h5><p>请求响应时在另一个block-poller线程执行</p>
<p>NioEndpoint对象中维护了一个NioSelecPool对象，这个NioSelectorPool中又维护了一个BlockPoller线程，这个线程就是基于辅Selector进行NIO的逻辑。以执行servlet后，得到response，往socket中写数据为例，最终写的过程调用NioBlockingSelector的write方法</p>
<p>先使用socket的原selector，检测可写事件，如果遇到网络问题，写失败，再丢到上面的BlockPoller线程，使用新的selector写数据</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">write</span><span class="params">(ByteBuffer buf, NioChannel socket, <span class="keyword">long</span> writeTimeout,MutableInteger lastWrite)</span> <span class="keyword">throws</span> IOException </span>&#123;  </span><br><span class="line">        SelectionKey key = socket.getIOChannel().keyFor(socket.getPoller().getSelector());  </span><br><span class="line">        <span class="keyword">if</span> ( key == <span class="keyword">null</span> ) <span class="keyword">throw</span> <span class="keyword">new</span> IOException(<span class="string">"Key no longer registered"</span>);  </span><br><span class="line">        KeyAttachment att = (KeyAttachment) key.attachment();  </span><br><span class="line">        <span class="keyword">int</span> written = <span class="number">0</span>;  </span><br><span class="line">        <span class="keyword">boolean</span> timedout = <span class="keyword">false</span>;  </span><br><span class="line">        <span class="keyword">int</span> keycount = <span class="number">1</span>; <span class="comment">//assume we can write  </span></span><br><span class="line">        <span class="keyword">long</span> time = System.currentTimeMillis(); <span class="comment">//start the timeout timer  </span></span><br><span class="line">        <span class="keyword">try</span> &#123;  </span><br><span class="line">            <span class="keyword">while</span> ( (!timedout) &amp;&amp; buf.hasRemaining()) &#123;  </span><br><span class="line">                <span class="keyword">if</span> (keycount &gt; <span class="number">0</span>) &#123; <span class="comment">//only write if we were registered for a write  </span></span><br><span class="line">                    <span class="comment">//直接往socket中写数据  </span></span><br><span class="line">                    <span class="keyword">int</span> cnt = socket.write(buf); <span class="comment">//write the data  </span></span><br><span class="line">                    lastWrite.set(cnt);  </span><br><span class="line">                    <span class="keyword">if</span> (cnt == -<span class="number">1</span>)  </span><br><span class="line">                        <span class="keyword">throw</span> <span class="keyword">new</span> EOFException();  </span><br><span class="line">                    written += cnt;  </span><br><span class="line">                    <span class="comment">//写数据成功，直接进入下一次循环，继续写  </span></span><br><span class="line">                    <span class="keyword">if</span> (cnt &gt; <span class="number">0</span>) &#123;  </span><br><span class="line">                        time = System.currentTimeMillis(); <span class="comment">//reset our timeout timer  </span></span><br><span class="line">                        <span class="keyword">continue</span>; <span class="comment">//we successfully wrote, try again without a selector  </span></span><br><span class="line">                    &#125;  </span><br><span class="line">                &#125;  </span><br><span class="line">                <span class="comment">//如果写数据返回值cnt等于0，通常是网络不稳定造成的写数据失败  </span></span><br><span class="line">                <span class="keyword">try</span> &#123;  </span><br><span class="line">                    <span class="comment">//开始一个倒数计数器   </span></span><br><span class="line">                    <span class="keyword">if</span> ( att.getWriteLatch()==<span class="keyword">null</span> || att.getWriteLatch().getCount()==<span class="number">0</span>) att.startWriteLatch(<span class="number">1</span>);  </span><br><span class="line">                    <span class="comment">//将socket注册到辅Selector，这里poller就是BlockSelector线程  </span></span><br><span class="line">                    poller.add(att,SelectionKey.OP_WRITE);  </span><br><span class="line">                    <span class="comment">//阻塞，直至超时时间唤醒，或者在还没有达到超时时间，在BlockSelector中唤醒  </span></span><br><span class="line">                    att.awaitWriteLatch(writeTimeout,TimeUnit.MILLISECONDS);  </span><br><span class="line">                &#125;<span class="keyword">catch</span> (InterruptedException ignore) &#123;  </span><br><span class="line">                    Thread.interrupted();  </span><br><span class="line">                &#125;  </span><br><span class="line">                <span class="keyword">if</span> ( att.getWriteLatch()!=<span class="keyword">null</span> &amp;&amp; att.getWriteLatch().getCount()&gt; <span class="number">0</span>) &#123;  </span><br><span class="line">                    keycount = <span class="number">0</span>;  </span><br><span class="line">                &#125;<span class="keyword">else</span> &#123;  </span><br><span class="line">                    <span class="comment">//还没超时就唤醒，说明网络状态恢复，继续下一次循环，完成写socket  </span></span><br><span class="line">                    keycount = <span class="number">1</span>;  </span><br><span class="line">                    att.resetWriteLatch();  </span><br><span class="line">                &#125;  </span><br><span class="line">  </span><br><span class="line">                <span class="keyword">if</span> (writeTimeout &gt; <span class="number">0</span> &amp;&amp; (keycount == <span class="number">0</span>))  </span><br><span class="line">                    timedout = (System.currentTimeMillis() - time) &gt;= writeTimeout;  </span><br><span class="line">            &#125; <span class="comment">//while  </span></span><br><span class="line">            <span class="keyword">if</span> (timedout)   </span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> SocketTimeoutException();  </span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;  </span><br><span class="line">            poller.remove(att,SelectionKey.OP_WRITE);  </span><br><span class="line">            <span class="keyword">if</span> (timedout &amp;&amp; key != <span class="keyword">null</span>) &#123;  </span><br><span class="line">                poller.cancelKey(socket, key);  </span><br><span class="line">            &#125;  </span><br><span class="line">        &#125;  </span><br><span class="line">        <span class="keyword">return</span> written;  </span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h4 id="协议解析"><a href="#协议解析" class="headerlink" title="协议解析"></a>协议解析</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (!inputBuffer.parseHeaders()) &#123;</span><br><span class="line">  <span class="comment">// We've read part of the request, don't recycle it</span></span><br><span class="line">  <span class="comment">// instead associate it with the socket</span></span><br><span class="line">  openSocket = <span class="keyword">true</span>;</span><br><span class="line">  readComplete = <span class="keyword">false</span>;</span><br><span class="line">  <span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"> <span class="keyword">if</span> (openSocket) &#123;</span><br><span class="line">   <span class="keyword">if</span> (readComplete) &#123;</span><br><span class="line">     <span class="keyword">return</span> SocketState.OPEN;</span><br><span class="line">   &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">     <span class="keyword">return</span> SocketState.LONG;</span><br><span class="line">   &#125;</span><br><span class="line"> &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">   <span class="keyword">return</span> SocketState.CLOSED;</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"> <span class="keyword">if</span> (state == SocketState.OPEN) &#123;</span><br><span class="line">   <span class="comment">// In keep-alive but between requests. OK to recycle</span></span><br><span class="line">   <span class="comment">// processor. Continue to poll for the next request.</span></span><br><span class="line">   connections.remove(socket);</span><br><span class="line">   release(processor);</span><br><span class="line">   wrapper.registerReadInterest();</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<p>数据不完整，等待下个读事件</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">endRequest</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (swallowInput &amp;&amp; (lastActiveFilter != -<span class="number">1</span>)) &#123;</span><br><span class="line">    <span class="keyword">int</span> extraBytes = (<span class="keyword">int</span>) activeFilters[lastActiveFilter].end();</span><br><span class="line">    byteBuffer.position(byteBuffer.position() - extraBytes);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>没被消费的body，被吞掉，byteBuffer的位置往前移动，继续等待下次读事件触发</p>
<p>一个 Tomcat 代表一个 Server 服务器，一个 Server 服务器可以包含多个 Service 服务，Tomcat 默认的 Service 服务是 Catalina，而一个 Service 服务可以包含多个连接器，因为 Tomcat 支持多种网络协议，包括 HTTP/1.1、HTTP/2、AJP 等等，一个 Service 服务还会包括一个容器，容器外部会有一层 Engine 引擎所包裹，负责与处理连接器的请求与响应，连接器与容器之间通过 ServletRequest 和 ServletResponse 对象进行交流。</p>
<p>也可以从 server.xml 的配置结构可以看出 tomcat 整体的内部结构：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">&lt;Server port&#x3D;&quot;8005&quot; shutdown&#x3D;&quot;SHUTDOWN&quot;&gt;</span><br><span class="line"></span><br><span class="line">  &lt;Service name&#x3D;&quot;Catalina&quot;&gt;</span><br><span class="line"></span><br><span class="line">    &lt;Connector connectionTimeout&#x3D;&quot;20000&quot; port&#x3D;&quot;8080&quot; protocol&#x3D;&quot;HTTP&#x2F;1.1&quot; redirectPort&#x3D;&quot;8443&quot; URIEncoding&#x3D;&quot;UTF-8&quot;&#x2F;&gt;</span><br><span class="line"></span><br><span class="line">    &lt;Connector port&#x3D;&quot;8009&quot; protocol&#x3D;&quot;AJP&#x2F;1.3&quot; redirectPort&#x3D;&quot;8443&quot;&#x2F;&gt;</span><br><span class="line"></span><br><span class="line">    &lt;Engine defaultHost&#x3D;&quot;localhost&quot; name&#x3D;&quot;Catalina&quot;&gt;</span><br><span class="line"></span><br><span class="line">      &lt;Host appBase&#x3D;&quot;webapps&quot; autoDeploy&#x3D;&quot;true&quot; name&#x3D;&quot;localhost&quot; unpackWARs&#x3D;&quot;true&quot;&gt;</span><br><span class="line"></span><br><span class="line">        &lt;Context docBase&#x3D;&quot;handler-api&quot; path&#x3D;&quot;&#x2F;handler&quot; reloadable&#x3D;&quot;true&quot; source&#x3D;&quot;org.eclipse.jst.jee.server:handler-api&quot;&#x2F;&gt;</span><br><span class="line">      &lt;&#x2F;Host&gt;</span><br><span class="line">    &lt;&#x2F;Engine&gt;</span><br><span class="line">  &lt;&#x2F;Service&gt;</span><br><span class="line">&lt;&#x2F;Server&gt;</span><br></pre></td></tr></table></figure>



<p>Engine：表示一个虚拟主机的引擎，一个 Tomcat Server 只有一个 引擎，连接器所有的请求都交给引擎处理，而引擎则会交给相应的虚拟主机去处理请求；</p>
<p>Host：表示虚拟主机，一个容器可以有多个虚拟主机，每个主机都有对应的域名，在 Tomcat 中，一个 webapps 就代表一个虚拟主机，当然 webapps 可以配置多个；</p>
<p>Context：表示一个应用容器，一个虚拟主机可以拥有多个应用，webapps 中每个目录都代表一个 Context，每个应用可以配置多个 Servlet。</p>
<p>Engine -&gt; Host -&gt; Context -&gt; Wrapper -&gt; Servlet</p>
<p><img src="https://github.com/garydai/garydai.github.com/raw/master/_posts/pic/tomcat3.png" alt=""></p>
<h3 id="解析webapps所有war包"><a href="#解析webapps所有war包" class="headerlink" title="解析webapps所有war包"></a>解析webapps所有war包</h3><p>解压war包，导入class</p>
<p>读取WEB-INF文件夹里xml配置（或注解（springboot））</p>
<p>类加载servert class</p>
<h3 id="socket网络编程"><a href="#socket网络编程" class="headerlink" title="socket网络编程"></a>socket网络编程</h3><p>一个线程监听连接，另外一个线程处理请求</p>
<h3 id="connector组件"><a href="#connector组件" class="headerlink" title="connector组件"></a>connector组件</h3><p><strong><em>所有请求的入口和出口</em></strong></p>
<p>连接器，监听接口</p>
<p>接受连接请求，分配线程让container来处理这个请求。</p>
<p><img src="https://github.com/garydai/garydai.github.com/raw/master/_posts/pic/connector.jpeg" alt=""></p>
<p>protocol 监听的协议，默认是http/1.1</p>
<p>port 指定服务器端要创建的端口号</p>
<p>minThread服务器启动时创建的处理请求的线程数</p>
<p>maxThread最大可以创建的处理请求的线程数</p>
<p>enableLookups如果为true，则可以通过调用request.getRemoteHost()进行DNS查询来得到远程客户端的实际主机名，若为false则不进行DNS查询，而是返回其ip地址</p>
<p>redirectPort指定服务器正在处理http请求时收到了一个SSL传输请求后重定向的端口号</p>
<p>acceptCount指定当所有可以使用的处理请求的线程数都被使用时，可以放到处理队列中的请求数，超过这个数的请求将不予处理</p>
<p>connectionTimeout指定超时的时间数(以毫秒为单位)</p>
<p>SSLEnabled 是否开启 sll 验证，在Https 访问时需要开启。</p>
<h4 id="endpoint-1"><a href="#endpoint-1" class="headerlink" title="endpoint"></a>endpoint</h4><p>默认NioEndpoint，监听端口</p>
<p>生产者，消费者模式</p>
<p>Socket acceptor thread</p>
<p>Socket poller thread</p>
<p>Woker threads pool</p>
<h4 id=""><a href="#" class="headerlink" title=""></a></h4><h3 id="service组件"><a href="#service组件" class="headerlink" title="service组件"></a>service组件</h3><p>service收集connector</p>
<h3 id="container组件"><a href="#container组件" class="headerlink" title="container组件"></a>container组件</h3><p>通用容器，包括以下容器</p>
<h4 id="engine"><a href="#engine" class="headerlink" title="engine"></a>engine</h4><p>servlet引擎（责任链模式）</p>
<p>An Engine represents the entry point (within Catalina) that processes every request.  The Engine implementation for Tomcat stand alone analyzes the HTTP headers included with the request, and passes them on to the appropriate Host (virtual host).</p>
<p>处理请求，把请求分配到对应的host</p>
<h4 id="host"><a href="#host" class="headerlink" title="host"></a>host</h4><p>主机</p>
<h4 id="context"><a href="#context" class="headerlink" title="context"></a>context</h4><p>webapp</p>
<h4 id="wrapper"><a href="#wrapper" class="headerlink" title="wrapper"></a>wrapper</h4><p>Servlet</p>
<h3 id="executor"><a href="#executor" class="headerlink" title="executor"></a>executor</h3><p>线程池</p>
<h4 id="processor"><a href="#processor" class="headerlink" title="processor"></a>processor</h4><h4 id="protocol"><a href="#protocol" class="headerlink" title="protocol"></a>protocol</h4><h3 id="启动"><a href="#启动" class="headerlink" title="启动"></a>启动</h3><h4 id="lifecycle生命周期"><a href="#lifecycle生命周期" class="headerlink" title="lifecycle生命周期"></a>lifecycle生命周期</h4><h4 id="初始化"><a href="#初始化" class="headerlink" title="初始化"></a>初始化</h4><h4 id="启动-1"><a href="#启动-1" class="headerlink" title="启动"></a>启动</h4><p>catalina -&gt; server -&gt; (service1 service2 …)</p>
<p>service -&gt; (engine connector1 connector2 …)</p>
<p>engine -&gt; host -&gt; context -&gt; wrapper</p>
<h3 id="三个类加载器"><a href="#三个类加载器" class="headerlink" title="三个类加载器"></a>三个类加载器</h3><p>Common ClassLoader</p>
<p>Catalina ClassLoader</p>
<p>Shared ClassLoader</p>
<h3 id="io模型"><a href="#io模型" class="headerlink" title="io模型"></a>io模型</h3><h4 id="nio"><a href="#nio" class="headerlink" title="nio"></a>nio</h4><p>一个acceptor线程</p>
<p>两个Poller多路复用线程，调用selector.select(timeout)函数</p>
<h3 id="线程创建"><a href="#线程创建" class="headerlink" title="线程创建"></a>线程创建</h3><ol>
<li>http-nio-8080-BlockPoller — NioBlockingSelector</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">org.apache.tomcat.util.net.NioBlockingSelector.BlockPoller</span><br><span class="line">  </span><br><span class="line">												if (sk.isReadable()) &#123;</span><br><span class="line">                              countDown(socketWrapper.getReadLatch());</span><br><span class="line">                          &#125;</span><br><span class="line">                          if (sk.isWritable()) &#123;</span><br><span class="line">                              countDown(socketWrapper.getWriteLatch());</span><br><span class="line">                          &#125;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li><p>Ajp-nio-8009-BlockPoller 处理request</p>
</li>
<li><p>Http-nio-8080-Acceptor一个监听线程</p>
</li>
<li><p>Http-nio-8080-ClientPoller poller线程</p>
</li>
<li><p>http-nio-8080-exec-n处理request的线程池中的线程</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">一次连接countUpOrAwaitConnection（latch.countUpOrAwait），一共10000个latch</span><br><span class="line">使用aqs同步10000个AtomicLong count</span><br><span class="line"></span><br><span class="line">LimitLatch&#123;</span><br><span class="line">	private class Sync extends AbstractQueuedSynchronizer</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



</li>
</ol>
<p>   pollerEvent事件</p>
<p>   poller线程</p>
<ol>
<li>poller线程不断从events队列里取pollerEvent事件，并执行事件（hasEvents = events()，pollerEvent.run()，run里执行逻辑是：如果pollerEvent是OP_REGISTER，则把read socket注册到Selector）</li>
<li>keyCount = selector.selectNow();selector.select(selectorTimeout)等待read事件</li>
<li></li>
</ol>
<p>   监听到一个请求之后，把socket发送给poller</p>
<p>   poller从events工作队列里拿pollerEvent，把socket赋值给event，然后添加到events工作队列，</p>
<p>线程池角度：pollerevent是任务放在线程池子里，poller是消费者，不断取event</p>
<h3 id="层级"><a href="#层级" class="headerlink" title="层级"></a>层级</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version&#x3D;&quot;1.0&quot; encoding&#x3D;&quot;UTF-8&quot;?&gt;</span><br><span class="line">&lt;!--</span><br><span class="line">  Licensed to the Apache Software Foundation (ASF) under one or more</span><br><span class="line">  contributor license agreements.  See the NOTICE file distributed with</span><br><span class="line">  this work for additional information regarding copyright ownership.</span><br><span class="line">  The ASF licenses this file to You under the Apache License, Version 2.0</span><br><span class="line">  (the &quot;License&quot;); you may not use this file except in compliance with</span><br><span class="line">  the License.  You may obtain a copy of the License at</span><br><span class="line"></span><br><span class="line">      http:&#x2F;&#x2F;www.apache.org&#x2F;licenses&#x2F;LICENSE-2.0</span><br><span class="line"></span><br><span class="line">  Unless required by applicable law or agreed to in writing, software</span><br><span class="line">  distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span><br><span class="line">  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span><br><span class="line">  See the License for the specific language governing permissions and</span><br><span class="line">  limitations under the License.</span><br><span class="line">--&gt;</span><br><span class="line">&lt;!-- Note:  A &quot;Server&quot; is not itself a &quot;Container&quot;, so you may not</span><br><span class="line">     define subcomponents such as &quot;Valves&quot; at this level.</span><br><span class="line">     Documentation at &#x2F;docs&#x2F;config&#x2F;server.html</span><br><span class="line"> --&gt;</span><br><span class="line">&lt;Server port&#x3D;&quot;8005&quot; shutdown&#x3D;&quot;SHUTDOWN&quot;&gt;</span><br><span class="line">  &lt;Listener className&#x3D;&quot;org.apache.catalina.startup.VersionLoggerListener&quot; &#x2F;&gt;</span><br><span class="line">  &lt;!-- Security listener. Documentation at &#x2F;docs&#x2F;config&#x2F;listeners.html</span><br><span class="line">  &lt;Listener className&#x3D;&quot;org.apache.catalina.security.SecurityListener&quot; &#x2F;&gt;</span><br><span class="line">  --&gt;</span><br><span class="line">  &lt;!--APR library loader. Documentation at &#x2F;docs&#x2F;apr.html --&gt;</span><br><span class="line">  &lt;Listener className&#x3D;&quot;org.apache.catalina.core.AprLifecycleListener&quot; SSLEngine&#x3D;&quot;on&quot; &#x2F;&gt;</span><br><span class="line">  &lt;!-- Prevent memory leaks due to use of particular java&#x2F;javax APIs--&gt;</span><br><span class="line">  &lt;Listener className&#x3D;&quot;org.apache.catalina.core.JreMemoryLeakPreventionListener&quot; &#x2F;&gt;</span><br><span class="line">  &lt;Listener className&#x3D;&quot;org.apache.catalina.mbeans.GlobalResourcesLifecycleListener&quot; &#x2F;&gt;</span><br><span class="line">  &lt;Listener className&#x3D;&quot;org.apache.catalina.core.ThreadLocalLeakPreventionListener&quot; &#x2F;&gt;</span><br><span class="line"></span><br><span class="line">  &lt;!-- Global JNDI resources</span><br><span class="line">       Documentation at &#x2F;docs&#x2F;jndi-resources-howto.html</span><br><span class="line">  --&gt;</span><br><span class="line">  &lt;GlobalNamingResources&gt;</span><br><span class="line">    &lt;!-- Editable user database that can also be used by</span><br><span class="line">         UserDatabaseRealm to authenticate users</span><br><span class="line">    --&gt;</span><br><span class="line">    &lt;Resource name&#x3D;&quot;UserDatabase&quot; auth&#x3D;&quot;Container&quot;</span><br><span class="line">              type&#x3D;&quot;org.apache.catalina.UserDatabase&quot;</span><br><span class="line">              description&#x3D;&quot;User database that can be updated and saved&quot;</span><br><span class="line">              factory&#x3D;&quot;org.apache.catalina.users.MemoryUserDatabaseFactory&quot;</span><br><span class="line">              pathname&#x3D;&quot;conf&#x2F;tomcat-users.xml&quot; &#x2F;&gt;</span><br><span class="line">  &lt;&#x2F;GlobalNamingResources&gt;</span><br><span class="line"></span><br><span class="line">  &lt;!-- A &quot;Service&quot; is a collection of one or more &quot;Connectors&quot; that share</span><br><span class="line">       a single &quot;Container&quot; Note:  A &quot;Service&quot; is not itself a &quot;Container&quot;,</span><br><span class="line">       so you may not define subcomponents such as &quot;Valves&quot; at this level.</span><br><span class="line">       Documentation at &#x2F;docs&#x2F;config&#x2F;service.html</span><br><span class="line">   --&gt;</span><br><span class="line">  &lt;Service name&#x3D;&quot;Catalina&quot;&gt;</span><br><span class="line"></span><br><span class="line">    &lt;!--The connectors can use a shared executor, you can define one or more named thread pools--&gt;</span><br><span class="line">    &lt;!--</span><br><span class="line">    &lt;Executor name&#x3D;&quot;tomcatThreadPool&quot; namePrefix&#x3D;&quot;catalina-exec-&quot;</span><br><span class="line">        maxThreads&#x3D;&quot;150&quot; minSpareThreads&#x3D;&quot;4&quot;&#x2F;&gt;</span><br><span class="line">    --&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &lt;!-- A &quot;Connector&quot; represents an endpoint by which requests are received</span><br><span class="line">         and responses are returned. Documentation at :</span><br><span class="line">         Java HTTP Connector: &#x2F;docs&#x2F;config&#x2F;http.html</span><br><span class="line">         Java AJP  Connector: &#x2F;docs&#x2F;config&#x2F;ajp.html</span><br><span class="line">         APR (HTTP&#x2F;AJP) Connector: &#x2F;docs&#x2F;apr.html</span><br><span class="line">         Define a non-SSL&#x2F;TLS HTTP&#x2F;1.1 Connector on port 8080</span><br><span class="line">    --&gt;</span><br><span class="line">    &lt;Connector port&#x3D;&quot;8080&quot; protocol&#x3D;&quot;HTTP&#x2F;1.1&quot;</span><br><span class="line">               connectionTimeout&#x3D;&quot;20000&quot;</span><br><span class="line">               redirectPort&#x3D;&quot;8443&quot; &#x2F;&gt;</span><br><span class="line">    &lt;!-- A &quot;Connector&quot; using the shared thread pool--&gt;</span><br><span class="line">    &lt;!--</span><br><span class="line">    &lt;Connector executor&#x3D;&quot;tomcatThreadPool&quot;</span><br><span class="line">               port&#x3D;&quot;8080&quot; protocol&#x3D;&quot;HTTP&#x2F;1.1&quot;</span><br><span class="line">               connectionTimeout&#x3D;&quot;20000&quot;</span><br><span class="line">               redirectPort&#x3D;&quot;8443&quot; &#x2F;&gt;</span><br><span class="line">    --&gt;</span><br><span class="line">    &lt;!-- Define a SSL&#x2F;TLS HTTP&#x2F;1.1 Connector on port 8443</span><br><span class="line">         This connector uses the NIO implementation. The default</span><br><span class="line">         SSLImplementation will depend on the presence of the APR&#x2F;native</span><br><span class="line">         library and the useOpenSSL attribute of the</span><br><span class="line">         AprLifecycleListener.</span><br><span class="line">         Either JSSE or OpenSSL style configuration may be used regardless of</span><br><span class="line">         the SSLImplementation selected. JSSE style configuration is used below.</span><br><span class="line">    --&gt;</span><br><span class="line">    &lt;!--</span><br><span class="line">    &lt;Connector port&#x3D;&quot;8443&quot; protocol&#x3D;&quot;org.apache.coyote.http11.Http11NioProtocol&quot;</span><br><span class="line">               maxThreads&#x3D;&quot;150&quot; SSLEnabled&#x3D;&quot;true&quot;&gt;</span><br><span class="line">        &lt;SSLHostConfig&gt;</span><br><span class="line">            &lt;Certificate certificateKeystoreFile&#x3D;&quot;conf&#x2F;localhost-rsa.jks&quot;</span><br><span class="line">                         type&#x3D;&quot;RSA&quot; &#x2F;&gt;</span><br><span class="line">        &lt;&#x2F;SSLHostConfig&gt;</span><br><span class="line">    &lt;&#x2F;Connector&gt;</span><br><span class="line">    --&gt;</span><br><span class="line">    &lt;!-- Define a SSL&#x2F;TLS HTTP&#x2F;1.1 Connector on port 8443 with HTTP&#x2F;2</span><br><span class="line">         This connector uses the APR&#x2F;native implementation which always uses</span><br><span class="line">         OpenSSL for TLS.</span><br><span class="line">         Either JSSE or OpenSSL style configuration may be used. OpenSSL style</span><br><span class="line">         configuration is used below.</span><br><span class="line">    --&gt;</span><br><span class="line">    &lt;!--</span><br><span class="line">    &lt;Connector port&#x3D;&quot;8443&quot; protocol&#x3D;&quot;org.apache.coyote.http11.Http11AprProtocol&quot;</span><br><span class="line">               maxThreads&#x3D;&quot;150&quot; SSLEnabled&#x3D;&quot;true&quot; &gt;</span><br><span class="line">        &lt;UpgradeProtocol className&#x3D;&quot;org.apache.coyote.http2.Http2Protocol&quot; &#x2F;&gt;</span><br><span class="line">        &lt;SSLHostConfig&gt;</span><br><span class="line">            &lt;Certificate certificateKeyFile&#x3D;&quot;conf&#x2F;localhost-rsa-key.pem&quot;</span><br><span class="line">                         certificateFile&#x3D;&quot;conf&#x2F;localhost-rsa-cert.pem&quot;</span><br><span class="line">                         certificateChainFile&#x3D;&quot;conf&#x2F;localhost-rsa-chain.pem&quot;</span><br><span class="line">                         type&#x3D;&quot;RSA&quot; &#x2F;&gt;</span><br><span class="line">        &lt;&#x2F;SSLHostConfig&gt;</span><br><span class="line">    &lt;&#x2F;Connector&gt;</span><br><span class="line">    --&gt;</span><br><span class="line"></span><br><span class="line">    &lt;!-- Define an AJP 1.3 Connector on port 8009 --&gt;</span><br><span class="line">    &lt;Connector port&#x3D;&quot;8009&quot; protocol&#x3D;&quot;AJP&#x2F;1.3&quot; redirectPort&#x3D;&quot;8443&quot; &#x2F;&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &lt;!-- An Engine represents the entry point (within Catalina) that processes</span><br><span class="line">         every request.  The Engine implementation for Tomcat stand alone</span><br><span class="line">         analyzes the HTTP headers included with the request, and passes them</span><br><span class="line">         on to the appropriate Host (virtual host).</span><br><span class="line">         Documentation at &#x2F;docs&#x2F;config&#x2F;engine.html --&gt;</span><br><span class="line"></span><br><span class="line">    &lt;!-- You should set jvmRoute to support load-balancing via AJP ie :</span><br><span class="line">    &lt;Engine name&#x3D;&quot;Catalina&quot; defaultHost&#x3D;&quot;localhost&quot; jvmRoute&#x3D;&quot;jvm1&quot;&gt;</span><br><span class="line">    --&gt;</span><br><span class="line">    &lt;Engine name&#x3D;&quot;Catalina&quot; defaultHost&#x3D;&quot;localhost&quot;&gt;</span><br><span class="line"></span><br><span class="line">      &lt;!--For clustering, please take a look at documentation at:</span><br><span class="line">          &#x2F;docs&#x2F;cluster-howto.html  (simple how to)</span><br><span class="line">          &#x2F;docs&#x2F;config&#x2F;cluster.html (reference documentation) --&gt;</span><br><span class="line">      &lt;!--</span><br><span class="line">      &lt;Cluster className&#x3D;&quot;org.apache.catalina.ha.tcp.SimpleTcpCluster&quot;&#x2F;&gt;</span><br><span class="line">      --&gt;</span><br><span class="line"></span><br><span class="line">      &lt;!-- Use the LockOutRealm to prevent attempts to guess user passwords</span><br><span class="line">           via a brute-force attack --&gt;</span><br><span class="line">      &lt;Realm className&#x3D;&quot;org.apache.catalina.realm.LockOutRealm&quot;&gt;</span><br><span class="line">        &lt;!-- This Realm uses the UserDatabase configured in the global JNDI</span><br><span class="line">             resources under the key &quot;UserDatabase&quot;.  Any edits</span><br><span class="line">             that are performed against this UserDatabase are immediately</span><br><span class="line">             available for use by the Realm.  --&gt;</span><br><span class="line">        &lt;Realm className&#x3D;&quot;org.apache.catalina.realm.UserDatabaseRealm&quot;</span><br><span class="line">               resourceName&#x3D;&quot;UserDatabase&quot;&#x2F;&gt;</span><br><span class="line">      &lt;&#x2F;Realm&gt;</span><br><span class="line"></span><br><span class="line">      &lt;Host name&#x3D;&quot;localhost&quot;  appBase&#x3D;&quot;webapps&quot;</span><br><span class="line">            unpackWARs&#x3D;&quot;true&quot; autoDeploy&#x3D;&quot;true&quot;&gt;</span><br><span class="line"></span><br><span class="line">        &lt;!-- SingleSignOn valve, share authentication between web applications</span><br><span class="line">             Documentation at: &#x2F;docs&#x2F;config&#x2F;valve.html --&gt;</span><br><span class="line">        &lt;!--</span><br><span class="line">        &lt;Valve className&#x3D;&quot;org.apache.catalina.authenticator.SingleSignOn&quot; &#x2F;&gt;</span><br><span class="line">        --&gt;</span><br><span class="line"></span><br><span class="line">        &lt;!-- Access log processes all example.</span><br><span class="line">             Documentation at: &#x2F;docs&#x2F;config&#x2F;valve.html</span><br><span class="line">             Note: The pattern used is equivalent to using pattern&#x3D;&quot;common&quot; --&gt;</span><br><span class="line">        &lt;Valve className&#x3D;&quot;org.apache.catalina.valves.AccessLogValve&quot; directory&#x3D;&quot;logs&quot;</span><br><span class="line">               prefix&#x3D;&quot;localhost_access_log&quot; suffix&#x3D;&quot;.txt&quot;</span><br><span class="line">               pattern&#x3D;&quot;%h %l %u %t &quot;%r&quot; %s %b&quot; &#x2F;&gt;</span><br><span class="line"></span><br><span class="line">      &lt;&#x2F;Host&gt;</span><br><span class="line">    &lt;&#x2F;Engine&gt;</span><br><span class="line">  &lt;&#x2F;Service&gt;</span><br><span class="line">&lt;&#x2F;Server&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">server</span><br><span class="line">    service</span><br><span class="line">        Connector</span><br><span class="line">        engine</span><br><span class="line">            host</span><br><span class="line">            		context</span><br><span class="line">                Valve</span><br><span class="line">            Realm</span><br></pre></td></tr></table></figure>
<p><img src="https://github.com/garydai/garydai.github.com/raw/master/_posts/pic/tomcat-engine.jpeg" alt=""></p>
<p><img src="https://github.com/garydai/garydai.github.com/raw/master/_posts/pic/tomcat-context.jpeg" alt=""></p>
<p><img src="https://github.com/garydai/garydai.github.com/raw/master/_posts/pic/tomcat.png" alt=""></p>
<p><img src="https://github.com/garydai/garydai.github.com/raw/master/_posts/pic/tomcat2.png" alt=""></p>
<p><img src="https://github.com/garydai/garydai.github.com/raw/master/_posts/pic/tomcatnio.png" alt=""></p>
<h3 id="reference"><a href="#reference" class="headerlink" title="reference"></a>reference</h3><p><a href="https://www.processon.com/view/link/5d75f8a7e4b04a19501b07d5" target="_blank" rel="noopener">https://www.processon.com/view/link/5d75f8a7e4b04a19501b07d5</a></p>
<p><a href="https://www.jianshu.com/p/76ff17bc6dea" target="_blank" rel="noopener">https://www.jianshu.com/p/76ff17bc6dea</a></p>
<p><a href="http://objcoding.com/2019/05/30/tomcat-architecture/" target="_blank" rel="noopener">http://objcoding.com/2019/05/30/tomcat-architecture/</a></p>
<p><a href="https://time.geekbang.org/column/article/96764" target="_blank" rel="noopener">https://time.geekbang.org/column/article/96764</a></p>
<p><a href="https://www.cnblogs.com/haimishasha/p/10740606.html" target="_blank" rel="noopener">https://www.cnblogs.com/haimishasha/p/10740606.html</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2018/04/21/2018-4-21-tomcat/" data-id="ck521h1bp007blc7kf6lghvvi" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="default-2018-3-21-select-poll-epoll" class="article article-type-default" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018/03/21/2018-3-21-select-poll-epoll/" class="article-date">
  <time datetime="2018-03-20T16:00:00.000Z" itemprop="datePublished">2018-03-21</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2018/03/21/2018-3-21-select-poll-epoll/">select / poll / epoll</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="select-poll-epoll"><a href="#select-poll-epoll" class="headerlink" title="select / poll / epoll"></a>select / poll / epoll</h2><h3 id="select"><a href="#select" class="headerlink" title="select"></a>select</h3><pre><code>fd_set fd_in, fd_out;
struct timeval tv;

// Reset the sets
FD_ZERO( &amp;fd_in );
FD_ZERO( &amp;fd_out );

// Monitor sock1 for input events
FD_SET( sock1, &amp;fd_in );

// Monitor sock2 for output events
FD_SET( sock2, &amp;fd_out );

// Find out which socket has the largest numeric value as select requires it
int largest_sock = sock1 &gt; sock2 ? sock1 : sock2;

// Wait up to 10 seconds
tv.tv_sec = 10;
tv.tv_usec = 0;

// Call the select
int ret = select( largest_sock + 1, &amp;fd_in, &amp;fd_out, NULL, &amp;tv );

// Check if select actually succeed
if ( ret == -1 )
    // report error and abort
else if ( ret == 0 )
    // timeout; no event detected
else
{
    if ( FD_ISSET( sock1, &amp;fd_in ) )
        // input event on sock1

    if ( FD_ISSET( sock2, &amp;fd_out ) )
        // output event on sock2
}</code></pre><p>在每次调用 select() 函数之前，系统需要把一个 fd 从用户态拷贝到内核态，这样就给系统带来了一定的性能开销。再有单个进程监视的 fd 数量默认是 1024，我们可以通过修改宏定义甚至重新编译内核的方式打破这一限制。但由于 fd_set 是基于数组实现的，在新增和删除 fd 时，数量过大会导致效率降低</p>
<h3 id="poll"><a href="#poll" class="headerlink" title="poll"></a>poll</h3><pre><code>// The structure for two events
struct pollfd fds[2];

// Monitor sock1 for input
fds[0].fd = sock1;
fds[0].events = POLLIN;

// Monitor sock2 for output
fds[1].fd = sock2;
fds[1].events = POLLOUT;

// Wait 10 seconds
int ret = poll( &amp;fds, 2, 10000 );
// Check if poll actually succeed
if ( ret == -1 )
    // report error and abort
else if ( ret == 0 )
    // timeout; no event detected
else
{
    // If we detect the event, zero it out so we can reuse the structure
    if ( pfd[0].revents &amp; POLLIN )
        pfd[0].revents = 0;
        // input event on sock1

    if ( pfd[1].revents &amp; POLLOUT )
        pfd[1].revents = 0;
        // output event on sock2
}</code></pre><p>poll() 的机制与 select() 类似，二者在本质上差别不大。poll() 管理多个描述符也是通过轮询，根据描述符的状态进行处理，但 poll() 没有最大文件描述符数量的限制</p>
<h3 id="epoll"><a href="#epoll" class="headerlink" title="epoll"></a>epoll</h3><pre><code>// Create the epoll descriptor. Only one is needed per app, and is used to monitor all sockets.
// The function argument is ignored (it was not before, but now it is), so put your favorite number here
int pollingfd = epoll_create( 0xCAFE ); 

if ( pollingfd &lt; 0 )
 // report error

// Initialize the epoll structure in case more members are added in future
struct epoll_event ev = { 0 };

// Associate the connection class instance with the event. You can associate anything
// you want, epoll does not use this information. We store a connection class pointer, pConnection1
ev.data.ptr = pConnection1;

// Monitor for input, and do not automatically rearm the descriptor after the event
ev.events = EPOLLIN | EPOLLONESHOT;
// Add the descriptor into the monitoring list. We can do it even if another thread is 
// waiting in epoll_wait - the descriptor will be properly added
if ( epoll_ctl( epollfd, EPOLL_CTL_ADD, pConnection1-&gt;getSocket(), &amp;ev ) != 0 )
    // report error

// Wait for up to 20 events (assuming we have added maybe 200 sockets before that it may happen)
struct epoll_event pevents[ 20 ];

// Wait for 10 seconds
int ready = epoll_wait( pollingfd, pevents, 20, 10000 );
// Check if epoll actually succeed
if ( ret == -1 )
    // report error and abort
else if ( ret == 0 )
    // timeout; no event detected
else
{
    // Check if any events detected
    for ( int i = 0; i &lt; ret; i++ )
    {
        if ( pevents[i].events &amp; EPOLLIN )
        {
            // Get back our connection pointer
            Connection * c = (Connection*) pevents[i].data.ptr;
            c-&gt;handleReadEvent();
         }
    }
}</code></pre><p>epoll 事先通过 epoll_ctl() 来注册一个文件描述符，将文件描述符存放到内核的一个事件表中，这个事件表是基于红黑树实现的，所以在大量 I/O 请求的场景下，插入和删除的性能比 select/poll 的数组 fd_set 要好，因此 epoll 的性能更胜一筹，而且不会受到 fd 数量的限制。</p>
<p><a href="https://www.cnblogs.com/wish123/p/11393383.html" target="_blank" rel="noopener">https://www.cnblogs.com/wish123/p/11393383.html</a></p>
<h3 id="fd"><a href="#fd" class="headerlink" title="fd"></a>fd</h3><p>一个进程默认可以创建1024个文件，socket也属于一个文件，fd指的是fds[1024]的索引，数组的值表示文件地址</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2018/03/21/2018-3-21-select-poll-epoll/" data-id="ck521h13a004klc7khbmda39b" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="default-2018-1-29-nginx&amp;php" class="article article-type-default" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018/01/29/2018-1-29-nginx&php/" class="article-date">
  <time datetime="2018-01-28T16:00:00.000Z" itemprop="datePublished">2018-01-29</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2018/01/29/2018-1-29-nginx&php/">nginx&amp;php</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="nginx-amp-php"><a href="#nginx-amp-php" class="headerlink" title="nginx&amp;php"></a>nginx&amp;php</h2><p>nginx转发请求给php-fpm，php-fpm是fastcgi协议的一种实现。衔接webserver和业务逻辑</p>
<h3 id="交互流程"><a href="#交互流程" class="headerlink" title="交互流程"></a>交互流程</h3><p>php-fpm初始化，监听用户请求</p>
<p>nginx webserver收到用户请求，根据nginx配置，把请求转发到php-fpm，php-fpm把请求输入到php框架比如yii2，框架根据不同请求，进行逻辑处理。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2018/01/29/2018-1-29-nginx&php/" data-id="ck521h137004hlc7kd86zc4il" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="default-2018-1-27-metrics-spring code review" class="article article-type-default" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018/01/27/2018-1-27-metrics-spring%20code%20review/" class="article-date">
  <time datetime="2018-01-26T16:00:00.000Z" itemprop="datePublished">2018-01-27</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2018/01/27/2018-1-27-metrics-spring%20code%20review/">metrics-spring</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="metrics-spring-code-review"><a href="#metrics-spring-code-review" class="headerlink" title="metrics-spring code review"></a>metrics-spring code review</h2><h3 id="设计模式"><a href="#设计模式" class="headerlink" title="设计模式"></a>设计模式</h3><p>抽象工厂</p>
<pre><code>public class JmxReporterFactoryBean extends AbstractReporterFactoryBean&lt;JmxReporter&gt; implements SmartLifecycle, DisposableBean</code></pre>
      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2018/01/27/2018-1-27-metrics-spring%20code%20review/" data-id="ck521h138004ilc7kbew738va" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="default-2018-1-24-SOLID" class="article article-type-default" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018/01/24/2018-1-24-SOLID/" class="article-date">
  <time datetime="2018-01-23T16:00:00.000Z" itemprop="datePublished">2018-01-24</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2018/01/24/2018-1-24-SOLID/">面向对象的SOLID原则</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="面向对象的SOLID原则"><a href="#面向对象的SOLID原则" class="headerlink" title="面向对象的SOLID原则"></a>面向对象的SOLID原则</h2><h3 id="S-The-Single-Responsibility-Principle-单一责任原则"><a href="#S-The-Single-Responsibility-Principle-单一责任原则" class="headerlink" title="S    The Single Responsibility Principle    单一责任原则"></a>S    The Single Responsibility Principle    单一责任原则</h3><p>一个类只应承担一种责任。换句话说，让一个类只做一件事。如果需要承担更多的工作，那么分解这个类。</p>
<p>举例</p>
<p>订单和账单上都有流水号、业务时间等字段。如果只用一个类表达，赋予其双重职责，后果:</p>
<p>特有属性和共有属性相互掺杂，难以理解;</p>
<p>修改一个场景可能会影响另一个场景。</p>
<p>正确的做法是拆成两个独立的类。</p>
<h3 id="O-The-Open-Closed-Principle-开放封闭原则"><a href="#O-The-Open-Closed-Principle-开放封闭原则" class="headerlink" title="O    The Open Closed Principle    开放封闭原则"></a>O    The Open Closed Principle    开放封闭原则</h3><p>实体应该对扩展是开放的，对修改是封闭的。即，可扩展(extension)，不可修改(modification)。</p>
<h3 id="L-Liskov-Substitution-Principle-里氏替换原则"><a href="#L-Liskov-Substitution-Principle-里氏替换原则" class="headerlink" title="L    Liskov Substitution Principle    里氏替换原则"></a>L    Liskov Substitution Principle    里氏替换原则</h3><p>一个对象在其出现的任何地方，都可以用子类实例做替换，并且不会导致程序的错误。换句话说，当子类可以在任意地方替换基类且软件功能不受影响时，这种继承关系的建模才是合理的。</p>
<h3 id="I-The-Interface-Segregation-Principle-接口分离原则"><a href="#I-The-Interface-Segregation-Principle-接口分离原则" class="headerlink" title="I    The Interface Segregation Principle    接口分离原则"></a>I    The Interface Segregation Principle    接口分离原则</h3><p>客户(client)不应被强迫依赖它不使用的方法。即，一个类实现的接口中，包含了它不需要的方法。将接口拆分成更小和更具体的接口，有助于解耦，从而更容易重构、更改。</p>
<h3 id="D-The-Dependency-Inversion-Principle-依赖倒置原则"><a href="#D-The-Dependency-Inversion-Principle-依赖倒置原则" class="headerlink" title="D    The Dependency Inversion Principle    依赖倒置原则"></a>D    The Dependency Inversion Principle    依赖倒置原则</h3><p>高层次的模块不应依赖低层次的模块，他们都应该依赖于抽象。</p>
<p>抽象不应依赖于具体实现，具体实现应依赖抽象。</p>
<pre><code>class Car {
    Wheel wheel;
    Car() {
        wheel = new Wheel();
    }
}

表明car依赖wheel，如果wheel的构造函数改变，则car也需要改动。

class Car {
    Wheel wheel;
    Car(Wheel wheel) {
        wheel = wheel;
    }
}

依赖注入，解决了wheel构造函数改变，Car也需要改动的问题</code></pre><p><a href="http://www.cnblogs.com/wuyuegb2312/p/7011708.html" target="_blank" rel="noopener">http://www.cnblogs.com/wuyuegb2312/p/7011708.html</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2018/01/24/2018-1-24-SOLID/" data-id="ck521h136004glc7k33libxin" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="default-2018-1-23-spring boot" class="article article-type-default" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018/01/23/2018-1-23-spring%20boot/" class="article-date">
  <time datetime="2018-01-22T16:00:00.000Z" itemprop="datePublished">2018-01-23</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2018/01/23/2018-1-23-spring%20boot/">spring boot</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="spring-boot"><a href="#spring-boot" class="headerlink" title="spring boot"></a>spring boot</h2><h3 id="spring"><a href="#spring" class="headerlink" title="spring"></a>spring</h3><p>DI（依赖注入IOC）</p>
<p>AOP（面向切面编程）</p>
<p>把有一些类注解，实例一次，放入ioc容器</p>
<p>通过autowired等注解，从ioc容器里拿实例</p>
<h3 id="spring-boot-1"><a href="#spring-boot-1" class="headerlink" title="spring boot"></a>spring boot</h3><p>创建一个基于spring的应用简单</p>
<p>自动配置</p>
<p>零xml配置</p>
<p>application.properties是spring boot默认的配置文件，spring boot默认会在以下两个路径搜索并加载这个文件</p>
<p>src\main\resources</p>
<p>src\main\resources\config</p>
<h2 id="程序开始"><a href="#程序开始" class="headerlink" title="程序开始"></a>程序开始</h2><p>SpringApplication.run（），进行自动配置</p>
<h3 id="SpringApplication构造函数"><a href="#SpringApplication构造函数" class="headerlink" title="SpringApplication构造函数"></a>SpringApplication构造函数</h3><p>org.springframework.boot.SpringApplication#SpringApplication(org.springframework.core.io.ResourceLoader, java.lang.Class&lt;?&gt;…)</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">SpringApplication</span><span class="params">(ResourceLoader resourceLoader, Class&lt;?&gt;... primarySources)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.resourceLoader = resourceLoader;</span><br><span class="line">		Assert.notNull(primarySources, <span class="string">"PrimarySources must not be null"</span>);</span><br><span class="line">		<span class="keyword">this</span>.primarySources = <span class="keyword">new</span> LinkedHashSet&lt;&gt;(Arrays.asList(primarySources));</span><br><span class="line">		<span class="keyword">this</span>.webApplicationType = deduceWebApplicationType();</span><br><span class="line">    <span class="comment">// 从spring.factories找到org.springframework.context.ApplicationContextInitializer实现类并实例化</span></span><br><span class="line">		setInitializers((Collection) getSpringFactoriesInstances(</span><br><span class="line">				ApplicationContextInitializer<span class="class">.<span class="keyword">class</span>))</span>;</span><br><span class="line">    <span class="comment">// 从spring.factories找到org.springframework.context.ApplicationListener实现类并实例化</span></span><br><span class="line">		setListeners((Collection) getSpringFactoriesInstances(ApplicationListener<span class="class">.<span class="keyword">class</span>))</span>;</span><br><span class="line">    <span class="comment">// 根据调用栈，拿到main启动类 new RuntimeException().getStackTrace() </span></span><br><span class="line">		<span class="keyword">this</span>.mainApplicationClass = deduceMainApplicationClass();</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> &lt;T&gt; <span class="function">Collection&lt;T&gt; <span class="title">getSpringFactoriesInstances</span><span class="params">(Class&lt;T&gt; type,</span></span></span><br><span class="line"><span class="function"><span class="params">      Class&lt;?&gt;[] parameterTypes, Object... args)</span> </span>&#123;</span><br><span class="line">   ClassLoader classLoader = Thread.currentThread().getContextClassLoader();</span><br><span class="line">   <span class="comment">// Use names and ensure unique to protect against duplicates</span></span><br><span class="line">   <span class="comment">// 从spring.factories找到type实现类全限定名</span></span><br><span class="line">   Set&lt;String&gt; names = <span class="keyword">new</span> LinkedHashSet&lt;&gt;(</span><br><span class="line">         SpringFactoriesLoader.loadFactoryNames(type, classLoader));</span><br><span class="line">   <span class="comment">// 实例化</span></span><br><span class="line">   List&lt;T&gt; instances = createSpringFactoriesInstances(type, parameterTypes,</span><br><span class="line">         classLoader, args, names);</span><br><span class="line">   AnnotationAwareOrderComparator.sort(instances);</span><br><span class="line">   <span class="keyword">return</span> instances;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> &lt;T&gt; <span class="function">List&lt;T&gt; <span class="title">createSpringFactoriesInstances</span><span class="params">(Class&lt;T&gt; type,</span></span></span><br><span class="line"><span class="function"><span class="params">      Class&lt;?&gt;[] parameterTypes, ClassLoader classLoader, Object[] args,</span></span></span><br><span class="line"><span class="function"><span class="params">      Set&lt;String&gt; names)</span> </span>&#123;</span><br><span class="line">   List&lt;T&gt; instances = <span class="keyword">new</span> ArrayList&lt;&gt;(names.size());</span><br><span class="line">   <span class="keyword">for</span> (String name : names) &#123;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">         Class&lt;?&gt; instanceClass = ClassUtils.forName(name, classLoader);</span><br><span class="line">         Assert.isAssignable(type, instanceClass);</span><br><span class="line">         Constructor&lt;?&gt; constructor = instanceClass</span><br><span class="line">               .getDeclaredConstructor(parameterTypes);</span><br><span class="line">         <span class="comment">// 实例化</span></span><br><span class="line">         T instance = (T) BeanUtils.instantiateClass(constructor, args);</span><br><span class="line">         instances.add(instance);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">catch</span> (Throwable ex) &#123;</span><br><span class="line">         <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(</span><br><span class="line">               <span class="string">"Cannot instantiate "</span> + type + <span class="string">" : "</span> + name, ex);</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">return</span> instances;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">springboot autoconfiguration的meta-inf的spring.factories文件</span><br><span class="line"># Initializers</span><br><span class="line">org.springframework.context.ApplicationContextInitializer=\</span><br><span class="line">org.springframework.boot.autoconfigure.SharedMetadataReaderFactoryContextInitializer,\</span><br><span class="line">org.springframework.boot.autoconfigure.logging.ConditionEvaluationReportLoggingListener</span><br><span class="line"></span><br><span class="line"># Application Listeners</span><br><span class="line">org.springframework.context.ApplicationListener=\</span><br><span class="line">org.springframework.boot.autoconfigure.BackgroundPreinitializer</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"> <span class="number">0</span> = <span class="string">"org.springframework.boot.context.ConfigurationWarningsApplicationContextInitializer"</span></span><br><span class="line"> <span class="number">1</span> = <span class="string">"org.springframework.boot.context.ContextIdApplicationContextInitializer"</span></span><br><span class="line"> <span class="number">2</span> = <span class="string">"org.springframework.boot.context.config.DelegatingApplicationContextInitializer"</span></span><br><span class="line"> <span class="number">3</span> = <span class="string">"org.springframework.boot.web.context.ServerPortInfoApplicationContextInitializer"</span></span><br><span class="line"> <span class="number">4</span> = <span class="string">"org.springframework.boot.autoconfigure.SharedMetadataReaderFactoryContextInitializer"</span></span><br><span class="line"> <span class="number">5</span> = <span class="string">"org.springframework.boot.autoconfigure.logging.ConditionEvaluationReportLoggingListener"</span></span><br></pre></td></tr></table></figure>

<h4 id="run函数"><a href="#run函数" class="headerlink" title="run函数"></a>run函数</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> ConfigurableApplicationContext <span class="title">run</span><span class="params">(String... args)</span> </span>&#123;</span><br><span class="line">   StopWatch stopWatch = <span class="keyword">new</span> StopWatch();</span><br><span class="line">   stopWatch.start();</span><br><span class="line">   ConfigurableApplicationContext context = <span class="keyword">null</span>;</span><br><span class="line">   Collection&lt;SpringBootExceptionReporter&gt; exceptionReporters = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">   configureHeadlessProperty();</span><br><span class="line">   SpringApplicationRunListeners listeners = getRunListeners(args);</span><br><span class="line">   listeners.starting();</span><br><span class="line">   <span class="keyword">try</span> &#123;</span><br><span class="line">      ApplicationArguments applicationArguments = <span class="keyword">new</span> DefaultApplicationArguments(</span><br><span class="line">            args);</span><br><span class="line">      ConfigurableEnvironment environment = prepareEnvironment(listeners,</span><br><span class="line">            applicationArguments);</span><br><span class="line">      configureIgnoreBeanInfo(environment);</span><br><span class="line">      Banner printedBanner = printBanner(environment);</span><br><span class="line">      context = createApplicationContext();</span><br><span class="line">      exceptionReporters = getSpringFactoriesInstances(</span><br><span class="line">            SpringBootExceptionReporter<span class="class">.<span class="keyword">class</span>,</span></span><br><span class="line">            new Class[] &#123; ConfigurableApplicationContext.class &#125;, context);</span><br><span class="line">      prepareContext(context, environment, listeners, applicationArguments,</span><br><span class="line">            printedBanner);</span><br><span class="line">      <span class="comment">// 创建spring容器，和web服务器</span></span><br><span class="line">      refreshContext(context);</span><br><span class="line">      afterRefresh(context, applicationArguments);</span><br><span class="line">      stopWatch.stop();</span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">this</span>.logStartupInfo) &#123;</span><br><span class="line">         <span class="keyword">new</span> StartupInfoLogger(<span class="keyword">this</span>.mainApplicationClass)</span><br><span class="line">               .logStarted(getApplicationLog(), stopWatch);</span><br><span class="line">      &#125;</span><br><span class="line">      listeners.started(context);</span><br><span class="line">      callRunners(context, applicationArguments);</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">catch</span> (Throwable ex) &#123;</span><br><span class="line">      handleRunFailure(context, ex, exceptionReporters, listeners);</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(ex);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">try</span> &#123;</span><br><span class="line">      listeners.running(context);</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">catch</span> (Throwable ex) &#123;</span><br><span class="line">      handleRunFailure(context, ex, exceptionReporters, <span class="keyword">null</span>);</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(ex);</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">return</span> context;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>创建spring容器，默认org.springframework.boot.web.servlet.context.AnnotationConfigServletWebServerApplicationContext</p>
<p><img src="https://github.com/garydai/garydai.github.com/raw/master/_posts/pic/image-20191225093322418.png" alt="image-20191225093322418"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> ConfigurableApplicationContext <span class="title">createApplicationContext</span><span class="params">()</span> </span>&#123;</span><br><span class="line">   Class&lt;?&gt; contextClass = <span class="keyword">this</span>.applicationContextClass;</span><br><span class="line">   <span class="keyword">if</span> (contextClass == <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">         <span class="keyword">switch</span> (<span class="keyword">this</span>.webApplicationType) &#123;</span><br><span class="line">         <span class="keyword">case</span> SERVLET:</span><br><span class="line">            contextClass = Class.forName(DEFAULT_WEB_CONTEXT_CLASS);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">         <span class="keyword">case</span> REACTIVE:</span><br><span class="line">            contextClass = Class.forName(DEFAULT_REACTIVE_WEB_CONTEXT_CLASS);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">         <span class="keyword">default</span>:</span><br><span class="line">            contextClass = Class.forName(DEFAULT_CONTEXT_CLASS);</span><br><span class="line">         &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">catch</span> (ClassNotFoundException ex) &#123;</span><br><span class="line">         <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(</span><br><span class="line">               <span class="string">"Unable create a default ApplicationContext, "</span></span><br><span class="line">                     + <span class="string">"please specify an ApplicationContextClass"</span>,</span><br><span class="line">               ex);</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">return</span> (ConfigurableApplicationContext) BeanUtils.instantiateClass(contextClass);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">prepareContext</span><span class="params">(ConfigurableApplicationContext context,</span></span></span><br><span class="line"><span class="function"><span class="params">      ConfigurableEnvironment environment, SpringApplicationRunListeners listeners,</span></span></span><br><span class="line"><span class="function"><span class="params">      ApplicationArguments applicationArguments, Banner printedBanner)</span> </span>&#123;</span><br><span class="line">   context.setEnvironment(environment);</span><br><span class="line">   postProcessApplicationContext(context);</span><br><span class="line">   <span class="comment">// 执行Initializers</span></span><br><span class="line">   applyInitializers(context);</span><br><span class="line">   <span class="comment">// 执行listeners</span></span><br><span class="line">   listeners.contextPrepared(context);</span><br><span class="line">   <span class="keyword">if</span> (<span class="keyword">this</span>.logStartupInfo) &#123;</span><br><span class="line">      logStartupInfo(context.getParent() == <span class="keyword">null</span>);</span><br><span class="line">      logStartupProfileInfo(context);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// Add boot specific singleton beans</span></span><br><span class="line">   context.getBeanFactory().registerSingleton(<span class="string">"springApplicationArguments"</span>,</span><br><span class="line">         applicationArguments);</span><br><span class="line">   <span class="keyword">if</span> (printedBanner != <span class="keyword">null</span>) &#123;</span><br><span class="line">      context.getBeanFactory().registerSingleton(<span class="string">"springBootBanner"</span>, printedBanner);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// Load the sources</span></span><br><span class="line">   Set&lt;Object&gt; sources = getAllSources();</span><br><span class="line">   Assert.notEmpty(sources, <span class="string">"Sources must not be empty"</span>);</span><br><span class="line">   load(context, sources.toArray(<span class="keyword">new</span> Object[<span class="number">0</span>]));</span><br><span class="line">   listeners.contextLoaded(context);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>org.springframework.boot.web.servlet.context.ServletWebServerApplicationContext#onRefresh</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onRefresh</span><span class="params">()</span> </span>&#123;</span><br><span class="line">   <span class="keyword">super</span>.onRefresh();</span><br><span class="line">   <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="comment">// 实例化并启动tomcat服务器</span></span><br><span class="line">      createWebServer();</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">catch</span> (Throwable ex) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> ApplicationContextException(<span class="string">"Unable to start web server"</span>, ex);</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">createWebServer</span><span class="params">()</span> </span>&#123;</span><br><span class="line">   WebServer webServer = <span class="keyword">this</span>.webServer;</span><br><span class="line">   ServletContext servletContext = getServletContext();</span><br><span class="line">   <span class="keyword">if</span> (webServer == <span class="keyword">null</span> &amp;&amp; servletContext == <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="comment">// 创建webServer工厂tomcatServletWebServerFactory</span></span><br><span class="line">      ServletWebServerFactory factory = getWebServerFactory();</span><br><span class="line">     	<span class="comment">// 创建webServer</span></span><br><span class="line">      <span class="keyword">this</span>.webServer = factory.getWebServer(getSelfInitializer());</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">else</span> <span class="keyword">if</span> (servletContext != <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">         getSelfInitializer().onStartup(servletContext);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">catch</span> (ServletException ex) &#123;</span><br><span class="line">         <span class="keyword">throw</span> <span class="keyword">new</span> ApplicationContextException(<span class="string">"Cannot initialize servlet context"</span>,</span><br><span class="line">               ex);</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line">   initPropertySources();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ServletWebServerFactoryAutoConfiguration</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@AutoConfigureOrder</span>(Ordered.HIGHEST_PRECEDENCE)</span><br><span class="line"><span class="meta">@ConditionalOnClass</span>(ServletRequest<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class">@<span class="title">ConditionalOnWebApplication</span>(<span class="title">type</span> </span>= Type.SERVLET)</span><br><span class="line"><span class="meta">@EnableConfigurationProperties</span>(ServerProperties<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class">// 按顺序加载，所以<span class="title">tomcat</span>优先级最高</span></span><br><span class="line"><span class="class">@<span class="title">Import</span>(</span>&#123; ServletWebServerFactoryAutoConfiguration.BeanPostProcessorsRegistrar<span class="class">.<span class="keyword">class</span>,</span></span><br><span class="line"><span class="class">      <span class="title">ServletWebServerFactoryConfiguration</span>.<span class="title">EmbeddedTomcat</span>.<span class="title">class</span>,</span></span><br><span class="line"><span class="class">      <span class="title">ServletWebServerFactoryConfiguration</span>.<span class="title">EmbeddedJetty</span>.<span class="title">class</span>,</span></span><br><span class="line"><span class="class">      <span class="title">ServletWebServerFactoryConfiguration</span>.<span class="title">EmbeddedUndertow</span>.<span class="title">class</span> &#125;)</span></span><br><span class="line"><span class="class"><span class="title">public</span> <span class="title">class</span> <span class="title">ServletWebServerFactoryAutoConfiguration</span> </span>&#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ServletWebServerFactoryConfiguration</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Configuration</span></span><br><span class="line">	<span class="meta">@ConditionalOnClass</span>(&#123; Servlet<span class="class">.<span class="keyword">class</span>, <span class="title">Tomcat</span>.<span class="title">class</span>, <span class="title">UpgradeProtocol</span>.<span class="title">class</span> &#125;)</span></span><br><span class="line"><span class="class">	@<span class="title">ConditionalOnMissingBean</span>(<span class="title">value</span> </span>= ServletWebServerFactory<span class="class">.<span class="keyword">class</span>, <span class="title">search</span> </span>= SearchStrategy.CURRENT)</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">EmbeddedTomcat</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">		<span class="meta">@Bean</span></span><br><span class="line">		<span class="function"><span class="keyword">public</span> TomcatServletWebServerFactory <span class="title">tomcatServletWebServerFactory</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      <span class="comment">// tomcat工厂类</span></span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">new</span> TomcatServletWebServerFactory();</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> ServletWebServerFactory <span class="title">getWebServerFactory</span><span class="params">()</span> </span>&#123;</span><br><span class="line">   <span class="comment">// Use bean names so that we don't consider the hierarchy</span></span><br><span class="line">   <span class="comment">// 查找tomcatServletWebServerFactory的bean</span></span><br><span class="line">   String[] beanNames = getBeanFactory()</span><br><span class="line">         .getBeanNamesForType(ServletWebServerFactory<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">   <span class="keyword">if</span> (beanNames.length == <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> ApplicationContextException(</span><br><span class="line">            <span class="string">"Unable to start ServletWebServerApplicationContext due to missing "</span></span><br><span class="line">                  + <span class="string">"ServletWebServerFactory bean."</span>);</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">if</span> (beanNames.length &gt; <span class="number">1</span>) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> ApplicationContextException(</span><br><span class="line">            <span class="string">"Unable to start ServletWebServerApplicationContext due to multiple "</span></span><br><span class="line">                  + <span class="string">"ServletWebServerFactory beans : "</span></span><br><span class="line">                  + StringUtils.arrayToCommaDelimitedString(beanNames));</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">return</span> getBeanFactory().getBean(beanNames[<span class="number">0</span>], ServletWebServerFactory<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@FunctionalInterface</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ServletContextInitializer</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Configure the given &#123;<span class="doctag">@link</span> ServletContext&#125; with any servlets, filters, listeners</span></span><br><span class="line"><span class="comment">	 * context-params and attributes necessary for initialization.</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> servletContext the &#123;<span class="doctag">@code</span> ServletContext&#125; to initialize</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@throws</span> ServletException if any call against the given &#123;<span class="doctag">@code</span> ServletContext&#125;</span></span><br><span class="line"><span class="comment">	 * throws a &#123;<span class="doctag">@code</span> ServletException&#125;</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">onStartup</span><span class="params">(ServletContext servletContext)</span> <span class="keyword">throws</span> ServletException</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> org.springframework.boot.web.servlet.<span class="function">ServletContextInitializer <span class="title">getSelfInitializer</span><span class="params">()</span> </span>&#123;</span><br><span class="line">   <span class="comment">// 函数接口，调用onStarup的时候调用的是selfInitialize</span></span><br><span class="line">   <span class="keyword">return</span> <span class="keyword">this</span>::selfInitialize;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">selfInitialize</span><span class="params">(ServletContext servletContext)</span> <span class="keyword">throws</span> ServletException </span>&#123;</span><br><span class="line">   prepareWebApplicationContext(servletContext);</span><br><span class="line">   ConfigurableListableBeanFactory beanFactory = getBeanFactory();</span><br><span class="line">   ExistingWebApplicationScopes existingScopes = <span class="keyword">new</span> ExistingWebApplicationScopes(</span><br><span class="line">         beanFactory);</span><br><span class="line">   WebApplicationContextUtils.registerWebApplicationScopes(beanFactory,</span><br><span class="line">         getServletContext());</span><br><span class="line">   existingScopes.restore();</span><br><span class="line">   WebApplicationContextUtils.registerEnvironmentBeans(beanFactory,</span><br><span class="line">         getServletContext());</span><br><span class="line">   <span class="comment">// 从spring容器里获取ServletContextInitializer bean</span></span><br><span class="line">   <span class="keyword">for</span> (ServletContextInitializer beans : getServletContextInitializerBeans()) &#123;</span><br><span class="line">      <span class="comment">// 将tomcat和spring容器关联</span></span><br><span class="line">      beans.onStartup(servletContext);</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> Collection&lt;ServletContextInitializer&gt; <span class="title">getServletContextInitializerBeans</span><span class="params">()</span> </span>&#123;</span><br><span class="line">   <span class="keyword">return</span> <span class="keyword">new</span> ServletContextInitializerBeans(getBeanFactory());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">ServletContextInitializerBeans</span><span class="params">(ListableBeanFactory beanFactory)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.initializers = <span class="keyword">new</span> LinkedMultiValueMap&lt;&gt;();</span><br><span class="line">    <span class="comment">// 将ServletContextInitializerBean放入initializers</span></span><br><span class="line">		addServletContextInitializerBeans(beanFactory);</span><br><span class="line">		addAdaptableBeans(beanFactory);</span><br><span class="line">		List&lt;ServletContextInitializer&gt; sortedInitializers = <span class="keyword">this</span>.initializers.values()</span><br><span class="line">				.stream()</span><br><span class="line">				.flatMap((value) -&gt; value.stream()</span><br><span class="line">						.sorted(AnnotationAwareOrderComparator.INSTANCE))</span><br><span class="line">				.collect(Collectors.toList());</span><br><span class="line">		<span class="keyword">this</span>.sortedList = Collections.unmodifiableList(sortedInitializers);</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>



<p><strong>实例化并启动tomcat服务器</strong></p>
<p>org.springframework.boot.web.embedded.tomcat.TomcatServletWebServerFactory#getWebServer</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> WebServer <span class="title">getWebServer</span><span class="params">(ServletContextInitializer... initializers)</span> </span>&#123;</span><br><span class="line">   Tomcat tomcat = <span class="keyword">new</span> Tomcat();</span><br><span class="line">   File baseDir = (<span class="keyword">this</span>.baseDirectory != <span class="keyword">null</span>) ? <span class="keyword">this</span>.baseDirectory</span><br><span class="line">         : createTempDir(<span class="string">"tomcat"</span>);</span><br><span class="line">   tomcat.setBaseDir(baseDir.getAbsolutePath());</span><br><span class="line">   Connector connector = <span class="keyword">new</span> Connector(<span class="keyword">this</span>.protocol);</span><br><span class="line">   tomcat.getService().addConnector(connector);</span><br><span class="line">   customizeConnector(connector);</span><br><span class="line">   tomcat.setConnector(connector);</span><br><span class="line">   tomcat.getHost().setAutoDeploy(<span class="keyword">false</span>);</span><br><span class="line">   configureEngine(tomcat.getEngine());</span><br><span class="line">   <span class="keyword">for</span> (Connector additionalConnector : <span class="keyword">this</span>.additionalTomcatConnectors) &#123;</span><br><span class="line">      tomcat.getService().addConnector(additionalConnector);</span><br><span class="line">   &#125;</span><br><span class="line">   prepareContext(tomcat.getHost(), initializers);</span><br><span class="line">   <span class="comment">// TomcatWebServer包装原生tomcat</span></span><br><span class="line">   <span class="keyword">return</span> getTomcatWebServer(tomcat);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>org.springframework.boot.web.embedded.tomcat.TomcatWebServer#initialize</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">initialize</span><span class="params">()</span> <span class="keyword">throws</span> WebServerException </span>&#123;</span><br><span class="line">   TomcatWebServer.logger</span><br><span class="line">         .info(<span class="string">"Tomcat initialized with port(s): "</span> + getPortsDescription(<span class="keyword">false</span>));</span><br><span class="line">   <span class="keyword">synchronized</span> (<span class="keyword">this</span>.monitor) &#123;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">         addInstanceIdToEngineName();</span><br><span class="line"></span><br><span class="line">         Context context = findContext();</span><br><span class="line">         context.addLifecycleListener((event) -&gt; &#123;</span><br><span class="line">            <span class="keyword">if</span> (context.equals(event.getSource())</span><br><span class="line">                  &amp;&amp; Lifecycle.START_EVENT.equals(event.getType())) &#123;</span><br><span class="line">               <span class="comment">// Remove service connectors so that protocol binding doesn't</span></span><br><span class="line">               <span class="comment">// happen when the service is started.</span></span><br><span class="line">               removeServiceConnectors();</span><br><span class="line">            &#125;</span><br><span class="line">         &#125;);</span><br><span class="line"></span><br><span class="line">         <span class="comment">// Start the server to trigger initialization listeners</span></span><br><span class="line">         <span class="keyword">this</span>.tomcat.start();</span><br><span class="line"></span><br><span class="line">         <span class="comment">// We can re-throw failure exception directly in the main thread</span></span><br><span class="line">         rethrowDeferredStartupExceptions();</span><br><span class="line"></span><br><span class="line">         <span class="keyword">try</span> &#123;</span><br><span class="line">            ContextBindings.bindClassLoader(context, context.getNamingToken(),</span><br><span class="line">                  getClass().getClassLoader());</span><br><span class="line">         &#125;</span><br><span class="line">         <span class="keyword">catch</span> (NamingException ex) &#123;</span><br><span class="line">            <span class="comment">// Naming is not enabled. Continue</span></span><br><span class="line">         &#125;</span><br><span class="line"></span><br><span class="line">         <span class="comment">// Unlike Jetty, all Tomcat threads are daemon threads. We create a</span></span><br><span class="line">         <span class="comment">// blocking non-daemon to stop immediate shutdown</span></span><br><span class="line">         startDaemonAwaitThread();</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">         stopSilently();</span><br><span class="line">         <span class="keyword">throw</span> <span class="keyword">new</span> WebServerException(<span class="string">"Unable to start embedded Tomcat"</span>, ex);</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">prepareContext</span><span class="params">(Host host, ServletContextInitializer[] initializers)</span> </span>&#123;</span><br><span class="line">   File documentRoot = getValidDocumentRoot();</span><br><span class="line">   TomcatEmbeddedContext context = <span class="keyword">new</span> TomcatEmbeddedContext();</span><br><span class="line">   <span class="keyword">if</span> (documentRoot != <span class="keyword">null</span>) &#123;</span><br><span class="line">      context.setResources(<span class="keyword">new</span> LoaderHidingResourceRoot(context));</span><br><span class="line">   &#125;</span><br><span class="line">   context.setName(getContextPath());</span><br><span class="line">   context.setDisplayName(getDisplayName());</span><br><span class="line">   context.setPath(getContextPath());</span><br><span class="line">   File docBase = (documentRoot != <span class="keyword">null</span>) ? documentRoot</span><br><span class="line">         : createTempDir(<span class="string">"tomcat-docbase"</span>);</span><br><span class="line">   context.setDocBase(docBase.getAbsolutePath());</span><br><span class="line">   context.addLifecycleListener(<span class="keyword">new</span> FixContextListener());</span><br><span class="line">   context.setParentClassLoader(</span><br><span class="line">         (<span class="keyword">this</span>.resourceLoader != <span class="keyword">null</span>) ? <span class="keyword">this</span>.resourceLoader.getClassLoader()</span><br><span class="line">               : ClassUtils.getDefaultClassLoader());</span><br><span class="line">   resetDefaultLocaleMapping(context);</span><br><span class="line">   addLocaleMappings(context);</span><br><span class="line">   context.setUseRelativeRedirects(<span class="keyword">false</span>);</span><br><span class="line">   configureTldSkipPatterns(context);</span><br><span class="line">   WebappLoader loader = <span class="keyword">new</span> WebappLoader(context.getParentClassLoader());</span><br><span class="line">   loader.setLoaderClass(TomcatEmbeddedWebappClassLoader<span class="class">.<span class="keyword">class</span>.<span class="title">getName</span>())</span>;</span><br><span class="line">   loader.setDelegate(<span class="keyword">true</span>);</span><br><span class="line">   context.setLoader(loader);</span><br><span class="line">   <span class="keyword">if</span> (isRegisterDefaultServlet()) &#123;</span><br><span class="line">      addDefaultServlet(context);</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">if</span> (shouldRegisterJspServlet()) &#123;</span><br><span class="line">      addJspServlet(context);</span><br><span class="line">      addJasperInitializer(context);</span><br><span class="line">   &#125;</span><br><span class="line">   context.addLifecycleListener(<span class="keyword">new</span> StaticResourceConfigurer(context));</span><br><span class="line">   ServletContextInitializer[] initializersToUse = mergeInitializers(initializers);</span><br><span class="line">   host.addChild(context);</span><br><span class="line">   <span class="comment">// 实例化TomcatStarter，org.springframework.boot.web.embedded.tomcat.TomcatStarter#TomcatStarter，并发initilizer放到tomcatStarter</span></span><br><span class="line">   configureContext(context, initializersToUse);</span><br><span class="line">   postProcessContext(context);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>tomcat启动的时候，org.apache.catalina.core.StandardContext#startInternal-&gt;org.springframework.boot.web.embedded.tomcat.TomcatStarter#onStartup，servlet初始化</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onStartup</span><span class="params">(Set&lt;Class&lt;?&gt;&gt; classes, ServletContext servletContext)</span></span></span><br><span class="line"><span class="function">      <span class="keyword">throws</span> ServletException </span>&#123;</span><br><span class="line">   <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">for</span> (ServletContextInitializer initializer : <span class="keyword">this</span>.initializers) &#123;</span><br><span class="line">         initializer.onStartup(servletContext);</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">      <span class="keyword">this</span>.startUpException = ex;</span><br><span class="line">      <span class="comment">// Prevent Tomcat from logging and re-throwing when we know we can</span></span><br><span class="line">      <span class="comment">// deal with it in the main thread, but log for information here.</span></span><br><span class="line">      <span class="keyword">if</span> (logger.isErrorEnabled()) &#123;</span><br><span class="line">         logger.error(<span class="string">"Error starting Tomcat context. Exception: "</span></span><br><span class="line">               + ex.getClass().getName() + <span class="string">". Message: "</span> + ex.getMessage());</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="自动配置"><a href="#自动配置" class="headerlink" title="自动配置"></a>自动配置</h2><p>根据import注解，导入第三方组件到spring容器，第三方组件要有自动配置类</p>
<p>例如mybatis</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">org.springframework.boot.autoconfigure.EnableAutoConfiguration=\</span><br><span class="line">org.mybatis.spring.boot.autoconfigure.MybatisAutoConfiguration</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@ConditionalOnClass</span>(&#123; SqlSessionFactory<span class="class">.<span class="keyword">class</span>, <span class="title">SqlSessionFactoryBean</span>.<span class="title">class</span> &#125;)</span></span><br><span class="line"><span class="class">@<span class="title">ConditionalOnBean</span>(<span class="title">DataSource</span>.<span class="title">class</span>)</span></span><br><span class="line"><span class="class">@<span class="title">EnableConfigurationProperties</span>(<span class="title">MybatisProperties</span>.<span class="title">class</span>)</span></span><br><span class="line"><span class="class">@<span class="title">AutoConfigureAfter</span>(<span class="title">DataSourceAutoConfiguration</span>.<span class="title">class</span>)</span></span><br><span class="line"><span class="class"><span class="title">public</span> <span class="title">class</span> <span class="title">MybatisAutoConfiguration</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger logger = LoggerFactory.getLogger(MybatisAutoConfiguration<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> MybatisProperties properties;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> Interceptor[] interceptors;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> ResourceLoader resourceLoader;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> DatabaseIdProvider databaseIdProvider;</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="SpringBoosApplication注解"><a href="#SpringBoosApplication注解" class="headerlink" title="@SpringBoosApplication注解"></a>@SpringBoosApplication注解</h3><p>根据import注解，解析META-INF/spring.factories文件，导入第三方组件的启动类xxxx（<strong>org.springframework.boot.autoconfigure.EnableAutoConfiguration</strong>=xxxx）</p>
<p>@SpringBootApplication-&gt;@EnableAutoConfiguration-&gt;<strong>@Import(AutoConfigurationImportSelector.class</strong>)</p>
<p>org.springframework.boot.autoconfigure.AutoConfigurationImportSelector#selectImports</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 返回包里所有的org.springframework.boot.autoconfigure.EnableAutoConfiguration实现类的类名，由spring生成bd和bean	</span></span><br><span class="line"><span class="keyword">public</span> String[] selectImports(AnnotationMetadata annotationMetadata) &#123;</span><br><span class="line">		<span class="keyword">if</span> (!isEnabled(annotationMetadata)) &#123;</span><br><span class="line">			<span class="keyword">return</span> NO_IMPORTS;</span><br><span class="line">		&#125;</span><br><span class="line">		AutoConfigurationMetadata autoConfigurationMetadata = AutoConfigurationMetadataLoader</span><br><span class="line">				.loadMetadata(<span class="keyword">this</span>.beanClassLoader);</span><br><span class="line">		AnnotationAttributes attributes = getAttributes(annotationMetadata);</span><br><span class="line">    <span class="comment">// 解析META-INF/spring.factories文件，找到候选的配置类，key为org.springframework.boot.autoconfigure.EnableAutoConfiguration</span></span><br><span class="line">		List&lt;String&gt; configurations = getCandidateConfigurations(annotationMetadata,</span><br><span class="line">				attributes);</span><br><span class="line">    <span class="comment">// 去重</span></span><br><span class="line">		configurations = removeDuplicates(configurations);</span><br><span class="line">		Set&lt;String&gt; exclusions = getExclusions(annotationMetadata, attributes);</span><br><span class="line">		checkExcludedClasses(configurations, exclusions);</span><br><span class="line">    <span class="comment">// 剔除不需要的类</span></span><br><span class="line">		configurations.removeAll(exclusions);</span><br><span class="line">    <span class="comment">// 过滤类</span></span><br><span class="line">		configurations = filter(configurations, autoConfigurationMetadata);</span><br><span class="line">    <span class="comment">// 先从spring.factories文件中找到监听器org.springframework.boot.autoconfigure.AutoConfigurationImportListener，然后触发该事件</span></span><br><span class="line">		fireAutoConfigurationImportEvents(configurations, exclusions);</span><br><span class="line">		<span class="keyword">return</span> StringUtils.toStringArray(configurations);</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> List&lt;String&gt; <span class="title">getCandidateConfigurations</span><span class="params">(AnnotationMetadata metadata,</span></span></span><br><span class="line"><span class="function"><span class="params">      AnnotationAttributes attributes)</span> </span>&#123;</span><br><span class="line">   List&lt;String&gt; configurations = SpringFactoriesLoader.loadFactoryNames(</span><br><span class="line">         getSpringFactoriesLoaderFactoryClass(), getBeanClassLoader());</span><br><span class="line">   Assert.notEmpty(configurations,</span><br><span class="line">         <span class="string">"No auto configuration classes found in META-INF/spring.factories. If you "</span></span><br><span class="line">               + <span class="string">"are using a custom packaging, make sure that file is correct."</span>);</span><br><span class="line">   <span class="keyword">return</span> configurations;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> List&lt;String&gt; <span class="title">loadFactoryNames</span><span class="params">(Class&lt;?&gt; factoryClass, @Nullable ClassLoader classLoader)</span> </span>&#123;</span><br><span class="line">   String factoryClassName = factoryClass.getName();</span><br><span class="line">   <span class="keyword">return</span> loadSpringFactories(classLoader).getOrDefault(factoryClassName, Collections.emptyList());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> Map&lt;String, List&lt;String&gt;&gt; loadSpringFactories(<span class="meta">@Nullable</span> ClassLoader classLoader) &#123;</span><br><span class="line">   MultiValueMap&lt;String, String&gt; result = cache.get(classLoader);</span><br><span class="line">   <span class="keyword">if</span> (result != <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> result;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">try</span> &#123;</span><br><span class="line">     <span class="comment">// FACTORIES_RESOURCE_LOCATION=META-INF/spring.factories</span></span><br><span class="line">      Enumeration&lt;URL&gt; urls = (classLoader != <span class="keyword">null</span> ?</span><br><span class="line">            classLoader.getResources(FACTORIES_RESOURCE_LOCATION) :</span><br><span class="line">            ClassLoader.getSystemResources(FACTORIES_RESOURCE_LOCATION));</span><br><span class="line">      result = <span class="keyword">new</span> LinkedMultiValueMap&lt;&gt;();</span><br><span class="line">      <span class="comment">// 扫描所有spring.factories文件，将文件内容放入LinkedMultiValueMap中</span></span><br><span class="line">      <span class="keyword">while</span> (urls.hasMoreElements()) &#123;</span><br><span class="line">         URL url = urls.nextElement();</span><br><span class="line">         UrlResource resource = <span class="keyword">new</span> UrlResource(url);</span><br><span class="line">         Properties properties = PropertiesLoaderUtils.loadProperties(resource);</span><br><span class="line">         <span class="keyword">for</span> (Map.Entry&lt;?, ?&gt; entry : properties.entrySet()) &#123;</span><br><span class="line">            List&lt;String&gt; factoryClassNames = Arrays.asList(</span><br><span class="line">                  StringUtils.commaDelimitedListToStringArray((String) entry.getValue()));</span><br><span class="line">            result.addAll((String) entry.getKey(), factoryClassNames);</span><br><span class="line">         &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      cache.put(classLoader, result);</span><br><span class="line">      <span class="keyword">return</span> result;</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">catch</span> (IOException ex) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Unable to load factories from location ["</span> +</span><br><span class="line">            FACTORIES_RESOURCE_LOCATION + <span class="string">"]"</span>, ex);</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">fireAutoConfigurationImportEvents</span><span class="params">(List&lt;String&gt; configurations,</span></span></span><br><span class="line"><span class="function"><span class="params">      Set&lt;String&gt; exclusions)</span> </span>&#123;</span><br><span class="line">   List&lt;AutoConfigurationImportListener&gt; listeners = getAutoConfigurationImportListeners();</span><br><span class="line">   <span class="keyword">if</span> (!listeners.isEmpty()) &#123;</span><br><span class="line">      AutoConfigurationImportEvent event = <span class="keyword">new</span> AutoConfigurationImportEvent(<span class="keyword">this</span>,</span><br><span class="line">            configurations, exclusions);</span><br><span class="line">      <span class="keyword">for</span> (AutoConfigurationImportListener listener : listeners) &#123;</span><br><span class="line">         invokeAwareMethods(listener);</span><br><span class="line">         listener.onAutoConfigurationImportEvent(event);</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<h2 id="自动配置注入dispatcherServlet"><a href="#自动配置注入dispatcherServlet" class="headerlink" title="自动配置注入dispatcherServlet"></a>自动配置注入dispatcherServlet</h2><p><strong>springboot是先把dispatcherServlet bean注入到spring容器，而springmvc不需要</strong></p>
<p>注入的DispatcherServletRegistrationBean，继承了ServletContextInitializer，能被启动服务器流程调用</p>
<p>spring.factories</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">org.springframework.boot.autoconfigure.EnableAutoConfiguration=org.springframework.boot.autoconfigure.web.servlet.DispatcherServletAutoConfiguration</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@AutoConfigureOrder</span>(Ordered.HIGHEST_PRECEDENCE)</span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@ConditionalOnWebApplication</span>(type = Type.SERVLET)</span><br><span class="line"><span class="meta">@ConditionalOnClass</span>(DispatcherServlet<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class">@<span class="title">AutoConfigureAfter</span>(<span class="title">ServletWebServerFactoryAutoConfiguration</span>.<span class="title">class</span>)</span></span><br><span class="line"><span class="class">@<span class="title">EnableConfigurationProperties</span>(<span class="title">ServerProperties</span>.<span class="title">class</span>)</span></span><br><span class="line"><span class="class"><span class="title">public</span> <span class="title">class</span> <span class="title">DispatcherServletAutoConfiguration</span> </span>&#123;</span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">  <span class="meta">@Configuration</span></span><br><span class="line">	<span class="meta">@Conditional</span>(DispatcherServletRegistrationCondition<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class">	@<span class="title">ConditionalOnClass</span>(<span class="title">ServletRegistration</span>.<span class="title">class</span>)</span></span><br><span class="line"><span class="class">	@<span class="title">EnableConfigurationProperties</span>(<span class="title">WebMvcProperties</span>.<span class="title">class</span>)</span></span><br><span class="line"><span class="class">	@<span class="title">Import</span>(<span class="title">DispatcherServletConfiguration</span>.<span class="title">class</span>)</span></span><br><span class="line"><span class="class">	<span class="title">protected</span> <span class="title">static</span> <span class="title">class</span> <span class="title">DispatcherServletRegistrationConfiguration</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">      <span class="comment">// 注入DispatcherServletRegistrationBean，这个bean继承了</span></span><br><span class="line">      <span class="meta">@Bean</span>(name = DEFAULT_DISPATCHER_SERVLET_REGISTRATION_BEAN_NAME)</span><br><span class="line">      <span class="meta">@ConditionalOnBean</span>(value = DispatcherServlet<span class="class">.<span class="keyword">class</span>, <span class="title">name</span> </span>= DEFAULT_DISPATCHER_SERVLET_BEAN_NAME)</span><br><span class="line">      <span class="function"><span class="keyword">public</span> DispatcherServletRegistrationBean <span class="title">dispatcherServletRegistration</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">          DispatcherServlet dispatcherServlet)</span> </span>&#123;</span><br><span class="line">        DispatcherServletRegistrationBean registration = <span class="keyword">new</span> DispatcherServletRegistrationBean(</span><br><span class="line">            dispatcherServlet, <span class="keyword">this</span>.serverProperties.getServlet().getPath());</span><br><span class="line">        registration.setName(DEFAULT_DISPATCHER_SERVLET_BEAN_NAME);</span><br><span class="line">        registration.setLoadOnStartup(</span><br><span class="line">            <span class="keyword">this</span>.webMvcProperties.getServlet().getLoadOnStartup());</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.multipartConfig != <span class="keyword">null</span>) &#123;</span><br><span class="line">          registration.setMultipartConfig(<span class="keyword">this</span>.multipartConfig);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> registration;</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">  <span class="meta">@Configuration</span></span><br><span class="line">	<span class="meta">@Conditional</span>(DefaultDispatcherServletCondition<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class">	@<span class="title">ConditionalOnClass</span>(<span class="title">ServletRegistration</span>.<span class="title">class</span>)</span></span><br><span class="line"><span class="class">	@<span class="title">EnableConfigurationProperties</span>(<span class="title">WebMvcProperties</span>.<span class="title">class</span>)</span></span><br><span class="line"><span class="class">	<span class="title">protected</span> <span class="title">static</span> <span class="title">class</span> <span class="title">DispatcherServletConfiguration</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">private</span> <span class="keyword">final</span> WebMvcProperties webMvcProperties;</span><br><span class="line"></span><br><span class="line">		<span class="function"><span class="keyword">public</span> <span class="title">DispatcherServletConfiguration</span><span class="params">(WebMvcProperties webMvcProperties)</span> </span>&#123;</span><br><span class="line">			<span class="keyword">this</span>.webMvcProperties = webMvcProperties;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 注入dispatcherServlet bean</span></span><br><span class="line">		<span class="meta">@Bean</span>(name = DEFAULT_DISPATCHER_SERVLET_BEAN_NAME)</span><br><span class="line">		<span class="function"><span class="keyword">public</span> DispatcherServlet <span class="title">dispatcherServlet</span><span class="params">()</span> </span>&#123;</span><br><span class="line">			DispatcherServlet dispatcherServlet = <span class="keyword">new</span> DispatcherServlet();</span><br><span class="line">			dispatcherServlet.setDispatchOptionsRequest(</span><br><span class="line">					<span class="keyword">this</span>.webMvcProperties.isDispatchOptionsRequest());</span><br><span class="line">			dispatcherServlet.setDispatchTraceRequest(</span><br><span class="line">					<span class="keyword">this</span>.webMvcProperties.isDispatchTraceRequest());</span><br><span class="line">			dispatcherServlet.setThrowExceptionIfNoHandlerFound(</span><br><span class="line">					<span class="keyword">this</span>.webMvcProperties.isThrowExceptionIfNoHandlerFound());</span><br><span class="line">			<span class="keyword">return</span> dispatcherServlet;</span><br><span class="line">		&#125;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://github.com/garydai/garydai.github.com/raw/master/_posts/pic/image-20191225162114063.png" alt="image-20191225162114063"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">onStartup</span><span class="params">(ServletContext servletContext)</span> <span class="keyword">throws</span> ServletException </span>&#123;</span><br><span class="line">   String description = getDescription();</span><br><span class="line">   <span class="keyword">if</span> (!isEnabled()) &#123;</span><br><span class="line">      logger.info(StringUtils.capitalize(description)</span><br><span class="line">            + <span class="string">" was not registered (disabled)"</span>);</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">   &#125;</span><br><span class="line">   register(description, servletContext);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">register</span><span class="params">(String description, ServletContext servletContext)</span> </span>&#123;</span><br><span class="line">   D registration = addRegistration(description, servletContext);</span><br><span class="line">   <span class="keyword">if</span> (registration == <span class="keyword">null</span>) &#123;</span><br><span class="line">      logger.info(StringUtils.capitalize(description) + <span class="string">" was not registered "</span></span><br><span class="line">            + <span class="string">"(possibly already registered?)"</span>);</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">   &#125;</span><br><span class="line">   configure(registration);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 将dispatcherServlet设置到tomcat的context里，作为一个分发请求的servlet</span></span><br><span class="line"><span class="keyword">protected</span> ServletRegistration.<span class="function">Dynamic <span class="title">addRegistration</span><span class="params">(String description,</span></span></span><br><span class="line"><span class="function"><span class="params">                                                      ServletContext servletContext)</span> </span>&#123;</span><br><span class="line">  String name = getServletName();</span><br><span class="line">  logger.info(<span class="string">"Servlet "</span> + name + <span class="string">" mapped to "</span> + <span class="keyword">this</span>.urlMappings);</span><br><span class="line">  <span class="keyword">return</span> servletContext.addServlet(name, <span class="keyword">this</span>.servlet);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(ServletRegistration.Dynamic registration)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">super</span>.configure(registration);</span><br><span class="line">		String[] urlMapping = StringUtils.toStringArray(<span class="keyword">this</span>.urlMappings);</span><br><span class="line">		<span class="keyword">if</span> (urlMapping.length == <span class="number">0</span> &amp;&amp; <span class="keyword">this</span>.alwaysMapUrl) &#123;</span><br><span class="line">			urlMapping = DEFAULT_MAPPINGS;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (!ObjectUtils.isEmpty(urlMapping)) &#123;</span><br><span class="line">			registration.addMapping(urlMapping);</span><br><span class="line">		&#125;</span><br><span class="line">		registration.setLoadOnStartup(<span class="keyword">this</span>.loadOnStartup);</span><br><span class="line">		<span class="keyword">if</span> (<span class="keyword">this</span>.multipartConfig != <span class="keyword">null</span>) &#123;</span><br><span class="line">			registration.setMultipartConfig(<span class="keyword">this</span>.multipartConfig);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>

<p>dispatcherServlet 实现了ApplicationContextAware接口，在org.springframework.web.servlet.FrameworkServlet#setApplicationContext中设置了spring上下文</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setApplicationContext</span><span class="params">(ApplicationContext applicationContext)</span> </span>&#123;</span><br><span class="line">   <span class="keyword">if</span> (<span class="keyword">this</span>.webApplicationContext == <span class="keyword">null</span> &amp;&amp; applicationContext <span class="keyword">instanceof</span> WebApplicationContext) &#123;</span><br><span class="line">      <span class="keyword">this</span>.webApplicationContext = (WebApplicationContext) applicationContext;</span><br><span class="line">      <span class="keyword">this</span>.webApplicationContextInjected = <span class="keyword">true</span>;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>所以说dispatcherServlet bean要先在spring容器里面，再利用后置处理器设置上下文，而springmvc的dispatcherServlet则不需要再spring容器</p>
<h2 id="自动配置WebMvcAutoConfiguration"><a href="#自动配置WebMvcAutoConfiguration" class="headerlink" title="自动配置WebMvcAutoConfiguration"></a>自动配置WebMvcAutoConfiguration</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 搜集messageConvertersProvider消息转换器等bean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">WebMvcAutoConfigurationAdapter</span><span class="params">(ResourceProperties resourceProperties,</span></span></span><br><span class="line"><span class="function"><span class="params">      WebMvcProperties mvcProperties, ListableBeanFactory beanFactory,</span></span></span><br><span class="line"><span class="function"><span class="params">      ObjectProvider&lt;HttpMessageConverters&gt; messageConvertersProvider,</span></span></span><br><span class="line"><span class="function"><span class="params">      ObjectProvider&lt;ResourceHandlerRegistrationCustomizer&gt; resourceHandlerRegistrationCustomizerProvider)</span> </span>&#123;</span><br><span class="line">   <span class="keyword">this</span>.resourceProperties = resourceProperties;</span><br><span class="line">   <span class="keyword">this</span>.mvcProperties = mvcProperties;</span><br><span class="line">   <span class="keyword">this</span>.beanFactory = beanFactory;</span><br><span class="line">   <span class="keyword">this</span>.messageConvertersProvider = messageConvertersProvider;</span><br><span class="line">   <span class="keyword">this</span>.resourceHandlerRegistrationCustomizer = resourceHandlerRegistrationCustomizerProvider</span><br><span class="line">         .getIfAvailable();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>视图解析器</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="meta">@ConditionalOnBean</span>(ViewResolver<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class">@<span class="title">ConditionalOnMissingBean</span>(<span class="title">name</span> </span>= <span class="string">"viewResolver"</span>, value = ContentNegotiatingViewResolver<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class"><span class="title">public</span> <span class="title">ContentNegotiatingViewResolver</span> <span class="title">viewResolver</span>(<span class="title">BeanFactory</span> <span class="title">beanFactory</span>) </span>&#123;</span><br><span class="line">   ContentNegotiatingViewResolver resolver = <span class="keyword">new</span> ContentNegotiatingViewResolver();</span><br><span class="line">   resolver.setContentNegotiationManager(</span><br><span class="line">         beanFactory.getBean(ContentNegotiationManager<span class="class">.<span class="keyword">class</span>))</span>;</span><br><span class="line">   <span class="comment">// ContentNegotiatingViewResolver uses all the other view resolvers to locate</span></span><br><span class="line">   <span class="comment">// a view so it should have a high precedence</span></span><br><span class="line">   resolver.setOrder(Ordered.HIGHEST_PRECEDENCE);</span><br><span class="line">   <span class="keyword">return</span> resolver;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">initServletContext</span><span class="params">(ServletContext servletContext)</span> </span>&#123;</span><br><span class="line">   Collection&lt;ViewResolver&gt; matchingBeans =</span><br><span class="line">         BeanFactoryUtils.beansOfTypeIncludingAncestors(obtainApplicationContext(), ViewResolver<span class="class">.<span class="keyword">class</span>).<span class="title">values</span>()</span>;</span><br><span class="line">   <span class="keyword">if</span> (<span class="keyword">this</span>.viewResolvers == <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="keyword">this</span>.viewResolvers = <span class="keyword">new</span> ArrayList&lt;&gt;(matchingBeans.size());</span><br><span class="line">      <span class="keyword">for</span> (ViewResolver viewResolver : matchingBeans) &#123;</span><br><span class="line">         <span class="keyword">if</span> (<span class="keyword">this</span> != viewResolver) &#123;</span><br><span class="line">            <span class="keyword">this</span>.viewResolvers.add(viewResolver);</span><br><span class="line">         &#125;</span><br><span class="line">      &#125;</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="keyword">this</span>.viewResolvers.size(); i++) &#123;</span><br><span class="line">         ViewResolver vr = <span class="keyword">this</span>.viewResolvers.get(i);</span><br><span class="line">         <span class="keyword">if</span> (matchingBeans.contains(vr)) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">         &#125;</span><br><span class="line">         String name = vr.getClass().getName() + i;</span><br><span class="line">         obtainApplicationContext().getAutowireCapableBeanFactory().initializeBean(vr, name);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">if</span> (<span class="keyword">this</span>.viewResolvers.isEmpty()) &#123;</span><br><span class="line">      logger.warn(<span class="string">"Did not find any ViewResolvers to delegate to; please configure them using the "</span> +</span><br><span class="line">            <span class="string">"'viewResolvers' property on the ContentNegotiatingViewResolver"</span>);</span><br><span class="line">   &#125;</span><br><span class="line">   AnnotationAwareOrderComparator.sort(<span class="keyword">this</span>.viewResolvers);</span><br><span class="line">   <span class="keyword">this</span>.cnmFactoryBean.setServletContext(servletContext);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2018/01/23/2018-1-23-spring%20boot/" data-id="ck521h1bb0079lc7ka2gaedpn" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  


  <nav id="page-nav">
    
    <a class="extend prev" rel="prev" href="/page/9/">&amp;laquo; Prev</a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/8/">8</a><a class="page-number" href="/page/9/">9</a><span class="page-number current">10</span><a class="page-number" href="/page/11/">11</a><a class="page-number" href="/page/12/">12</a><span class="space">&hellip;</span><a class="page-number" href="/page/28/">28</a><a class="extend next" rel="next" href="/page/11/">Next &amp;raquo;</a>
  </nav>

</section>
        
          <aside id="sidebar">
  
    

  
    

  
    
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/01/">January 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/12/">December 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/11/">November 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/10/">October 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/09/">September 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/08/">August 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/07/">July 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/06/">June 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/05/">May 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/04/">April 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/03/">March 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/02/">February 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/01/">January 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/11/">November 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/08/">August 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/07/">July 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/06/">June 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/05/">May 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/04/">April 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/03/">March 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/01/">January 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/12/">December 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/08/">August 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/07/">July 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/06/">June 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/05/">May 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/04/">April 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/03/">March 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/02/">February 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/01/">January 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/12/">December 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/11/">November 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/10/">October 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/09/">September 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/05/">May 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/03/">March 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/12/">December 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/10/">October 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/09/">September 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/07/">July 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/06/">June 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/04/">April 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/03/">March 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/02/">February 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/01/">January 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/12/">December 2014</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/11/">November 2014</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/09/">September 2014</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/08/">August 2014</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/07/">July 2014</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/06/">June 2014</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/05/">May 2014</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/04/">April 2014</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/03/">March 2014</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/02/">February 2014</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/12/">December 2013</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/10/">October 2013</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/09/">September 2013</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/08/">August 2013</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/07/">July 2013</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/06/">June 2013</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/05/">May 2013</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2013/04/">April 2013</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2020/01/06/2018-6-3-%E4%BB%A3%E7%A0%81%E8%A7%84%E8%8C%83/">2018-6-3-代码规范</a>
          </li>
        
          <li>
            <a href="/2020/01/05/2020-1-5-datax/">离线同步工具DataX</a>
          </li>
        
          <li>
            <a href="/2019/12/31/2019-12-31-replicate/">分布式系统数据同步</a>
          </li>
        
          <li>
            <a href="/2019/12/28/2019-12-28-LCH/">LCH</a>
          </li>
        
          <li>
            <a href="/2019/12/26/2019-12-26-lambda/">lambda</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2020 John Doe<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  
<link rel="stylesheet" href="/fancybox/jquery.fancybox.css">

  
<script src="/fancybox/jquery.fancybox.pack.js"></script>




<script src="/js/script.js"></script>




  </div>
</body>
</html>