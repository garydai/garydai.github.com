<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="en">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT" />










<meta property="og:type" content="website">
<meta property="og:title" content="Hexo">
<meta property="og:url" content="http://yoursite.com/page/20/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="John Doe">
<meta name="twitter:card" content="summary">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/page/20/"/>





  <title>Hexo</title>
  








<meta name="generator" content="Hexo 4.2.0"></head>

<body itemscope itemtype="http://schema.org/WebPage" lang="en">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Hexo</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/%20" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/%20" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            Archives
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2015/07/02/2015-7-2-newsfeed/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2015/07/02/2015-7-2-newsfeed/" itemprop="url">社交网络的feed系统</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2015-07-02T00:00:00+08:00">
                2015-07-02
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>##newsfeed</p>
<p><a href="https://github.com/tschellenbach/Stream-Framework" target="_blank" rel="noopener">https://github.com/tschellenbach/Stream-Framework</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2015/06/19/2015-6-19-dto/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2015/06/19/2015-6-19-dto/" itemprop="url">dto</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2015-06-19T00:00:00+08:00">
                2015-06-19
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>##dto</p>
<p>data transfer object</p>
<p><a href="http://www.cnblogs.com/loveis715/p/4379656.html" target="_blank" rel="noopener">http://www.cnblogs.com/loveis715/p/4379656.html</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2015/06/05/2015-6-5-cgi/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2015/06/05/2015-6-5-cgi/" itemprop="url">cgi与web服务器与web应用</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2015-06-05T00:00:00+08:00">
                2015-06-05
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>##cgi</p>
<p>common gateway interface</p>
<p><img src="https://github.com/garydai/garydai.github.com/raw/master/_posts/pic/cgi.png" alt=""></p>
<p><img src="https://github.com/garydai/garydai.github.com/raw/master/_posts/pic/image-20191017105915972.png" alt="image-20191017105915972"></p>
<p>cgi作为一个中间分子，桥梁web server和php，但是每次连接都会fork一个进程，Fork-and-execute</p>
<h3 id="fastcgi"><a href="#fastcgi" class="headerlink" title="fastcgi"></a>fastcgi</h3><p><img src="https://github.com/garydai/garydai.github.com/raw/master/_posts/pic/image-20191017151702929.png" alt="image-20191017151702929"></p>
<ol>
<li>Web Server启动时载入FastCGI进程管理器（Apache Module或IIS ISAPI等)</li>
<li>FastCGI进程管理器自身初始化，启动多个CGI解释器进程(可建多个php-cgi)，并等待来自Web Server的连接。</li>
<li>当客户端请求到达Web Server时，FastCGI进程管理器选择并连接到一个CGI解释器。Web server将CGI环境变量和标准输入发送到FastCGI子进程php-cgi。</li>
<li>FastCGI子进程完成处理后，将标准输出和错误信息从同一连接返回Web Server。当FastCGI子进程关闭连接时，请求便告处理完成。FastCGI子进程接着等待，并处理来自FastCGI进程管理器(运行在Web Server中)的下一个连接。 在CGI模式中，php-cgi在此便退出了。</li>
</ol>
<h3 id="php-fpm"><a href="#php-fpm" class="headerlink" title="php-fpm"></a>php-fpm</h3><p>PHP-CGI是PHP实现FastCGI协议的程序</p>
<p>PHP-FPM 是对于 FastCGI 协议的具体实现，他负责管理一个进程池，来处理来自Web服务器的请求。</p>
<p>因为PHP-CGI只是个CGI程序，他自己本身只能解析请求，返回结果，不会进程管理。所以就出现了一些能够调度 php-cgi 进程的程序，比如说由lighthttpd分离出来的spawn-fcgi。同样，PHP-FPM也是用于调度管理PHP解析器php-cgi的管理程序。</p>
<p><img src="https://github.com/garydai/garydai.github.com/raw/master/_posts/pic/image-20191017152416580.png" alt="image-20191017152416580"></p>
<h2 id="reference"><a href="#reference" class="headerlink" title="reference"></a>reference</h2><p><a href="https://mengkang.net/668.html" target="_blank" rel="noopener">https://mengkang.net/668.html</a></p>
<p><a href="https://www.awaimai.com/371.html" target="_blank" rel="noopener">https://www.awaimai.com/371.html</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2015/04/16/2015-4-16-interview/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2015/04/16/2015-4-16-interview/" itemprop="url">面试题</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2015-04-16T00:00:00+08:00">
                2015-04-16
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>##面试题</p>
<p>1.题目：输入一棵二元查找树，将该二元查找树转换成一个排序的双向链表。要求不能创建任何新的结点，只调整指针的指向。</p>
<p>2.题目：求1+2+…+n，要求不能使用乘除法、for、while、if、else、switch、case等关键字以及条件判断语句（A?B:C）。</p>
<p>3.题目：输入一个单向链表，输出该链表中倒数第k个结点。链表的倒数第0个结点为链表的尾指针。</p>
<p>4.题目：输入一个已经按升序排序过的数组和一个数字，在数组中查找两个数，使得它们的和正好是输入的那个数字。要求时间复杂度是O(n)。如果有多对数字的和等于输入的数字，输出任意一对即可。</p>
<p>例如输入数组1、2、4、7、11、15和数字15。由于4+11=15，因此输出4和11。</p>
<p>5.题目：在一个字符串中找到第一个只出现一次的字符。如输入abaccdeff，则输出b。</p>
<p>6.题目：n个数字（0,1,…,n-1）形成一个圆圈，从数字0开始，每次从这个圆圈中删除第m个数字（第一个为当前数字本身，第二个为当前数字的下一个数字）。当一个数字删除后，从被删除数字的下一个继续删除第m个数字。求出在这个圆圈中剩下的最后一个数字。</p>
<p>7.题目：定义Fibonacci数列如下：</p>
<pre><code>        /  0                      n=0
f(n)=      1                      n=1
        \  f(n-1)+f(n-2)          n=2</code></pre><p>输入n，用最快的方法求该数列的第n项。</p>
<p>8.题目：输入一个字符串，打印出该字符串中字符的所有排列。例如输入字符串abc，则输出由字符a、b、c所能排列出来的所有字符串abc、acb、bac、bca、cab和cba。</p>
<p>扩展1：如果不是求字符的所有排列，而是求字符的所有组合，应该怎么办呢？当输入的字符串中含有相同的字符串时，相同的字符交换位置是不同的排列，但是同一个组合。举个例子，如果输入abc，它的组合有a、b、c、ab、ac、bc、abc。</p>
<p>扩展2：输入一个含有8个数字的数组，判断有没有可能把这8个数字分别放到正方体的8个顶点上，使得正方体上三组相对的面上的4个顶点的和相等。</p>
<p>9.题目：输入一棵二元树的根结点，求该树的深度。从根结点到叶结点依次经过的结点（含根、叶结点）形成树的一条路径，最长路径的长度为树的深度。</p>
<p>10.题目：输入一个正数n，输出所有和为n连续正数序列。(O(logn))</p>
<p>例如输入15，由于1+2+3+4+5=4+5+6=7+8=15，所以输出3个连续序列1-5、4-6和7-8。</p>
<p>11.题目：输入一个整数n，求从1到n这n个整数的十进制表示中1出现的次数。</p>
<p>例如输入12，从1到12这些整数中包含1 的数字有1，10，11和12，1一共出现了5次。</p>
<p>12.题目：输入一个正整数数组，将它们连接起来排成一个数，输出能排出的所有数字中最小的一个。例如输入数组{32,  321}，则输出这两个能排成的最小数字32132。请给出解决问题的算法，并证明该算法。</p>
<p>13.题目：输入两个字符串，从第一字符串中删除第二个字符串中所有的字符。例如，输入”They are students.”和”aeiou”，则删除之后的第一个字符串变成”Thy r stdnts.”。</p>
<p>14.题目：输入一个字符串，输出该字符串中对称的子字符串的最大长度。比如输入字符串“google”，由于该字符串里最长的对称子字符串是“goog”，因此输出4。</p>
<p>15.题目：数组中有一个数字出现的次数超过了数组长度的一半，找出这个数字。</p>
<p>16.题目：二叉树的结点定义如下：</p>
<pre><code>struct TreeNode
{
    int m_nvalue;
    TreeNode* m_pLeft;
    TreeNode* m_pRight;
};</code></pre><p>输入二叉树中的两个结点，输出这两个结点在数中最低的共同父结点。</p>
<hr>
<p>1.1 中序遍历，保存节点，遍历节点改变指针指向</p>
<p>1.2 边遍历边调整指针指向</p>
<p>2.1.构造函数</p>
<p>2.2.递归，0的时候如何返回是难点</p>
<p>3.双指针</p>
<p>4.数组两边向中间靠拢</p>
<p>5.哈希</p>
<p>6.递归</p>
<p>7.有个logn的算法</p>
<p>8.全排列，利于对递归的理解</p>
<p>9.递归</p>
<p>10.</p>
<p>11.计算各个位置为1的个数</p>
<p>12.因为ab&lt;ba所以a排在b前面 a&lt;b, 证明a&lt;b b&lt;c =&gt; a&lt;c</p>
<p>13.删除有技巧</p>
<p>14.O(n2)</p>
<p>15.O(n)</p>
<p>16.1 递归</p>
<p>16.2 两个链表的交叉点</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2015/03/02/2015-3-2-design_pattern/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2015/03/02/2015-3-2-design_pattern/" itemprop="url">设计模式</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2015-03-02T00:00:00+08:00">
                2015-03-02
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="设计模式"><a href="#设计模式" class="headerlink" title="设计模式"></a>设计模式</h2><p>1.reactor</p>
<p>twisted框架有使用该模式</p>
<p>等待事件，处理事件</p>
<p><img src="https://github.com/garydai/garydai.github.com/raw/master/_posts/pic/reactor.png" alt=""></p>
<p><img src="https://github.com/garydai/garydai.github.com/raw/master/_posts/pic/reactor2.png" alt=""></p>
<p>2.工厂模式</p>
<p>工厂方法模式</p>
<p><img src="https://github.com/garydai/garydai.github.com/raw/master/_posts/pic/factory-method.png" alt=""></p>
<p>定义了一个创建对象的接口，由子类决定要实例化的类是哪一个。工厂方法让类把实例化推迟到子类。</p>
<p>一个抽象工厂类，多个具体工厂类，一个抽象产品类，多个具体产品类；具体工厂类生产产品</p>
<p>将生产产品的行为由子类执行</p>
<p>把产品抽象</p>
<p>3.抽象工厂模式</p>
<p>提供一个接口，用于创建相关或依赖对象的家族，而不需要明确指定具体类。</p>
<p>加入抽象工厂</p>
<p>工厂方法模式：创建抽象工厂类，具体工厂类，实例化具体工厂，创建产品</p>
<pre><code>// abstract factory
abstract class Kitchen {
  public abstract KitchenMeal getMeal(String preferency);
  public abstract KitchenMeal getDessert(String preferency);
}

// concrete factory
class KitchenFactory extends Kitchen {
  @Override
  public KitchenMeal getMeal(String preferency) {
    if (preferency.equals(&quot;F.1&quot;)) {
      return new FastFoodMeal();
    } else if (preferency.equals(&quot;P.1&quot;)) {
      return new ProteinMeal();
    }
    return new VegetarianMeal();
  }

  @Override
  public KitchenMeal getDessert(String preferency) {
    if (preferency.equals(&quot;I.1&quot;)) {
      return new IceCreamMeal();
    }
    return null;
  }
}

// abstract product
abstract class KitchenMeal {
  public abstract String getName();
}

// concrete products
class ProteinMeal extends KitchenMeal {
  @Override
  public String getName() {
    return &quot;protein meal&quot;;
  }
}</code></pre><p>4.单例模式</p>
<p>5.建造者模式</p>
<p>工厂模式创建一个产品，建造者模式创建多个产品合为一起</p>
<pre><code>class Programmer {
  private String firstName;
  private String lastName;

  private Programmer(String fName, String lName) {
    this.firstName = fName;
    this.lastName = lName;
  }

  public static class ProgrammerBuilder {
    private String firstName;
    private String lastName;

    public ProgrammerBuilder setFirstName(String firstName) {
      this.firstName = firstName;
      return this;
    }

    public ProgrammerBuilder setLastName(String lastName) {
      this.lastName = lastName;
      return this;
    }    

    public Programmer build() {
        return    new Programmer(this.firstName, this.lastName);
    }         
}</code></pre><p>6.原型模式</p>
<p>对象拷贝</p>
<p>7.适配器模式</p>
<p>将一个类通过适配器变成满足另一个接口的类</p>
<p>对象适配器<br><img src="https://github.com/garydai/garydai.github.com/raw/master/_posts/pic/adapter.png" alt=""></p>
<p>springmvc使用handlerAdpter，根据handler类型，使用确定使用哪个适配器来处理请求</p>
<p>三种handler类型</p>
<p>1.Controller</p>
<p>org.springframework.web.servlet.mvc.SimpleControllerHandlerAdapter</p>
<p>2.方法handlerMethod</p>
<p>org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerAdapter</p>
<p>3.Servlet</p>
<p>org.springframework.web.servlet.handler.SimpleServletHandlerAdapter</p>
<p>8.代理模式</p>
<p><img src="https://github.com/garydai/garydai.github.com/raw/master/_posts/pic/proxy.png" alt=""></p>
<p>委托人委托代理人执行事务，代理人也要反馈结果。</p>
<p>委托人声明协议方法，代理人需要实现该协议的方法。</p>
<pre><code>abstract class Subject
{
    public abstract void Request();
}


class RealSubject : Subject  
{  
    public override void Request()  
    {  
        //业务方法具体实现代码  
    }  
}  

class Proxy : Subject
{
    private RealSubject realSubject = new RealSubject(); //维持一个对真实主题对象的引用

    public void PreRequest() 
    {
        …...
    }

    public override void Request() 
    {
        PreRequest();
        realSubject.Request(); //调用真实主题对象的方法
        PostRequest();
    }

    public void PostRequest() 
    {
        ……
    }
}


Interface Hello {
    void say();
}

class HelloImpl implement Hello {
    void say() {

    }
}

class Proxy implement Hello {
    Hello hello;
    public proxy(Hello h) {
        hello = h;
    }

    void say() {
        xxx;
        hello.say();
        xxx;
    }
}

Proxy p = new Proxy(new HelloImpl());
p.say();

代理类和被代理类继承同一个接口

上面是静态代理，编译后就有.class文件，动态代理类的字节码在程序运行时由Java反射机制动态生成</code></pre><p><img src="https://github.com/garydai/garydai.github.com/raw/master/_posts/pic/dynamic_proxy.png" alt=""></p>
<p>动态代理：根据接口，动态生成代理类。</p>
<pre><code>pulbic class Test implement InvocationHandler {
    private Object o;

    public Test(Object t) {
        this.o = t;
    }

    pulbic Object invoke(Object proxy, Method method, Object[] arg) {
        xxx
        method.invode(o, arg);
        xxx

    }
}</code></pre><p>​<br>​        InvocationHandler test = new Test(new HelloImpl());<br>​<br>        Hello dynamicProxy = (Hello) Proxy.newProxyInstance(实现类.class.getClassLoader(),<br>                        实现类.class.getInterfaces(), InvocationHandler实例);</p>
<pre><code>dynamicProxy.say();</code></pre><p>9.外观模式</p>
<p>组合各种类</p>
<p>10.桥接模式</p>
<p>使得不同的对象使用自身的方法</p>
<p>11.组合模式</p>
<p>12.享元模式</p>
<p>13.策略模式</p>
<pre><code>interface IStrategy {
       public void doSomething();
   }
   class ConcreteStrategy1 implements IStrategy {
       public void doSomething() {
           System.out.println(&quot;具体策略1&quot;);
       }
   }
   class ConcreteStrategy2 implements IStrategy {
       public void doSomething() {
           System.out.println(&quot;具体策略2&quot;);
       }
   }
   class Context {
       private IStrategy strategy;

       public Context(IStrategy strategy){
           this.strategy = strategy;
       }

       public void execute(){
           strategy.doSomething();
       }
   }

   public class Client {
       public static void main(String[] args){
           Context context;
           System.out.println(&quot;-----执行策略1-----&quot;);
           context = new Context(new ConcreteStrategy1());
           context.execute();

           System.out.println(&quot;-----执行策略2-----&quot;);
           context = new Context(new ConcreteStrategy2());
           context.execute();
       }
   }</code></pre><p>14.模板方法模式</p>
<p>父类定义逻辑顺序，子类实现具体逻辑</p>
<p>15.观察者模式</p>
<p>把观察者放入对象内</p>
<p>多个观察者对象监听某对象，当该对象状态发生变化，则会通知所有观察者。</p>
<pre><code>public abstract class Subject {
    /**
     * 用来保存注册的观察者对象
     */
    private    List&lt;Observer&gt; list = new ArrayList&lt;Observer&gt;();
    /**
     * 注册观察者对象
     * @param observer    观察者对象
     */
    public void attach(Observer observer){

        list.add(observer);
        System.out.println(&quot;Attached an observer&quot;);
    }
    /**
     * 删除观察者对象
     * @param observer    观察者对象
     */
    public void detach(Observer observer){

        list.remove(observer);
    }
    /**
     * 通知所有注册的观察者对象
     */
    public void nodifyObservers(String newState){

        for(Observer observer : list){
            observer.update(newState);
        }
    }
}</code></pre><p>​<br>​<br>​        public class ConcreteSubject extends Subject{<br>​<br>            private String state;</p>
<pre><code>    public String getState() {
        return state;
    }

    public void change(String newState){
        state = newState;
        System.out.println(&quot;主题状态为：&quot; + state);
        //状态发生改变，通知各个观察者
        this.nodifyObservers(state);
    }
}


public interface Observer {
    /**
     * 更新接口
     * @param state    更新的状态
     */
    public void update(String state);
}

public class ConcreteObserver implements Observer {
    //观察者的状态
    private String observerState;

    @Override
    public void update(String state) {
        /**
         * 更新观察者的状态，使其与目标的状态保持一致
         */
        observerState = state;
        System.out.println(&quot;状态为：&quot;+observerState);
    }

}</code></pre><p>观察类放入被观察类中，被观察类发生改变通知观察类做出反应</p>
<p><img src="https://github.com/garydai/garydai.github.com/raw/master/_posts/pic/observer.png" alt=""></p>
<p>16.迭代子模式</p>
<p>迭代器iterator</p>
<p>17.责任链模式</p>
<p>每个对象持有对下一个对象的引用</p>
<p>18.命令模式</p>
<p>把方法调用封装起来</p>
<p>将请求封装成对象，以便使用不同的请求、队列或者日志来参数化其他对象。命令模式也支持撤销。</p>
<p>命令对象把动作和接受者包进对象</p>
<p>客户、接受者、调用者</p>
<p>例子：工作队列</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">public interface Command &#123;</span><br><span class="line">	void execute();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">public class ConcreteCommand implements Command &#123;</span><br><span class="line">	public void execute() &#123;</span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">public class Invoker &#123;</span><br><span class="line">	Command command;</span><br><span class="line">	public void setCommand(Command commandPara) &#123;</span><br><span class="line">		command &#x3D; commandPara;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	public void action &#123;</span><br><span class="line">		command.execute();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">public class client &#123;</span><br><span class="line">	public static void main() &#123;</span><br><span class="line">		Command c &#x3D; new ConcreteCommand();</span><br><span class="line">		Invoker i &#x3D; new Invoker();</span><br><span class="line">		i.setCommand(c);</span><br><span class="line">		i.action();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>19.备忘录模式</p>
<p>20.状态模式</p>
<pre><code>public interface State {
       public void doAction(Context context);
}

public class StartState implements State {

   public void doAction(Context context) {
      System.out.println(&quot;Player is in start state&quot;);
      context.setState(this);    
   }

   public String toString(){
      return &quot;Start State&quot;;
   }
}

public class StopState implements State {

   public void doAction(Context context) {
      System.out.println(&quot;Player is in stop state&quot;);
      context.setState(this);    
   }

   public String toString(){
      return &quot;Stop State&quot;;
   }
}</code></pre><p>​<br>​    public class Context {<br>​       private State state;<br>​<br>       public Context(){<br>          state = null;<br>       }</p>
<pre><code>   public void setState(State state){
      this.state = state;        
   }

   public State getState(){
      return state;
   }
}


public class StatePatternDemo {
   public static void main(String[] args) {
      Context context = new Context();

      StartState startState = new StartState();
      startState.doAction(context);

      System.out.println(context.getState().toString());

      StopState stopState = new StopState();
      stopState.doAction(context);

      System.out.println(context.getState().toString());
   }
}</code></pre><p>21.访问者模式</p>
<p>数据和操作解耦</p>
<pre><code>abstract class Element {  
    public abstract void accept(IVisitor visitor);  
    public abstract void doSomething();  
}  

interface IVisitor {  
    public void visit(ConcreteElement1 el1);  
    public void visit(ConcreteElement2 el2);  
}  

class ConcreteElement1 extends Element {  
    public void doSomething(){  
        System.out.println(&quot;这是元素1&quot;);  
    }  

    public void accept(IVisitor visitor) {  
        visitor.visit(this);  
    }  
}  

class ConcreteElement2 extends Element {  
    public void doSomething(){  
        System.out.println(&quot;这是元素2&quot;);  
    }  

    public void accept(IVisitor visitor) {  
        visitor.visit(this);  
    }  
}  
class Visitor implements IVisitor {  

    public void visit(ConcreteElement1 el1) {  
        el1.doSomething();  
    }  

    public void visit(ConcreteElement2 el2) {  
        el2.doSomething();  
    }  
}  

class ObjectStruture {  
    public static List&lt;Element&gt; getList(){  
        List&lt;Element&gt; list = new ArrayList&lt;Element&gt;();  
        Random ran = new Random();  
        for(int i=0; i&lt;10; i++){  
            int a = ran.nextInt(100);  
            if(a&gt;50){  
                list.add(new ConcreteElement1());  
            }else{  
                list.add(new ConcreteElement2());  
            }  
        }  
        return list;  
    }  
}  

public class Client {  
    public static void main(String[] args){  
        List&lt;Element&gt; list = ObjectStruture.getList();  
        for(Element e: list){  
            e.accept(new Visitor());  
        }  
    }  
}  </code></pre><p>22.中介者模式</p>
<p>23.解释器模式</p>
<pre><code>abstract class AbstractExpression {
       public  abstract void interpret(Context ctx);
}

class TerminalExpression extends  AbstractExpression {
   public  void interpret(Context ctx) {
          //终结符表达式的解释操作
   }
}</code></pre><p>24.装饰器模式</p>
<p><img src="https://github.com/garydai/garydai.github.com/raw/master/_posts/pic/decorator.png" alt=""><br>咖啡是一种饮料，咖啡的本质是咖啡豆+水磨出来的。咖啡店现在要卖各种口味的咖啡，如果不使用装饰模式，那么在销售系统中，各种不一样的咖啡都要产生一个类，如果有4中咖啡豆，5种口味，那么将要产生至少20个类（不包括混合口味），非常麻烦。使用了装饰模式，只需要11个类即可生产任意口味咖啡（包括混合口味</p>
<pre><code>  public abstract class AbstractCellPhone
  {
          public abstract string CallNumber();
          public abstract string SendMessage();
  }

  public class NokiaPhone : AbstractCellPhone
 {
      public override string CallNumber()
      {
          return &quot;NokiaPhone call sombody&quot;;
      }

      public override string SendMessage()
      {
          return &quot;NokiaPhone send a message to somebody&quot;;
      }
 }




 public abstract class Decorator : AbstractCellPhone
  {
      AbstractCellPhone _phone;

      public Decorator(AbstractCellPhone phone)
      {
          _phone = phone;
      }

      public override string CallNumber()
      {
          return _phone.CallNumber();
      }

      public override string SendMessage()
      {
          return _phone.SendMessage();
      }
}</code></pre><p>​              </p>
<pre><code>public class DecoratorGPS : Decorator
{
  public DecoratorGPS(AbstractCellPhone phone) : base(phone){ }

  public override string CallNumber()
       {
           return base.CallNumber() + &quot; with GPS&quot;;
       }

       public override string SendMessage()
       {
           return base.SendMessage() + &quot; with GPS&quot;;
       }
   }

   public class DecoratorBlueTooth : Decorator
   {
       public DecoratorBlueTooth(AbstractCellPhone phone)
           : base(phone)
       { }

       public override string CallNumber()
       {
           return base.CallNumber() + &quot; with BlueTooth&quot;;
       }

       public override string SendMessage()
       {
           return base.SendMessage() + &quot; with BlueTooth&quot;;
       }
}</code></pre><p>​<br>​      给手机加上gps等装饰</p>
<h3 id="分类"><a href="#分类" class="headerlink" title="分类"></a>分类</h3><p>创建型</p>
<p>行为型</p>
<p>结构型</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2015/02/15/2015-2-15-scrapy/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2015/02/15/2015-2-15-scrapy/" itemprop="url">scrapy</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2015-02-15T00:00:00+08:00">
                2015-02-15
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>##scrapy</p>
<p>单进程，基于twisted(利用epoll或其他多路复用)</p>
<p>流程</p>
<pre><code>settings = conf.settings
inproject = inside_project()
cmds = _get_commands_dict(settings, inproject)
cmdname = _pop_command_name(argv)
cmd = cmds[cmdname]
...
cmd.crawler_process = CrawlerProcess(settings)
cmd.run()</code></pre><p>1.读取scrapy.cgf配置文件</p>
<pre><code>[settings]
default = m_p.settings

[deploy]
#url = http://localhost:6800/
project = m_p</code></pre><p>2.读取setting设置文件</p>
<pre><code>BOT_NAME = &apos;m_p&apos;

SPIDER_MODULES = [&apos;m_p.spiders&apos;]
NEWSPIDER_MODULE = &apos;m_p.spiders&apos;

ITEM_PIPELINES = {&apos;m_p.pipelines.mysql_pipeline&apos;:2, &apos;m_p.pipelines.download_image_pipeline&apos;:1 }

SERVER = &quot;localhost&quot;
PORT = 3306
DB = &quot;music&quot;
COLLECTION = &quot;music&quot;
USER = &apos;root&apos;
PASSWORD = &apos;&apos;
CHARSET = &apos;utf8&apos;
IMAGES_STORE=&apos;/home/admin/nginx/html/yii/demos/music_web/images/cover/&apos;</code></pre><p>3.导入相应的module爬虫模块</p>
<p>4.解析命令行参数</p>
<p>5.设置爬虫程序入口</p>
<p>6.运行cmd</p>
<pre><code>def run(self, args, opts):
     if len(args) &lt; 1:
         raise UsageError()
     elif len(args) &gt; 1:
         raise UsageError(&quot;running &apos;scrapy crawl&apos; with more than one spider is no longer supported&quot;)
     spname = args[0]

     self.crawler_process.crawl(spname, **opts.spargs)
     self.crawler_process.start()




 crawler.py  

 class CrawlerRunner(object):

 def crawl(self, spidercls, *args, **kwargs):
     crawler = self._create_crawler(spidercls)
     self._setup_crawler_logging(crawler)
     self.crawlers.add(crawler)
     d = crawler.crawl(*args, **kwargs)
     self._active.add(d)

     def _done(result):
         self.crawlers.discard(crawler)
         self._active.discard(d)
         return result

     return d.addBoth(_done)


 class Crawler(object):


 def crawl(self, *args, **kwargs):
     assert not self.crawling, &quot;Crawling already taking place&quot;
     self.crawling = True

     try:
         self.spider = self._create_spider(*args, **kwargs)
         self.engine = self._create_engine()
         start_requests = iter(self.spider.start_requests())
         yield self.engine.open_spider(self.spider, start_requests)  open engine&apos;s spider
         yield defer.maybeDeferred(self.engine.start)
     except Exception:
         self.crawling = False
         raise


 class ExecutionEngine(object):

 @defer.inlineCallbacks
 def open_spider(self, spider, start_requests=(), close_if_idle=True):
     assert self.has_capacity(), &quot;No free spider slot when opening %r&quot; % \
         spider.name
     log.msg(&quot;Spider opened&quot;, spider=spider)
     nextcall = CallLaterOnce(self._next_request, spider)
     scheduler = self.scheduler_cls.from_crawler(self.crawler)
     start_requests = yield self.scraper.spidermw.process_start_requests(start_requests, spider)
     slot = Slot(start_requests, close_if_idle, nextcall, scheduler)
     self.slot = slot
     self.spider = spider
     yield scheduler.open(spider)
     yield self.scraper.open_spider(spider)
     self.crawler.stats.open_spider(spider)
     yield self.signals.send_catch_log_deferred(signals.spider_opened, spider=spider)
     slot.nextcall.schedule()


 class CrawlerProcess(CrawlerRunner):

 def start(self, stop_after_crawl=True):
     if stop_after_crawl:
         d = self.join()
         # Don&apos;t start the reactor if the deferreds are already fired
         if d.called:
             return
         d.addBoth(lambda _: self._stop_reactor())

     if self.settings.getbool(&apos;DNSCACHE_ENABLED&apos;):
         reactor.installResolver(CachingThreadedResolver(reactor))

     reactor.addSystemEventTrigger(&apos;before&apos;, &apos;shutdown&apos;, self.stop)
     reactor.run(installSignalHandlers=False)  # blocking call</code></pre><p>用了Twisted-&gt;reactor</p>
<p><img src="https://github.com/garydai/garydai.github.com/raw/master/_posts/pic/scrapy.jpg" alt=""></p>
<p>1.engine从spider获取要爬取的url</p>
<p>2.engine将url交给调度器</p>
<p>3.engine从调度器获取要爬取的url</p>
<p> _next_request_from_scheduler -&gt;slot.scheduler.next_request()</p>
<pre><code>def _next_request_from_scheduler(self, spider):
     slot = self.slot
     request = slot.scheduler.next_request()
     if not request:
         return
     d = self._download(request, spider)
     d.addBoth(self._handle_downloader_output, request, spider)
     d.addErrback(log.msg, spider=spider)
     d.addBoth(lambda _: slot.remove_request(request))
     d.addErrback(log.msg, spider=spider)
     d.addBoth(lambda _: slot.nextcall.schedule())
     d.addErrback(log.msg, spider=spider)
     return d</code></pre><p>4.engine将url通过下载中间件交给下载器</p>
<pre><code>slot.add_request(request)

    dwld = self.downloader.fetch(request, spider)
    dwld.addCallbacks(_on_success)
    dwld.addBoth(_on_complete)</code></pre><p>5.下载完毕后，下载器将response交给engine</p>
<p>6.engine将response通过spider中间件交给spider</p>
<p>7.spider处理response，将item和下一个请求url返回给engine</p>
<p>8.engine将item交给item pipeline,将url交给调度器</p>
<p>9.第2步</p>
<pre><code>class CrawlerProcess(CrawlerRunner):
    &quot;&quot;&quot;A class to run multiple scrapy crawlers in a process simultaneously&quot;&quot;&quot;

    def __init__(self, settings):
        super(CrawlerProcess, self).__init__(settings)
        install_shutdown_handlers(self._signal_shutdown)
        self.stopping = False
        self.log_observer = log.start_from_settings(self.settings)
        log.scrapy_info(settings)

    def _signal_shutdown(self, signum, _):
        install_shutdown_handlers(self._signal_kill)
        signame = signal_names[signum]
        log.msg(format=&quot;Received %(signame)s, shutting down gracefully. Send again to force &quot;,
                level=log.INFO, signame=signame)
        reactor.callFromThread(self.stop)

    def _signal_kill(self, signum, _):
        install_shutdown_handlers(signal.SIG_IGN)
        signame = signal_names[signum]
        log.msg(format=&apos;Received %(signame)s twice, forcing unclean shutdown&apos;,
                level=log.INFO, signame=signame)
        self._stop_logging()
        reactor.callFromThread(self._stop_reactor)

    def start(self, stop_after_crawl=True):
        if stop_after_crawl:
            d = self.join()
            # Don&apos;t start the reactor if the deferreds are already fired
            if d.called:
                return
            d.addBoth(lambda _: self._stop_reactor())

        if self.settings.getbool(&apos;DNSCACHE_ENABLED&apos;):
            reactor.installResolver(CachingThreadedResolver(reactor))

        reactor.addSystemEventTrigger(&apos;before&apos;, &apos;shutdown&apos;, self.stop)
        reactor.run(installSignalHandlers=False)  # blocking call

    def _stop_logging(self):
        if self.log_observer:
            self.log_observer.stop()

    def _stop_reactor(self, _=None):
        try:
            reactor.stop()
        except RuntimeError:  # raised if already stopped or in shutdown stage
            pass



class CrawlerRunner(object):

    def __init__(self, settings):
        self.settings = settings
        smcls = load_object(settings[&apos;SPIDER_MANAGER_CLASS&apos;])
        self.spiders = smcls.from_settings(settings.frozencopy())
        self.crawlers = set()
        self._active = set()

    def crawl(self, spidercls, *args, **kwargs):
        crawler = self._create_crawler(spidercls)
        self._setup_crawler_logging(crawler)
        self.crawlers.add(crawler)
        d = crawler.crawl(*args, **kwargs)
        self._active.add(d)

        def _done(result):
            self.crawlers.discard(crawler)
            self._active.discard(d)
            return result

        return d.addBoth(_done)

    def _create_crawler(self, spidercls):
        if isinstance(spidercls, six.string_types):
            spidercls = self.spiders.load(spidercls)

        crawler_settings = self.settings.copy()
        spidercls.update_settings(crawler_settings)
        crawler_settings.freeze()
        return Crawler(spidercls, crawler_settings)

    def _setup_crawler_logging(self, crawler):
        log_observer = log.start_from_crawler(crawler)
        if log_observer:
            crawler.signals.connect(log_observer.stop, signals.engine_stopped)

    def stop(self):
        return defer.DeferredList([c.stop() for c in list(self.crawlers)])

    @defer.inlineCallbacks
    def join(self):
        &quot;&quot;&quot;Wait for all managed crawlers to complete&quot;&quot;&quot;
        while self._active:
            yield defer.DeferredList(self._active)</code></pre>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2015/02/15/2015-2-15-python%E9%97%AD%E5%8C%85/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2015/02/15/2015-2-15-python%E9%97%AD%E5%8C%85/" itemprop="url">闭包</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2015-02-15T00:00:00+08:00">
                2015-02-15
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="闭包"><a href="#闭包" class="headerlink" title="闭包"></a>闭包</h2><p>定义在函数内部的函数</p>
<p>如javascript</p>
<pre><code>function f1(){

　　　　var n=999;

　　　　function f2(){
　　　　　　alert(n); 
　　　　}

　　　　return f2;

　　}

　　var result=f1();

　　result(); // 999
　　</code></pre><p>如果f2函数被赋值给全局变量，那么函数中的变量会一直保存在内存中</p>
<p>函数对象中会保存函数里的变量和与该函数对象属于相同作用域的变量（即函数外）</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2015/02/15/2015-2-15-Twisted/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2015/02/15/2015-2-15-Twisted/" itemprop="url">Twisted</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2015-02-15T00:00:00+08:00">
                2015-02-15
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>##Twisted</p>
<p>reactor+deferred</p>
<pre><code>没使用reactor的异步客户端

# This is the asynchronous Get Poetry Now! client.

import datetime, errno, optparse, select, socket


def parse_args():
    usage = &quot;&quot;&quot;usage: %prog [options] [hostname]:port ...
This is the Get Poetry Now! client, asynchronous edition.
Run it like this:
  python get-poetry.py port1 port2 port3 ...
If you are in the base directory of the twisted-intro package,
you could run it like this:
  python async-client/get-poetry.py 10001 10002 10003
to grab poetry from servers on ports 10001, 10002, and 10003.
Of course, there need to be servers listening on those ports
for that to work.
&quot;&quot;&quot;

    parser = optparse.OptionParser(usage)

    _, addresses = parser.parse_args()

    if not addresses:
        print parser.format_help()
        parser.exit()

    def parse_address(addr):
        if &apos;:&apos; not in addr:
            host = &apos;127.0.0.1&apos;
            port = addr
        else:
            host, port = addr.split(&apos;:&apos;, 1)

        if not port.isdigit():
            parser.error(&apos;Ports must be integers.&apos;)

        return host, int(port)

    return map(parse_address, addresses)


def get_poetry(sockets):
    &quot;&quot;&quot;Download poety from all the given sockets.&quot;&quot;&quot;

    poems = dict.fromkeys(sockets, &apos;&apos;) # socket -&gt; accumulated poem

    # socket -&gt; task numbers
    sock2task = dict([(s, i + 1) for i, s in enumerate(sockets)])

    sockets = list(sockets) # make a copy

    # we go around this loop until we&apos;ve gotten all the poetry
    # from all the sockets. This is the &apos;reactor loop&apos;.

    while sockets:
        # this select call blocks until one or more of the
        # sockets is ready for read I/O
        rlist, _, _ = select.select(sockets, [], [])

        # rlist is the list of sockets with data ready to read

        for sock in rlist:
            data = &apos;&apos;

            while True:
                try:
                    new_data = sock.recv(1024)
                except socket.error, e:
                    if e.args[0] == errno.EWOULDBLOCK:
                        # this error code means we would have
                        # blocked if the socket was blocking.
                        # instead we skip to the next socket
                        break
                    raise
                else:
                    if not new_data:
                        break
                    else:
                        data += new_data

            # Each execution of this inner loop corresponds to
            # working on one asynchronous task in Figure 3 here:
            # http://krondo.com/?p=1209#figure3

            task_num = sock2task[sock]

            if not data:
                sockets.remove(sock)
                sock.close()
                print &apos;Task %d finished&apos; % task_num
            else:
                addr_fmt = format_address(sock.getpeername())
                msg = &apos;Task %d: got %d bytes of poetry from %s&apos;
                print  msg % (task_num, len(data), addr_fmt)

            poems[sock] += data

    return poems


def connect(address):
    &quot;&quot;&quot;Connect to the given server and return a non-blocking socket.&quot;&quot;&quot;

    sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
    sock.connect(address)
    sock.setblocking(0)
    return sock


def format_address(address):
    host, port = address
    return &apos;%s:%s&apos; % (host or &apos;127.0.0.1&apos;, port)


def main():
    addresses = parse_args()

    start = datetime.datetime.now()

    sockets = map(connect, addresses)

    poems = get_poetry(sockets)

    elapsed = datetime.datetime.now() - start

    for i, sock in enumerate(sockets):
        print &apos;Task %d: %d bytes of poetry&apos; % (i + 1, len(poems[sock]))

    print &apos;Got %d poems in %s&apos; % (len(addresses), elapsed)


if __name__ == &apos;__main__&apos;:
    main()


twisted异步客户端
    # This is the Twisted Get Poetry Now! client, version 1.0.

# NOTE: This should not be used as the basis for production code.
# It uses low-level Twisted APIs as a learning exercise.

import datetime, errno, optparse, socket

from twisted.internet import main


def parse_args():
    usage = &quot;&quot;&quot;usage: %prog [options] [hostname]:port ...
This is the Get Poetry Now! client, Twisted version 1.0.
Run it like this:
  python get-poetry.py port1 port2 port3 ...
If you are in the base directory of the twisted-intro package,
you could run it like this:
  python twisted-client-1/get-poetry.py 10001 10002 10003
to grab poetry from servers on ports 10001, 10002, and 10003.
Of course, there need to be servers listening on those ports
for that to work.
&quot;&quot;&quot;

    parser = optparse.OptionParser(usage)

    _, addresses = parser.parse_args()

    if not addresses:
        print parser.format_help()
        parser.exit()

    def parse_address(addr):
        if &apos;:&apos; not in addr:
            host = &apos;127.0.0.1&apos;
            port = addr
        else:
            host, port = addr.split(&apos;:&apos;, 1)

        if not port.isdigit():
            parser.error(&apos;Ports must be integers.&apos;)

        return host, int(port)

    return map(parse_address, addresses)


class PoetrySocket(object):

    poem = &apos;&apos;

    def __init__(self, task_num, address):
        self.task_num = task_num
        self.address = address
        self.sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
        self.sock.connect(address)
        self.sock.setblocking(0)

        # tell the Twisted reactor to monitor this socket for reading
        from twisted.internet import reactor
        reactor.addReader(self)

    def fileno(self):
        try:
            return self.sock.fileno()
        except socket.error:
            return -1

    def connectionLost(self, reason):
        self.sock.close()

        # stop monitoring this socket
        from twisted.internet import reactor
        reactor.removeReader(self)

        # see if there are any poetry sockets left
        for reader in reactor.getReaders():
            if isinstance(reader, PoetrySocket):
                return

        reactor.stop() # no more poetry

    def doRead(self):
        bytes = &apos;&apos;

        while True:
            try:
                bytesread = self.sock.recv(1024)
                if not bytesread:
                    break
                else:
                    bytes += bytesread
            except socket.error, e:
                if e.args[0] == errno.EWOULDBLOCK:
                    break
                return main.CONNECTION_LOST

        if not bytes:
            print &apos;Task %d finished&apos; % self.task_num
            return main.CONNECTION_DONE
        else:
            msg = &apos;Task %d: got %d bytes of poetry from %s&apos;
            print  msg % (self.task_num, len(bytes), self.format_addr())

        self.poem += bytes

    def logPrefix(self):
        return &apos;poetry&apos;

    def format_addr(self):
        host, port = self.address
        return &apos;%s:%s&apos; % (host or &apos;127.0.0.1&apos;, port)


def poetry_main():
    addresses = parse_args()

    start = datetime.datetime.now()

    sockets = [PoetrySocket(i + 1, addr) for i, addr in enumerate(addresses)]

    from twisted.internet import reactor
    reactor.run()

    elapsed = datetime.datetime.now() - start

    for i, sock in enumerate(sockets):
        print &apos;Task %d: %d bytes of poetry&apos; % (i + 1, len(sock.poem))

    print &apos;Got %d poems in %s&apos; % (len(addresses), elapsed)


if __name__ == &apos;__main__&apos;:
    poetry_main()</code></pre><p>IReactorFDSet是一个Twisted的reactor实现的接口</p>
<p>epollreactor</p>
<pre><code>def doPoll(self, timeout):
     &quot;&quot;&quot;
     Poll the poller for new events.
     &quot;&quot;&quot;
     if timeout is None:
         timeout = -1  # Wait indefinitely.

     try:
         # Limit the number of events to the number of io objects we&apos;re
         # currently tracking (because that&apos;s maybe a good heuristic) and
         # the amount of time we block to the value specified by our
         # caller.
         l = self._poller.poll(timeout, len(self._selectables))
     except IOError as err:
         if err.errno == errno.EINTR:
             return
         # See epoll_wait(2) for documentation on the other conditions
         # under which this can fail.  They can only be due to a serious
         # programming error on our part, so let&apos;s just announce them
         # loudly.
         raise

     _drdw = self._doReadOrWrite
     for fd, event in l:
         try:
             selectable = self._selectables[fd]
         except KeyError:
             pass
         else:
             log.callWithLogger(selectable, _drdw, selectable, fd, event)</code></pre><p><img src="https://github.com/garydai/garydai.github.com/raw/master/_posts/pic/twisted.PNG" alt=""></p>
<p>run</p>
<p>回调函数的实现，通过传入类，重写基类的函数</p>
<p>有很多抽象类</p>
<p>有关socket的操作由Protocol类完成，抽象了底层，提供操作数据流的接口，即实现数据协议</p>
<pre><code># This is the Twisted Get Poetry Now! client, version 2.0.

# NOTE: This should not be used as the basis for production code.

import datetime, optparse

from twisted.internet.protocol import Protocol, ClientFactory


def parse_args():
    usage = &quot;&quot;&quot;usage: %prog [options] [hostname]:port ...
This is the Get Poetry Now! client, Twisted version 2.0.
Run it like this:
  python get-poetry.py port1 port2 port3 ...
If you are in the base directory of the twisted-intro package,
you could run it like this:
  python twisted-client-2/get-poetry.py 10001 10002 10003
to grab poetry from servers on ports 10001, 10002, and 10003.
Of course, there need to be servers listening on those ports
for that to work.
&quot;&quot;&quot;

    parser = optparse.OptionParser(usage)

    _, addresses = parser.parse_args()

    if not addresses:
        print parser.format_help()
        parser.exit()

    def parse_address(addr):
        if &apos;:&apos; not in addr:
            host = &apos;127.0.0.1&apos;
            port = addr
        else:
            host, port = addr.split(&apos;:&apos;, 1)

        if not port.isdigit():
            parser.error(&apos;Ports must be integers.&apos;)

        return host, int(port)

    return map(parse_address, addresses)


class PoetryProtocol(Protocol):

    poem = &apos;&apos;
    task_num = 0

    def dataReceived(self, data):
        self.poem += data
        msg = &apos;Task %d: got %d bytes of poetry from %s&apos;
        print  msg % (self.task_num, len(data), self.transport.getPeer())

    def connectionLost(self, reason):
        self.poemReceived(self.poem)

    def poemReceived(self, poem):
        self.factory.poem_finished(self.task_num, poem)


class PoetryClientFactory(ClientFactory):

    task_num = 1

    protocol = PoetryProtocol # tell base class what proto to build

    def __init__(self, poetry_count):
        self.poetry_count = poetry_count
        self.poems = {} # task num -&gt; poem

    def buildProtocol(self, address):
        proto = ClientFactory.buildProtocol(self, address)
        proto.task_num = self.task_num
        self.task_num += 1
        return proto

    def poem_finished(self, task_num=None, poem=None):
        if task_num is not None:
            self.poems[task_num] = poem

        self.poetry_count -= 1

        if self.poetry_count == 0:
            self.report()
            from twisted.internet import reactor
            reactor.stop()

    def report(self):
        for i in self.poems:
            print &apos;Task %d: %d bytes of poetry&apos; % (i, len(self.poems[i]))

    def clientConnectionFailed(self, connector, reason):
        print &apos;Failed to connect to:&apos;, connector.getDestination()
        self.poem_finished()


def poetry_main():
    addresses = parse_args()

    start = datetime.datetime.now()

    factory = PoetryClientFactory(len(addresses))

    from twisted.internet import reactor

    for address in addresses:
        host, port = address
        reactor.connectTCP(host, port, factory)

    reactor.run()

    elapsed = datetime.datetime.now() - start

    print &apos;Got %d poems in %s&apos; % (len(addresses), elapsed)


if __name__ == &apos;__main__&apos;:
    poetry_main()


 reactor.connectTCP(host, port, factory)-&gt; buildProtocol(self, address):</code></pre><p><img src="https://github.com/garydai/garydai.github.com/raw/master/_posts/pic/twisted.PNG" alt=""></p>
<p>加入Transports，Protocols</p>
<pre><code># This is the Twisted Get Poetry Now! client, version 2.0.

# NOTE: This should not be used as the basis for production code.

import datetime, optparse

from twisted.internet.protocol import Protocol, ClientFactory


def parse_args():
    usage = &quot;&quot;&quot;usage: %prog [options] [hostname]:port ...
This is the Get Poetry Now! client, Twisted version 2.0.
Run it like this:
  python get-poetry.py port1 port2 port3 ...
If you are in the base directory of the twisted-intro package,
you could run it like this:
  python twisted-client-2/get-poetry.py 10001 10002 10003
to grab poetry from servers on ports 10001, 10002, and 10003.
Of course, there need to be servers listening on those ports
for that to work.
&quot;&quot;&quot;

    parser = optparse.OptionParser(usage)

    _, addresses = parser.parse_args()

    if not addresses:
        print parser.format_help()
        parser.exit()

    def parse_address(addr):
        if &apos;:&apos; not in addr:
            host = &apos;127.0.0.1&apos;
            port = addr
        else:
            host, port = addr.split(&apos;:&apos;, 1)

        if not port.isdigit():
            parser.error(&apos;Ports must be integers.&apos;)

        return host, int(port)

    return map(parse_address, addresses)


class PoetryProtocol(Protocol):处理接收的数据

    poem = &apos;&apos;
    task_num = 0

    def dataReceived(self, data):
        self.poem += data
        msg = &apos;Task %d: got %d bytes of poetry from %s&apos;
        print  msg % (self.task_num, len(data), self.transport.getPeer())

    def connectionLost(self, reason):
        self.poemReceived(self.poem)

    def poemReceived(self, poem):
        self.factory.poem_finished(self.task_num, poem)


class PoetryClientFactory(ClientFactory):

    task_num = 1

    protocol = PoetryProtocol # tell base class what proto to build

    def __init__(self, poetry_count):
        self.poetry_count = poetry_count
        self.poems = {} # task num -&gt; poem

    def buildProtocol(self, address):
        proto = ClientFactory.buildProtocol(self, address)
        proto.task_num = self.task_num
        self.task_num += 1
        return proto

    def poem_finished(self, task_num=None, poem=None):
        if task_num is not None:
            self.poems[task_num] = poem

        self.poetry_count -= 1

        if self.poetry_count == 0:
            self.report()
            from twisted.internet import reactor
            reactor.stop()

    def report(self):
        for i in self.poems:
            print &apos;Task %d: %d bytes of poetry&apos; % (i, len(self.poems[i]))

    def clientConnectionFailed(self, connector, reason):
        print &apos;Failed to connect to:&apos;, connector.getDestination()
        self.poem_finished()


def poetry_main():
    addresses = parse_args()

    start = datetime.datetime.now()

    factory = PoetryClientFactory(len(addresses)) 创建factory

    from twisted.internet import reactor

    for address in addresses:
        host, port = address
        reactor.connectTCP(host, port, factory) 创建协议

    reactor.run()

    elapsed = datetime.datetime.now() - start

    print &apos;Got %d poems in %s&apos; % (len(addresses), elapsed)


if __name__ == &apos;__main__&apos;:
    poetry_main()</code></pre><p><img src="https://github.com/garydai/garydai.github.com/raw/master/_posts/pic/twisted2.png" alt=""></p>
<pre><code># This is the Twisted Get Poetry Now! client, version 3.0.

# NOTE: This should not be used as the basis for production code.

import optparse

from twisted.internet.protocol import Protocol, ClientFactory


def parse_args():
    usage = &quot;&quot;&quot;usage: %prog [options] [hostname]:port ...
This is the Get Poetry Now! client, Twisted version 3.0
Run it like this:
  python get-poetry-1.py port1 port2 port3 ...
If you are in the base directory of the twisted-intro package,
you could run it like this:
  python twisted-client-3/get-poetry-1.py 10001 10002 10003
to grab poetry from servers on ports 10001, 10002, and 10003.
Of course, there need to be servers listening on those ports
for that to work.
&quot;&quot;&quot;

    parser = optparse.OptionParser(usage)

    _, addresses = parser.parse_args()

    if not addresses:
        print parser.format_help()
        parser.exit()

    def parse_address(addr):
        if &apos;:&apos; not in addr:
            host = &apos;127.0.0.1&apos;
            port = addr
        else:
            host, port = addr.split(&apos;:&apos;, 1)

        if not port.isdigit():
            parser.error(&apos;Ports must be integers.&apos;)

        return host, int(port)

    return map(parse_address, addresses)


class PoetryProtocol(Protocol):

    poem = &apos;&apos;

    def dataReceived(self, data):
        self.poem += data

    def connectionLost(self, reason):
        self.poemReceived(self.poem)

    def poemReceived(self, poem):
        self.factory.poem_finished(poem)


class PoetryClientFactory(ClientFactory):

    protocol = PoetryProtocol

    def __init__(self, callback):
        self.callback = callback

    def poem_finished(self, poem):
        self.callback(poem)


def get_poetry(host, port, callback):
    &quot;&quot;&quot;
    Download a poem from the given host and port and invoke
      callback(poem)
    when the poem is complete.
    &quot;&quot;&quot;
    from twisted.internet import reactor
    factory = PoetryClientFactory(callback)
    reactor.connectTCP(host, port, factory)


def poetry_main():
    addresses = parse_args()

    from twisted.internet import reactor

    poems = []

    def got_poem(poem):
        poems.append(poem)
        if len(poems) == len(addresses):
            reactor.stop()

    for address in addresses:
        host, port = address
        get_poetry(host, port, got_poem)

    reactor.run()

    for poem in poems:
        print poem


if __name__ == &apos;__main__&apos;:
    poetry_main()</code></pre><p><img src="https://github.com/garydai/garydai.github.com/raw/master/_posts/pic/twisted3.png" alt=""></p>
<p>Deferred 管理回调函数</p>
<p>deferred.callback errback 不能被调用两次<br>    from twisted.internet.defer import Deferred</p>
<pre><code>def got_poem(res):
    print &apos;Your poem is served:&apos;
    print res

def poem_failed(err):
    print &apos;No poetry for you.&apos;

d = Deferred()

# add a callback/errback pair to the chain
d.addCallbacks(got_poem, poem_failed)

# fire the chain with a normal result
d.callback(&apos;This poem is short.&apos;)

print &quot;Finished&quot;


from twisted.internet.defer import Deferred
from twisted.python.failure import Failure

def got_poem(res):
    print &apos;Your poem is served:&apos;
    print res

def poem_failed(err):
    print &apos;No poetry for you.&apos;

d = Deferred()

# add a callback/errback pair to the chain
d.addCallbacks(got_poem, poem_failed)

# fire the chain with an error result
d.errback(Failure(Exception(&apos;I have failed.&apos;)))

print &quot;Finished&quot;



# This is the Twisted Get Poetry Now! client, version 4.0

import optparse, sys

from twisted.internet import defer
from twisted.internet.protocol import Protocol, ClientFactory


def parse_args():
    usage = &quot;&quot;&quot;usage: %prog [options] [hostname]:port ...
This is the Get Poetry Now! client, Twisted version 4.0
Run it like this:
  python get-poetry.py port1 port2 port3 ...
If you are in the base directory of the twisted-intro package,
you could run it like this:
  python twisted-client-4/get-poetry.py 10001 10002 10003
to grab poetry from servers on ports 10001, 10002, and 10003.
Of course, there need to be servers listening on those ports
for that to work.
&quot;&quot;&quot;

    parser = optparse.OptionParser(usage)

    _, addresses = parser.parse_args()

    if not addresses:
        print parser.format_help()
        parser.exit()

    def parse_address(addr):
        if &apos;:&apos; not in addr:
            host = &apos;127.0.0.1&apos;
            port = addr
        else:
            host, port = addr.split(&apos;:&apos;, 1)

        if not port.isdigit():
            parser.error(&apos;Ports must be integers.&apos;)

        return host, int(port)

    return map(parse_address, addresses)


class PoetryProtocol(Protocol):

    poem = &apos;&apos;

    def dataReceived(self, data):
        self.poem += data

    def connectionLost(self, reason):
        self.poemReceived(self.poem)

    def poemReceived(self, poem):
        self.factory.poem_finished(poem)


class PoetryClientFactory(ClientFactory):

    protocol = PoetryProtocol

    def __init__(self, deferred):
        self.deferred = deferred

    def poem_finished(self, poem):
        if self.deferred is not None:
            d, self.deferred = self.deferred, None
            d.callback(poem)

    def clientConnectionFailed(self, connector, reason):
        if self.deferred is not None:
            d, self.deferred = self.deferred, None
            d.errback(reason)


def get_poetry(host, port):
    &quot;&quot;&quot;
    Download a poem from the given host and port. This function
    returns a Deferred which will be fired with the complete text of
    the poem or a Failure if the poem could not be downloaded.
    &quot;&quot;&quot;
    d = defer.Deferred()
    from twisted.internet import reactor
    factory = PoetryClientFactory(d)
    reactor.connectTCP(host, port, factory)
    return d


def poetry_main():
    addresses = parse_args()

    from twisted.internet import reactor

    poems = []
    errors = []

    def got_poem(poem):
        poems.append(poem)

    def poem_failed(err):
        print &gt;&gt;sys.stderr, &apos;Poem failed:&apos;, err
        errors.append(err)

    def poem_done(_):
        if len(poems) + len(errors) == len(addresses):
            reactor.stop()

    for address in addresses:
        host, port = address
        d = get_poetry(host, port)
        d.addCallbacks(got_poem, poem_failed)
        d.addBoth(poem_done)

    reactor.run()

    for poem in poems:
        print poem


if __name__ == &apos;__main__&apos;:
    poetry_main()</code></pre><p><img src="https://github.com/garydai/garydai.github.com/raw/master/_posts/pic/twisted4.png" alt=""></p>
<pre><code>socket.setblocking(flag)

Set blocking or non-blocking mode of the socket: if flag is 0, the socket is set to non-blocking, else to blocking mode. Initially all sockets are in blocking mode. In non-blocking mode, if a recv() call doesn’t find any data, or if a send() call can’t immediately dispose of the data, a error exception is raised; in blocking mode, the calls block until they can proceed. s.setblocking(0) is equivalent to s.settimeout(0.0); s.setblocking(1) is equivalent to s.settimeout(None).



class ClientFactory(Factory):
    &quot;&quot;&quot;A Protocol factory for clients.

    This can be used together with the various connectXXX methods in
    reactors.
    &quot;&quot;&quot;

    def startedConnecting(self, connector):
        &quot;&quot;&quot;Called when a connection has been started.

        You can call connector.stopConnecting() to stop the connection attempt.

        @param connector: a Connector object.
        &quot;&quot;&quot;

    def clientConnectionFailed(self, connector, reason):
        &quot;&quot;&quot;Called when a connection has failed to connect.

        It may be useful to call connector.connect() - this will reconnect.

        @type reason: L{twisted.python.failure.Failure}
        &quot;&quot;&quot;

    def clientConnectionLost(self, connector, reason):
        &quot;&quot;&quot;Called when an established connection is lost.

        It may be useful to call connector.connect() - this will reconnect.

        @type reason: L{twisted.python.failure.Failure}
        &quot;&quot;&quot;





@implementer(interfaces.IProtocolFactory, interfaces.ILoggingContext)
class Factory:
    &quot;&quot;&quot;
    This is a factory which produces protocols.

    By default, buildProtocol will create a protocol of the class given in
    self.protocol.
    &quot;&quot;&quot;

    # put a subclass of Protocol here:
    protocol = None

    numPorts = 0
    noisy = True

    @classmethod
    def forProtocol(cls, protocol, *args, **kwargs):
        &quot;&quot;&quot;
        Create a factory for the given protocol.

        It sets the C{protocol} attribute and returns the constructed factory
        instance.

        @param protocol: A L{Protocol} subclass

        @param args: Positional arguments for the factory.

        @param kwargs: Keyword arguments for the factory.

        @return: A L{Factory} instance wired up to C{protocol}.
        &quot;&quot;&quot;
        factory = cls(*args, **kwargs)
        factory.protocol = protocol
        return factory


    def logPrefix(self):
        &quot;&quot;&quot;
        Describe this factory for log messages.
        &quot;&quot;&quot;
        return self.__class__.__name__


    def doStart(self):
        &quot;&quot;&quot;Make sure startFactory is called.

        Users should not call this function themselves!
        &quot;&quot;&quot;
        if not self.numPorts:
            if self.noisy:
                log.msg(&quot;Starting factory %r&quot; % self)
            self.startFactory()
        self.numPorts = self.numPorts + 1

    def doStop(self):
        &quot;&quot;&quot;Make sure stopFactory is called.

        Users should not call this function themselves!
        &quot;&quot;&quot;
        if self.numPorts == 0:
            # this shouldn&apos;t happen, but does sometimes and this is better
            # than blowing up in assert as we did previously.
            return
        self.numPorts = self.numPorts - 1
        if not self.numPorts:
            if self.noisy:
                log.msg(&quot;Stopping factory %r&quot; % self)
            self.stopFactory()

    def startFactory(self):
        &quot;&quot;&quot;This will be called before I begin listening on a Port or Connector.

        It will only be called once, even if the factory is connected
        to multiple ports.

        This can be used to perform &apos;unserialization&apos; tasks that
        are best put off until things are actually running, such
        as connecting to a database, opening files, etcetera.
        &quot;&quot;&quot;

    def stopFactory(self):
        &quot;&quot;&quot;This will be called before I stop listening on all Ports/Connectors.

        This can be overridden to perform &apos;shutdown&apos; tasks such as disconnecting
        database connections, closing files, etc.

        It will be called, for example, before an application shuts down,
        if it was connected to a port. User code should not call this function
        directly.
        &quot;&quot;&quot;


    def buildProtocol(self, addr):
        &quot;&quot;&quot;
        Create an instance of a subclass of Protocol.

        The returned instance will handle input on an incoming server
        connection, and an attribute &quot;factory&quot; pointing to the creating
        factory.

        Alternatively, C{None} may be returned to immediately close the
        new connection.

        Override this method to alter how Protocol instances get created.

        @param addr: an object implementing L{twisted.internet.interfaces.IAddress}
        &quot;&quot;&quot;
        p = self.protocol()
        p.factory = self
        return p</code></pre><p>###安装</p>
<pre><code>sudo pip install lxml==3.1.2 --trusted-host pypi.python.org

sudo pip install Scrapy --trusted-host pypi.python.org</code></pre>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2015/02/13/2015-2-13-tornado/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2015/02/13/2015-2-13-tornado/" itemprop="url">tornado</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2015-02-13T00:00:00+08:00">
                2015-02-13
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>##tornado框架分析</p>
<p>异步IO，有ASIO与IOCP的感觉</p>
<p>创建一个线程处理新的连接</p>
<p>创建一个进程处理新的连接</p>
<p>使用非阻塞的socket和epoll io模型</p>
<p>HTTPServer.listen tcpserver.listen _handle_connection handle_stream</p>
<p>IOLoop</p>
<p>io_loop.add_handler io_loop.start</p>
<p>ioloop.IOLoop.instance() IOLoop._instance 单例模式</p>
<p>工厂模式</p>
<pre><code>def configurable_default(cls):
    if hasattr(select, &quot;epoll&quot;):
        from tornado.platform.epoll import EPollIOLoop
        return EPollIOLoop
    if hasattr(select, &quot;kqueue&quot;):
        # Python 2.6+ on BSD or Mac
        from tornado.platform.kqueue import KQueueIOLoop
        return KQueueIOLoop
    from tornado.platform.select import SelectIOLoop
    return SelectIOLoop





event_pairs = self._impl.poll(poll_timeout)

epoll模式
impl=select.epoll()</code></pre><p>A non-blocking, single-threaded HTTP server</p>
<p>##reference</p>
<p><a href="http://www.cnblogs.com/Bozh/archive/2012/07/19/2598696.html" target="_blank" rel="noopener">http://www.cnblogs.com/Bozh/archive/2012/07/19/2598696.html</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2015/02/11/2015-2-11-django/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2015/02/11/2015-2-11-django/" itemprop="url">django</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2015-02-11T00:00:00+08:00">
                2015-02-11
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>##django框架分析</p>
<p>1.设置处理request的事件</p>
<p><img src="https://github.com/garydai/garydai.github.com/raw/master/_posts/pic/django.png" alt=""></p>
<p><img src="https://github.com/garydai/garydai.github.com/raw/master/_posts/pic/django2.png" alt=""></p>
<ol>
<li><p>用户通过浏览器请求一个页面</p>
</li>
<li><p>请求到达Request Middlewares，中间件对request做一些预处理或者直接response请求</p>
</li>
<li><p>URLConf通过urls.py文件和请求的URL找到相应的View</p>
</li>
<li><p>View Middlewares被访问，它同样可以对request做一些处理或者直接返回response</p>
</li>
<li><p>调用View中的函数</p>
</li>
<li><p>View中的方法可以选择性的通过Models访问底层的数据</p>
</li>
<li><p>所有的Model-to-DB的交互都是通过manager完成的</p>
</li>
<li><p>如果需要，Views可以使用一个特殊的Context</p>
</li>
<li><p>Context被传给Template用来生成页面</p>
</li>
</ol>
<p>9.1. Template使用Filters和Tags去渲染输出</p>
<p>9.2. 输出被返回到View</p>
<p>9.3. HTTPResponse被发送到Response Middlewares</p>
<p>9.4. 任何Response Middlewares都可以丰富response或者返回一个完全不同的response</p>
<p>9.5. Response返回到浏览器，呈现给用户</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/19/">&lt;i class&#x3D;&quot;fa fa-angle-left&quot;&gt;&lt;&#x2F;i&gt;</a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/19/">19</a><span class="page-number current">20</span><a class="page-number" href="/page/21/">21</a><span class="space">&hellip;</span><a class="page-number" href="/page/28/">28</a><a class="extend next" rel="next" href="/page/21/">&lt;i class&#x3D;&quot;fa fa-angle-right&quot;&gt;&lt;&#x2F;i&gt;</a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">John Doe</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/%20%7C%7C%20archive">
              
                  <span class="site-state-item-count">271</span>
                  <span class="site-state-item-name">posts</span>
                </a>
              </div>
            

            

            

          </nav>

          

          

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">John Doe</span>

  
</div>


  <div class="powered-by">Powered by <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a></div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Muse</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  

</body>
</html>
