<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="en">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT" />










<meta name="description" content="java 并发c语言thread创建线程12int pthread_create(pthread_t * tid, const pthread_attr_t * attr, void * ( * func) (void * ), void * arg);其返回值是一个整数，若创建进程成功返回0，否则，返回其他错误代码，也是正整数。 结束线程12void pthread_exit (void *st">
<meta property="og:type" content="article">
<meta property="og:title" content="java thread">
<meta property="og:url" content="http://yoursite.com/2019/07/26/2019-7-26-java%E5%B9%B6%E5%8F%91/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="java 并发c语言thread创建线程12int pthread_create(pthread_t * tid, const pthread_attr_t * attr, void * ( * func) (void * ), void * arg);其返回值是一个整数，若创建进程成功返回0，否则，返回其他错误代码，也是正整数。 结束线程12void pthread_exit (void *st">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://github.com/garydai/garydai.github.com/raw/master/_posts/pic/jvm-mark.png">
<meta property="og:image" content="https://github.com/garydai/garydai.github.com/raw/master/_posts/pic/synchronized.png">
<meta property="og:image" content="https://github.com/garydai/garydai.github.com/raw/master/_posts/pic/synchronized-00.png">
<meta property="og:image" content="https://github.com/garydai/garydai.github.com/raw/master/_posts/pic/synchronized-bias.png">
<meta property="og:image" content="https://github.com/garydai/garydai.github.com/raw/master/_posts/pic/aqs.png">
<meta property="article:published_time" content="2019-07-25T16:00:00.000Z">
<meta property="article:modified_time" content="2020-01-06T07:17:32.762Z">
<meta property="article:author" content="John Doe">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://github.com/garydai/garydai.github.com/raw/master/_posts/pic/jvm-mark.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/2019/07/26/2019-7-26-java并发/"/>





  <title>java thread | Hexo</title>
  








<meta name="generator" content="Hexo 4.2.0"></head>

<body itemscope itemtype="http://schema.org/WebPage" lang="en">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Hexo</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/%20" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/%20" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            Archives
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/07/26/2019-7-26-java%E5%B9%B6%E5%8F%91/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">java thread</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-07-26T00:00:00+08:00">
                2019-07-26
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h2 id="java-并发"><a href="#java-并发" class="headerlink" title="java 并发"></a>java 并发</h2><h3 id="c语言thread"><a href="#c语言thread" class="headerlink" title="c语言thread"></a>c语言thread</h3><h4 id="创建线程"><a href="#创建线程" class="headerlink" title="创建线程"></a>创建线程</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">int pthread_create(pthread_t * tid, const pthread_attr_t * attr, void * ( * func) (void * ), void * arg);</span><br><span class="line">其返回值是一个整数，若创建进程成功返回0，否则，返回其他错误代码，也是正整数。</span><br></pre></td></tr></table></figure>
<h4 id="结束线程"><a href="#结束线程" class="headerlink" title="结束线程"></a>结束线程</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">void pthread_exit (void *status);</span><br><span class="line">参数是指针类型，用于存储线程结束后返回状态。</span><br></pre></td></tr></table></figure>
<h4 id="线程等待"><a href="#线程等待" class="headerlink" title="线程等待"></a>线程等待</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">int pthread_join (pthread_t tid, void ** status);</span><br><span class="line"></span><br><span class="line">第一个参数表示要等待的进程的id；</span><br><span class="line">第二参数表示要等待的进程的返回状态，是个二级指针。</span><br></pre></td></tr></table></figure>
<h4 id="返回当前线程ID"><a href="#返回当前线程ID" class="headerlink" title="返回当前线程ID"></a>返回当前线程ID</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">pthread_t pthread_self (void);</span><br><span class="line">用于返回当前进程的ID</span><br></pre></td></tr></table></figure>
<h4 id="制定线程变成分裂状态"><a href="#制定线程变成分裂状态" class="headerlink" title="制定线程变成分裂状态"></a>制定线程变成分裂状态</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">int pthread_detach (pthread_t tid);</span><br><span class="line">参数是指定线程的ID，指定的ID的线程变成分离状态；若指定线程是分离状态，则 如果线程退出，那么它所有的资源都将释放，如果线程不是分离状态，线程必须保留它的线程ID、退出状态，直到其他线程对他调用的pthread_join()函数</span><br></pre></td></tr></table></figure>
<h3 id="c语言锁"><a href="#c语言锁" class="headerlink" title="c语言锁"></a>c语言锁</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">互斥锁</span><br><span class="line">pthread_mutex_t mutex 锁对象</span><br><span class="line">pthread_mutex_init(&amp;mutex,NULL) 在主线程中初始化锁为解锁状态</span><br><span class="line">pthread_mutex_t mutex &#x3D; PTHREAD_MUTEX_INITIALIZER 编译时初始化锁位解锁状态</span><br><span class="line">pthread_mutex_lock(&amp;mutex): 访问临界区加锁操作</span><br><span class="line">pthread_mutex_unlock(&amp;mutex): 访问临界区解锁操作</span><br><span class="line"></span><br><span class="line">条件变量</span><br><span class="line">pthread_cond_init</span><br><span class="line">pthread_cond_destroy</span><br><span class="line">pthread_cond_wait</span><br><span class="line">pthread_cond_timedwait</span><br><span class="line">pthread_cond_signal</span><br><span class="line">pthread_cond_broadcast</span><br><span class="line"></span><br><span class="line">信号量</span><br><span class="line">int sem_init(sem_t * sem, int pshared, unsigned int value);初始化信号量</span><br><span class="line">int sem_wait(sem_t *sem); 信号量减一操作，有线程申请资源</span><br><span class="line">int sem_post(sem_t *sem);信号量加一操作，有线程释放资源</span><br><span class="line">int sem_destroy(sem_t *sem); 销毁信号量。</span><br></pre></td></tr></table></figure>

<h3 id="thread"><a href="#thread" class="headerlink" title="thread"></a>thread</h3><h4 id="中断线程"><a href="#中断线程" class="headerlink" title="中断线程"></a>中断线程</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">public void run() &#123;</span><br><span class="line">    while (!Thread.currentThread().isInterrupted()&amp;&amp; more work to do) &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            ...</span><br><span class="line">            sleep(delay);</span><br><span class="line">        &#125; catch (InterruptedException e) &#123;</span><br><span class="line">            Thread.currentThread().interrupt();&#x2F;&#x2F;重新设置中断标示</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">抛出InterruptedException异常后，中断标示位会自动清除,所以要重新设置中断表示</span><br></pre></td></tr></table></figure>

<p><a href="https://www.cnblogs.com/onlywujun/p/3565082.html" target="_blank" rel="noopener">https://www.cnblogs.com/onlywujun/p/3565082.html</a></p>
<h4 id="指令重排"><a href="#指令重排" class="headerlink" title="指令重排"></a>指令重排</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">public class ThreadExample &#123;</span><br><span class="line">    static Thread thread &#x3D; null;</span><br><span class="line">    int i;</span><br><span class="line">    public volatile static boolean runing &#x3D; true;</span><br><span class="line"></span><br><span class="line">    public static void main(String[] args) throws InterruptedException &#123;</span><br><span class="line">        traditional();</span><br><span class="line">        Thread.sleep(100);</span><br><span class="line">        runing &#x3D; false;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    public static void traditional() &#123;</span><br><span class="line">        thread &#x3D; new Thread() &#123;</span><br><span class="line">            @Override</span><br><span class="line">            public void run() &#123;</span><br><span class="line">               while (runing)&#123;           </span><br><span class="line">                 &#x2F;&#x2F;i++;</span><br><span class="line">               &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">        thread.start();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">public static void aa()&#123;</span><br><span class="line">        Integer i&#x3D;1;</span><br><span class="line">        i.toString();</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">traditional被重排，running变成函数变量</span><br><span class="line">public static void traditional() &#123;</span><br><span class="line">        bool temp &#x3D; running;</span><br><span class="line">        thread &#x3D; new Thread() &#123;</span><br><span class="line">            @Override</span><br><span class="line">            public void run() &#123;</span><br><span class="line">               while (temp)&#123;           </span><br><span class="line">                 &#x2F;&#x2F;i++;</span><br><span class="line">               &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">        thread.start();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">所以线程不会被中断，一直再运行</span><br></pre></td></tr></table></figure>

<h3 id="java并发编程基础"><a href="#java并发编程基础" class="headerlink" title="java并发编程基础"></a>java并发编程基础</h3><h4 id="unsafe"><a href="#unsafe" class="headerlink" title="unsafe"></a>unsafe</h4><p>rt.jar包的Unsafe类，提供硬件级别的原子性操作</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">native</span> <span class="keyword">int</span> <span class="title">getInt</span><span class="params">(Object var1, <span class="keyword">long</span> var2)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">native</span> <span class="keyword">void</span> <span class="title">putInt</span><span class="params">(Object var1, <span class="keyword">long</span> var2, <span class="keyword">int</span> var4)</span></span>;</span><br><span class="line">等等</span><br><span class="line"></span><br><span class="line">park unpark</span><br></pre></td></tr></table></figure>

<p>底层jvm实现都是通过cas来实现原子性，park、unpark是通过条件变量来实现阻塞和唤醒</p>
<h4 id="JUC里原子性操作AtomicInter、AtomicBoolean"><a href="#JUC里原子性操作AtomicInter、AtomicBoolean" class="headerlink" title="JUC里原子性操作AtomicInter、AtomicBoolean"></a>JUC里原子性操作AtomicInter、AtomicBoolean</h4><p>juc的原子性操作都是基于Unsafe类实现</p>
<h4 id="LockSupport"><a href="#LockSupport" class="headerlink" title="LockSupport"></a>LockSupport</h4><p>基于Unsafe类实现的同步工具，主要作用是挂起和唤醒线程，LockSupport.park、LockSupport.unpark</p>
<h3 id="java-lock"><a href="#java-lock" class="headerlink" title="java lock"></a>java lock</h3><h4 id="AQS"><a href="#AQS" class="headerlink" title="AQS"></a>AQS</h4><p>基于LockSupport实现的同步工具</p>
<p>实现一个双向队列，挂起的线程插入到队列的尾部</p>
<p>子类继承aqs，子类实现tryAcquire，用cas判断锁状态，成功则返回，失败则线程挂起并插入到aqs阻塞队列尾部（aqs实现）。子类实现tryRelease，设置锁没有被占用状态，设置成功返回true，否则返回false</p>
<h5 id="ReentrantLock"><a href="#ReentrantLock" class="headerlink" title="ReentrantLock"></a>ReentrantLock</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ReentrantLock</span> <span class="keyword">implements</span> <span class="title">Lock</span>, <span class="title">java</span>.<span class="title">io</span>.<span class="title">Serializable</span> </span>&#123;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> Sync sync;</span><br><span class="line">  <span class="keyword">abstract</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Sync</span> <span class="keyword">extends</span> <span class="title">AbstractQueuedSynchronizer</span> </span>&#123;</span><br><span class="line">    实现两个抽象函数</span><br><span class="line">    tryAcquire()</span><br><span class="line">      </span><br><span class="line">    tryRelease()  </span><br><span class="line">     </span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">ReentrantLock lock = <span class="keyword">new</span> ReentrantLock();</span><br><span class="line">lock.lock();</span><br><span class="line">lock.unlock();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">加锁调用流程</span><br><span class="line">ReentrantLock: lock()</span><br><span class="line">FairSync: lock()</span><br><span class="line">AbstractQueuedSynchronizer: acquire(<span class="keyword">int</span> arg)</span><br><span class="line">ReentrantLock: tryAcquire(<span class="keyword">int</span> acquires)</span><br><span class="line">解锁调用流程</span><br><span class="line">ReentrantLock: unlock()</span><br><span class="line">AbstractQueuedSynchronizer: release(<span class="keyword">int</span> arg)</span><br><span class="line">Sync: tryAcquire(<span class="keyword">int</span> releases)</span><br></pre></td></tr></table></figure>

<h4 id="synchronized（1-6之前都是重量级锁）-monitorenter-jvm指令"><a href="#synchronized（1-6之前都是重量级锁）-monitorenter-jvm指令" class="headerlink" title="synchronized（1.6之前都是重量级锁） (monitorenter jvm指令)"></a>synchronized（1.6之前都是重量级锁） (monitorenter jvm指令)</h4><p>java虚拟机中的同步(Synchronization)基于进入和退出管程(Monitor)对象实现，无论是显式同步(有明确的monitorenter和monitorexit指令,即同步代码块)还是隐式同步都是如此。在Java语言中，同步用的最多的地方可能是被synchronized修饰的同步方法。同步方法并不是由monitorenter和monitorexit指令来实现同步的，而是由方法调用指令读取运行时常量池中方法的ACC_SYNCHRONIZED标志来隐式实现的</p>
<p><img src="https://github.com/garydai/garydai.github.com/raw/master/_posts/pic/jvm-mark.png" alt=""></p>
<p>当对象状态为偏向锁（biasable）时，mark word存储的是偏向的线程ID；当状态为轻量级锁（lightweight locked）时，mark word存储的是指向线程栈中Lock Record的指针；当状态为重量级锁（inflated）时，为指向堆中的monitor对象（ObjectMonitor）的指针。</p>
<p>当一个线程尝试获得锁时，如果该锁已经被占用，则会将该线程封装成一个ObjectWaiter对象插入到cxq的队列尾部，然后暂停当前线程。当持有锁的线程释放锁前，会将cxq中的所有元素移动到EntryList中去，并唤醒EntryList的队首线程。</p>
<p>如果一个线程在同步块中调用了Object#wait方法，会将该线程对应的ObjectWaiter从EntryList移除并加入到WaitSet中，然后释放锁。当wait的线程被notify之后，会将对应的ObjectWaiter从WaitSet移动到EntryList中。</p>
<p>设置对象头锁状态，通过cas_set_mark（atomic_cmpxchg_at）解决并发问题</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">atomic_cmpxchg_at(x, p, (ptrdiff_t)offset, e)</span><br><span class="line">if x &#x3D;&#x3D; *(p+offset) then *(p+offset) &#x3D; e</span><br><span class="line"></span><br><span class="line">同数据库的乐观锁操作，1.get old time value 2.update set new value where now value &#x3D;old time value</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br></pre></td><td class="code"><pre><span class="line">每个对象都存在着一个monitor与之关联，用于重量级锁</span><br><span class="line"></span><br><span class="line">    ObjectMonitor() &#123;</span><br><span class="line">        _header       &#x3D; NULL;</span><br><span class="line">        _count        &#x3D; 0; &#x2F;&#x2F;记录个数</span><br><span class="line">        _waiters      &#x3D; 0,</span><br><span class="line">        _recursions   &#x3D; 0;</span><br><span class="line">        _object       &#x3D; NULL;</span><br><span class="line">        _owner        &#x3D; NULL; &#x2F;&#x2F;指向持有锁的线程</span><br><span class="line">        _WaitSet      &#x3D; NULL; &#x2F;&#x2F;处于wait状态的线程，会被加入到_WaitSet</span><br><span class="line">        _WaitSetLock  &#x3D; 0 ;</span><br><span class="line">        _Responsible  &#x3D; NULL ;</span><br><span class="line">        _succ         &#x3D; NULL ;</span><br><span class="line">        _cxq          &#x3D; NULL ;</span><br><span class="line">        FreeNext      &#x3D; NULL ;</span><br><span class="line">        _EntryList    &#x3D; NULL ; &#x2F;&#x2F;处于等待锁block状态的线程，会被加入到该列表</span><br><span class="line">        _SpinFreq     &#x3D; 0 ;</span><br><span class="line">        _SpinClock    &#x3D; 0 ;</span><br><span class="line">        OwnerIsThread &#x3D; 0 ;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    线程运行到synchronized时候，会在栈上创建一个BasicObjectLock对象，即对象头里的Lock Record指针指向的地方</span><br><span class="line"></span><br><span class="line">    class BasicObjectLock &#123;</span><br><span class="line">        friend class VMStructs;</span><br><span class="line">        private:</span><br><span class="line">        BasicLock _lock;                                    &#x2F;&#x2F; the lock, must be double word aligned</span><br><span class="line">        oop       _obj;                                     &#x2F;&#x2F; object holds the lock;</span><br><span class="line"></span><br><span class="line">        public:</span><br><span class="line">        &#x2F;&#x2F; Manipulation</span><br><span class="line">        oop      obj() const                                &#123; return _obj;  &#125;</span><br><span class="line">        void set_obj(oop obj)                               &#123; _obj &#x3D; obj; &#125;</span><br><span class="line">        BasicLock* lock()                                   &#123; return &amp;_lock; &#125;</span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F; Note: Use frame::interpreter_frame_monitor_size() for the size of BasicObjectLocks</span><br><span class="line">        &#x2F;&#x2F;       in interpreter activation frames since it includes machine-specific padding.</span><br><span class="line">        static int size()                                   &#123; return sizeof(BasicObjectLock)&#x2F;wordSize; &#125;</span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F; GC support</span><br><span class="line">        void oops_do(OopClosure* f) &#123; f-&gt;do_oop(&amp;_obj); &#125;</span><br><span class="line"></span><br><span class="line">        static int obj_offset_in_bytes()                    &#123; return offset_of(BasicObjectLock, _obj);  &#125;</span><br><span class="line">        static int lock_offset_in_bytes()                   &#123; return offset_of(BasicObjectLock, _lock); &#125;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    class BasicLock &#123;</span><br><span class="line">        friend class VMStructs;</span><br><span class="line">        friend class JVMCIVMStructs;</span><br><span class="line">        private:</span><br><span class="line">        volatile markOop _displaced_header;</span><br><span class="line">        public:</span><br><span class="line">        markOop      displaced_header() const               &#123; return _displaced_header; &#125;</span><br><span class="line">        void         set_displaced_header(markOop header)   &#123; _displaced_header &#x3D; header; &#125;</span><br><span class="line"></span><br><span class="line">        void print_on(outputStream* st) const;</span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F; move a basic lock (used during deoptimization</span><br><span class="line">        void move_to(oop obj, BasicLock* dest);</span><br><span class="line"></span><br><span class="line">        static int displaced_header_offset_in_bytes()       &#123; return offset_of(BasicLock, _displaced_header); &#125;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    CASE(_monitorenter): &#123;</span><br><span class="line">        oop lockee &#x3D; STACK_OBJECT(-1); &#x2F;&#x2F;锁对象</span><br><span class="line">        &#x2F;&#x2F; derefing&#39;s lockee ought to provoke implicit null check</span><br><span class="line">        CHECK_NULL(lockee);</span><br><span class="line">        &#x2F;&#x2F; find a free monitor or one already allocated for this object</span><br><span class="line">        &#x2F;&#x2F; if we find a matching object then we need a new monitor</span><br><span class="line">        &#x2F;&#x2F; since this is recursive enter</span><br><span class="line">        BasicObjectLock* limit &#x3D; istate-&gt;monitor_base();</span><br><span class="line">        BasicObjectLock* most_recent &#x3D; (BasicObjectLock*) istate-&gt;stack_base();</span><br><span class="line">        BasicObjectLock* entry &#x3D; NULL;</span><br><span class="line">        &#x2F;&#x2F;找到一个空闲的Lock Record</span><br><span class="line">        while (most_recent !&#x3D; limit ) &#123;</span><br><span class="line">          if (most_recent-&gt;obj() &#x3D;&#x3D; NULL) entry &#x3D; most_recent;</span><br><span class="line">          else if (most_recent-&gt;obj() &#x3D;&#x3D; lockee) break;</span><br><span class="line">          most_recent++;</span><br><span class="line">        &#125;</span><br><span class="line">        if (entry !&#x3D; NULL) &#123;</span><br><span class="line">          &#x2F;&#x2F;设置持有该lock record的对象</span><br><span class="line">          entry-&gt;set_obj(lockee);</span><br><span class="line">          int success &#x3D; false;</span><br><span class="line">          uintptr_t epoch_mask_in_place &#x3D; (uintptr_t)markOopDesc::epoch_mask_in_place;</span><br><span class="line"></span><br><span class="line">          markOop mark &#x3D; lockee-&gt;mark();</span><br><span class="line">          intptr_t hash &#x3D; (intptr_t) markOopDesc::no_hash;</span><br><span class="line">          &#x2F;&#x2F; implies UseBiasedLocking</span><br><span class="line">          if (mark-&gt;has_bias_pattern()) &#123;</span><br><span class="line">            uintptr_t thread_ident;</span><br><span class="line">            uintptr_t anticipated_bias_locking_value;</span><br><span class="line">            thread_ident &#x3D; (uintptr_t)istate-&gt;thread();</span><br><span class="line">            anticipated_bias_locking_value &#x3D;</span><br><span class="line">              (((uintptr_t)lockee-&gt;klass()-&gt;prototype_header() | thread_ident) ^ (uintptr_t)mark) &amp;</span><br><span class="line">              ~((uintptr_t) markOopDesc::age_mask_in_place);</span><br><span class="line"></span><br><span class="line">            if  (anticipated_bias_locking_value &#x3D;&#x3D; 0) &#123;</span><br><span class="line">              &#x2F;&#x2F; already biased towards this thread, nothing to do</span><br><span class="line">              if (PrintBiasedLockingStatistics) &#123;</span><br><span class="line">                (* BiasedLocking::biased_lock_entry_count_addr())++;</span><br><span class="line">              &#125;</span><br><span class="line">              success &#x3D; true;</span><br><span class="line">            &#125;</span><br><span class="line">            else if ((anticipated_bias_locking_value &amp; markOopDesc::biased_lock_mask_in_place) !&#x3D; 0) &#123;</span><br><span class="line">              &#x2F;&#x2F; try revoke bias</span><br><span class="line">              markOop header &#x3D; lockee-&gt;klass()-&gt;prototype_header();</span><br><span class="line">              if (hash !&#x3D; markOopDesc::no_hash) &#123;</span><br><span class="line">                header &#x3D; header-&gt;copy_set_hash(hash);</span><br><span class="line">              &#125;</span><br><span class="line">              if (lockee-&gt;cas_set_mark(header, mark) &#x3D;&#x3D; mark) &#123;</span><br><span class="line">                if (PrintBiasedLockingStatistics)</span><br><span class="line">                  (*BiasedLocking::revoked_lock_entry_count_addr())++;</span><br><span class="line">              &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            else if ((anticipated_bias_locking_value &amp; epoch_mask_in_place) !&#x3D;0) &#123;</span><br><span class="line">              &#x2F;&#x2F; try rebias</span><br><span class="line">              markOop new_header &#x3D; (markOop) ( (intptr_t) lockee-&gt;klass()-&gt;prototype_header() | thread_ident);</span><br><span class="line">              if (hash !&#x3D; markOopDesc::no_hash) &#123;</span><br><span class="line">                new_header &#x3D; new_header-&gt;copy_set_hash(hash);</span><br><span class="line">              &#125;</span><br><span class="line">              if (lockee-&gt;cas_set_mark(new_header, mark) &#x3D;&#x3D; mark) &#123;</span><br><span class="line">                if (PrintBiasedLockingStatistics)</span><br><span class="line">                  (* BiasedLocking::rebiased_lock_entry_count_addr())++;</span><br><span class="line">              &#125;</span><br><span class="line">              else &#123;</span><br><span class="line">                CALL_VM(InterpreterRuntime::monitorenter(THREAD, entry), handle_exception);</span><br><span class="line">              &#125;</span><br><span class="line">              success &#x3D; true;</span><br><span class="line">            &#125;</span><br><span class="line">            else &#123;</span><br><span class="line">              &#x2F;&#x2F; try to bias towards thread in case object is anonymously biased</span><br><span class="line">              markOop header &#x3D; (markOop) ((uintptr_t) mark &amp; ((uintptr_t)markOopDesc::biased_lock_mask_in_place |</span><br><span class="line">                                                              (uintptr_t)markOopDesc::age_mask_in_place |</span><br><span class="line">                                                              epoch_mask_in_place));</span><br><span class="line">              if (hash !&#x3D; markOopDesc::no_hash) &#123;</span><br><span class="line">                header &#x3D; header-&gt;copy_set_hash(hash);</span><br><span class="line">              &#125;</span><br><span class="line">              markOop new_header &#x3D; (markOop) ((uintptr_t) header | thread_ident);</span><br><span class="line">              &#x2F;&#x2F; debugging hint</span><br><span class="line">              DEBUG_ONLY(entry-&gt;lock()-&gt;set_displaced_header((markOop) (uintptr_t) 0xdeaddead);)</span><br><span class="line">              if (lockee-&gt;cas_set_mark(new_header, header) &#x3D;&#x3D; header) &#123;</span><br><span class="line">                if (PrintBiasedLockingStatistics)</span><br><span class="line">                  (* BiasedLocking::anonymously_biased_lock_entry_count_addr())++;</span><br><span class="line">              &#125;</span><br><span class="line">              else &#123;</span><br><span class="line">                CALL_VM(InterpreterRuntime::monitorenter(THREAD, entry), handle_exception);</span><br><span class="line">              &#125;</span><br><span class="line">              success &#x3D; true;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">          &#x2F;&#x2F; traditional lightweight locking</span><br><span class="line">          if (!success) &#123;</span><br><span class="line">            markOop displaced &#x3D; lockee-&gt;mark()-&gt;set_unlocked();</span><br><span class="line">            entry-&gt;lock()-&gt;set_displaced_header(displaced);</span><br><span class="line">            bool call_vm &#x3D; UseHeavyMonitors;</span><br><span class="line">            if (call_vm || lockee-&gt;cas_set_mark((markOop)entry, displaced) !&#x3D; displaced) &#123;</span><br><span class="line">              &#x2F;&#x2F; Is it simple recursive case?</span><br><span class="line">              if (!call_vm &amp;&amp; THREAD-&gt;is_lock_owned((address) displaced-&gt;clear_lock_bits())) &#123;</span><br><span class="line">                entry-&gt;lock()-&gt;set_displaced_header(NULL);</span><br><span class="line">              &#125; else &#123;</span><br><span class="line">                CALL_VM(InterpreterRuntime::monitorenter(THREAD, entry), handle_exception);</span><br><span class="line">              &#125;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">          UPDATE_PC_AND_TOS_AND_CONTINUE(1, -1);</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            &#x2F;&#x2F; lock recoder不够，则开始栈扩张，stack_base往下移，重新开始执行</span><br><span class="line">          istate-&gt;set_msg(more_monitors);</span><br><span class="line">          UPDATE_PC_AND_RETURN(0); &#x2F;&#x2F; Re-execute</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://github.com/garydai/garydai.github.com/raw/master/_posts/pic/synchronized.png" alt=""></p>
<p>设置偏向锁<br><img src="https://github.com/garydai/garydai.github.com/raw/master/_posts/pic/synchronized-00.png" alt=""></p>
<h6 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h6><p><a href="https://blog.51cto.com/14440216/2426781" target="_blank" rel="noopener">https://blog.51cto.com/14440216/2426781</a></p>
<h5 id="偏向锁"><a href="#偏向锁" class="headerlink" title="偏向锁"></a>偏向锁</h5><p>我们的方法一定要保证线程安全，但是实际情况不一定有互斥， 所以偏向锁是synchronized锁的对象如果没有资源竞争的情况下存在的</p>
<p> 偏向锁不会调用os函数实现—第一次会调用</p>
<pre><code>os函数pthread_mutex_lock()//上锁
pthread_mutex_lock(){
     fprintf(stderr,&quot;msg&quot;+pthred_self());
}</code></pre><p>当JVM启用了偏向锁模式（1.6以上默认开启），当新创建一个对象的时候，如果该对象所属的class没有关闭偏向锁模式（什么时候会关闭一个class的偏向模式下文会说，默认所有class的偏向模式都是是开启的），那新创建对象的mark word将是可偏向状态，此时mark word中的thread id（参见上文偏向状态下的mark word格式）为0，表示未偏向任何线程，也叫做匿名偏向(anonymously biased)。</p>
<p>加锁过程</p>
<p>case 1：当该对象第一次被线程获得锁的时候，发现是匿名偏向状态，则会用CAS指令，将mark word中的thread id由0改成当前线程Id。如果成功，则代表获得了偏向锁，继续执行同步块中的代码。否则，将偏向锁撤销，升级为轻量级锁。</p>
<p>case 2：当被偏向的线程再次进入同步块时，发现锁对象偏向的就是当前线程，在通过一些额外的检查后（细节见后面的文章），会往当前线程的栈中添加一条Displaced Mark Word为空的Lock Record中，然后继续执行同步块的代码，因为操纵的是线程私有的栈，因此不需要用到CAS指令；由此可见偏向锁模式下，当被偏向的线程再次尝试获得锁时，仅仅进行几个简单的操作就可以了，在这种情况下，synchronized关键字带来的性能开销基本可以忽略。</p>
<p>case 3.当其他线程进入同步块时，发现已经有偏向的线程了，则会进入到撤销偏向锁的逻辑里，一般来说，会在safepoint中去查看偏向的线程是否还存活，如果存活且还在同步块中则将锁升级为轻量级锁，原偏向的线程继续拥有锁，当前线程则走入到锁升级的逻辑里；如果偏向的线程已经不存活或者不在同步块中，则将对象头的mark word改为无锁状态（unlocked），之后再升级为轻量级锁。</p>
<p>由此可见，偏向锁升级的时机为：当锁已经发生偏向后，只要有另一个线程尝试获得偏向锁，则该偏向锁就会升级成轻量级锁。当然这个说法不绝对，因为还有批量重偏向这一机制。</p>
<p><img src="https://github.com/garydai/garydai.github.com/raw/master/_posts/pic/synchronized-bias.png" alt=""></p>
<p><a href="https://blog.51cto.com/14440216/2426781" target="_blank" rel="noopener">https://blog.51cto.com/14440216/2426781</a></p>
<h5 id="轻量级锁"><a href="#轻量级锁" class="headerlink" title="轻量级锁"></a>轻量级锁</h5><p>在多线程交替执行同步块的情况下</p>
<p>加锁过程</p>
<p>1.在线程栈中创建一个Lock Record，将其obj（即上图的Object reference）字段指向锁对象。</p>
<p>2.直接通过CAS指令将Lock Record的地址存储在对象头的mark word中，如果对象处于无锁状态则修改成功，代表该线程获得了轻量级锁。如果失败，进入到步骤3。</p>
<p>3.如果是当前线程已经持有该锁了，代表这是一次锁重入。设置Lock Record第一部分（Displaced Mark Word）为null，起到了一个重入计数器的作用。然后结束。</p>
<p>4.走到这一步说明发生了竞争，需要膨胀为重量级锁。</p>
<p>解锁过程</p>
<p>1.遍历线程栈,找到所有obj字段等于当前锁对象的Lock Record。</p>
<p>2.如果Lock Record的Displaced Mark Word为null，代表这是一次重入，将obj设置为null后continue。</p>
<p>3.如果Lock Record的Displaced Mark Word不为null，则利用CAS指令将对象头的mark word恢复成为Displaced Mark Word。如果成功，则continue，否则膨胀为重量级锁。</p>
<h5 id="重量级锁"><a href="#重量级锁" class="headerlink" title="重量级锁"></a>重量级锁</h5><p>os函数使用的锁 pthread_mutex_lock</p>
<p>synchronized关键字基于上述两个指令实现了锁的获取和释放过程，解释器执行monitorenter时会进入到InterpreterRuntime.cpp的InterpreterRuntime::monitorenter</p>
<p>偏向锁的入口位于synchronizer.cpp文件的ObjectSynchronizer::fast_enter</p>
<h5 id="条件变量"><a href="#条件变量" class="headerlink" title="条件变量"></a>条件变量</h5><p>Object.wait Object.notify配合synchronized实现条件变量锁</p>
<h4 id="AQS-1"><a href="#AQS-1" class="headerlink" title="AQS"></a>AQS</h4><p><img src="https://github.com/garydai/garydai.github.com/raw/master/_posts/pic/aqs.png" alt=""></p>
<h3 id="锁的是对象"><a href="#锁的是对象" class="headerlink" title="锁的是对象"></a>锁的是对象</h3><h2 id="os实现mutex"><a href="#os实现mutex" class="headerlink" title="os实现mutex"></a>os实现mutex</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">lock: </span><br><span class="line">	if(mutex &gt; 0)&#123; </span><br><span class="line">		mutex &#x3D; 0; </span><br><span class="line">		return 0; </span><br><span class="line">	&#125; else </span><br><span class="line">		挂起等待; </span><br><span class="line">	goto lock;</span><br><span class="line">		</span><br><span class="line">unlock: </span><br><span class="line">	mutex &#x3D; 1; </span><br><span class="line">	唤醒等待Mutex的线程; </span><br><span class="line">	return 0</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">判断锁过程不是原子</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">lock: </span><br><span class="line">	movb $0, %al </span><br><span class="line">	xchgb %al, mutex  寄存器和内存单元的数据相交换</span><br><span class="line">	if(al寄存器的内容 &gt; 0)&#123; </span><br><span class="line">		return 0; </span><br><span class="line">	&#125; else </span><br><span class="line">		挂起等待; </span><br><span class="line">	goto lock;</span><br><span class="line">		</span><br><span class="line">unlock: </span><br><span class="line">	movb $1, mutex </span><br><span class="line">	唤醒等待Mutex的线程; </span><br><span class="line">	return 0;</span><br><span class="line"></span><br><span class="line">    一条指令保证原子性</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">“挂起等待”和“唤醒等待线程”的操作如何实现？每个Mutex有一个等待队列，一个线程要在Mutex上挂起等待，首先把自己加入等待队列中，然后置线程状态为睡眠，接着调用调度器函数切换到别的线程。一个线程要唤醒等待队列中的其它线程，只需从等待队列中取出一项，把它的状态从睡眠改为就绪，加入就绪队列，那么下次调度器函数执行时就有可能切换到被唤醒的线程。</span><br></pre></td></tr></table></figure>

<p>体检机构选择：<br>1、金姗娜  A<br>2、罗武     B<br>3、祝诗炉  B<br>4、卜象平 B<br>5、张晨 B<br>6、何宝宁 A<br>7、牛玲B<br>8、陈薇 b<br>9、 孙博 B<br>10、翟君慧B11、 徐学斌 B</p>

      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2019/07/24/2019-7-24-java/" rel="next" title="java备忘">
                <i class="fa fa-chevron-left"></i> java备忘
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2019/07/31/2019-7-31-java-class-loader/" rel="prev" title="Java ClassLoader">
                Java ClassLoader <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            Table of Contents
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            Overview
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">John Doe</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/%20%7C%7C%20archive">
              
                  <span class="site-state-item-count">271</span>
                  <span class="site-state-item-name">posts</span>
                </a>
              </div>
            

            

            

          </nav>

          

          

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#java-并发"><span class="nav-number">1.</span> <span class="nav-text">java 并发</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#c语言thread"><span class="nav-number">1.1.</span> <span class="nav-text">c语言thread</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#创建线程"><span class="nav-number">1.1.1.</span> <span class="nav-text">创建线程</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#结束线程"><span class="nav-number">1.1.2.</span> <span class="nav-text">结束线程</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#线程等待"><span class="nav-number">1.1.3.</span> <span class="nav-text">线程等待</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#返回当前线程ID"><span class="nav-number">1.1.4.</span> <span class="nav-text">返回当前线程ID</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#制定线程变成分裂状态"><span class="nav-number">1.1.5.</span> <span class="nav-text">制定线程变成分裂状态</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#c语言锁"><span class="nav-number">1.2.</span> <span class="nav-text">c语言锁</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#thread"><span class="nav-number">1.3.</span> <span class="nav-text">thread</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#中断线程"><span class="nav-number">1.3.1.</span> <span class="nav-text">中断线程</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#指令重排"><span class="nav-number">1.3.2.</span> <span class="nav-text">指令重排</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#java并发编程基础"><span class="nav-number">1.4.</span> <span class="nav-text">java并发编程基础</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#unsafe"><span class="nav-number">1.4.1.</span> <span class="nav-text">unsafe</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#JUC里原子性操作AtomicInter、AtomicBoolean"><span class="nav-number">1.4.2.</span> <span class="nav-text">JUC里原子性操作AtomicInter、AtomicBoolean</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#LockSupport"><span class="nav-number">1.4.3.</span> <span class="nav-text">LockSupport</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#java-lock"><span class="nav-number">1.5.</span> <span class="nav-text">java lock</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#AQS"><span class="nav-number">1.5.1.</span> <span class="nav-text">AQS</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#ReentrantLock"><span class="nav-number">1.5.1.1.</span> <span class="nav-text">ReentrantLock</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#synchronized（1-6之前都是重量级锁）-monitorenter-jvm指令"><span class="nav-number">1.5.2.</span> <span class="nav-text">synchronized（1.6之前都是重量级锁） (monitorenter jvm指令)</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#参考"><span class="nav-number">1.5.2.0.1.</span> <span class="nav-text">参考</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#偏向锁"><span class="nav-number">1.5.2.1.</span> <span class="nav-text">偏向锁</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#轻量级锁"><span class="nav-number">1.5.2.2.</span> <span class="nav-text">轻量级锁</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#重量级锁"><span class="nav-number">1.5.2.3.</span> <span class="nav-text">重量级锁</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#条件变量"><span class="nav-number">1.5.2.4.</span> <span class="nav-text">条件变量</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#AQS-1"><span class="nav-number">1.5.3.</span> <span class="nav-text">AQS</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#锁的是对象"><span class="nav-number">1.6.</span> <span class="nav-text">锁的是对象</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#os实现mutex"><span class="nav-number">2.</span> <span class="nav-text">os实现mutex</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">John Doe</span>

  
</div>


  <div class="powered-by">Powered by <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a></div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Muse</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  

</body>
</html>
