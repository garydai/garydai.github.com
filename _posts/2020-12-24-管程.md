---
date: 2020-12-24
layout: default
title:  管程

---

# 管程

![image-20201224170034509](/Users/daitechang/Documents/garydai.github.com/_posts/pic/image-20201224170034509.png)

入口等待队列解决线程互斥问题

条件变量和条件变量等待队列解决线程同步问题

如果线程 T1 进入管程后恰好发现阻塞队列是空的，就去条件变量对应的等待队列里面等，线程 T1 进入条件变量的等待队列后，是允许其他线程进入管程的

Hasen 模型里面，要求 notify() 放在代码的最后，这样 T2 通知完 T1 后，T2 就结束了，然后 T1 再执行，这样就能保证同一时刻只有一个线程执行。

Hoare 模型里面，T2 通知完 T1 后，T2 阻塞，T1 马上执行；等 T1 执行完，再唤醒 T2，也能保证同一时刻只有一个线程执行。但是相比 Hasen 模型，T2 多了一次阻塞唤醒操作。

MESA 管程里面，T2 通知完 T1 后，T2 还是会接着执行，T1 并不立即执行，仅仅是从条件变量的等待队列进到入口等待队列里面。这样做的好处是 notify() 不用放到代码的最后，T2 也没有多余的阻塞唤醒操作。但是也有个副作用，就是当 T1 再次执行的时候，可能曾经满足的条件，现在已经不满足了，所以需要以循环方式检验条件变量。



## 参考

https://time.geekbang.org/column/article/86089