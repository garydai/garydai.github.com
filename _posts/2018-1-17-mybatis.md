---
layout: default

title: mybatis

---

## mybatis

封装了jdbc

### 单独使用

```
init SqlSessionFactory
configuration.addMapper(xxxMapper.class)
sqlSessionFactory.openSession()

动态代理xxxMapper，执行xxxMapper函数的时候发送sql命令
xxxMapper mapper = session.getMapper(xxxMapper.class);
mapper.select();
```

### spring+mybatis
init SqlSessionFactoryBean

mappper.xml


#### 扫描mapper（需要了解spring的factoryBean的概念）
第一步解析@MapperScan -> @Import(MapperScannerRegistrar.class) -> ClassPathMapperScanner.doScan扫描mapper，得到mapper的所有db -> processBeanDefinitions处理所有mapper（ setBeanClass(this.mapperFactoryBean.getClass())改变了db的BeanClass，为mapperFactoryBean；definition.setAutowireMode(AbstractBeanDefinition.AUTOWIRE_BY_TYPE);自动装配有setXXX函数的属性，不需要@autoWire注解，主要是为了注入DefaultSqlSessionFactory这个SqlSessionFactory， SqlSessionDaoSupport里有setSqlSessionFactory函数，函数里this.sqlSession = new SqlSessionTemplate(sqlSessionFactory)，完成SqlSessionTemplate实例，其中this.sqlSessionProxy = (SqlSession) newProxyInstance(
SqlSessionFactory.class.getClassLoader(),new Class[] { SqlSession.class },new SqlSessionInterceptor());又生成一个代理，InvocationHandler是SqlSessionInterceptor，执行完sql之后closeSqlSession）

#### 实例化MapperFactoryBean
getBean -> MapperFactoryBean.getObject -> getSqlSession().getMapper(this.mapperInterface)（mapperInterface即mapper接口）-> SqlSessionTemplate.getMapper -> MapperRegistry.getMapper（mapperProxyFactory.newInstance(sqlSession)创建mapper接口的代理对象）-> 反射出代理对象Proxy.newProxyInstance(mapperInterface.getClassLoader(), new Class[] { mapperInterface }, mapperProxy)，InvocationHandler为mapperProxy

@Bean sqlSessionFactoryBean

#### 导入sql语句
实例化的时候，将sql放入mappedStatement，MapperFactoryBean extends SqlSessionDaoSupport extentds DaoSupport implements InitializingBean（实现InitializingBean接口，能在bean实例化之后，进入afterPropertiesSet函数，然后调用父类的初始化过程，将sql语句放入sqlMapperedStatements字典）

#### 执行语句
mapper.method -> MapperProxy.invoke -> sqlSession.select -> SqlSessionTemplate.select -> sqlSessionFactory.select -> sqlSessionProxy.select -> DefaultSqlSession.select ->  MappedStatement ms = configuration.getMappedStatement(statement); prepareStatement

sqlSessionTemplate增强defaultSqlSession，执行语句之后，会关闭session，一级缓存会失效


### 接口层

### 数据处理层
#### 参数映射
#### SQL解析
#### SQL执行
#### 结果处理和映射

### 框架支撑层
### 引导层
![](https://github.com/garydai/garydai.github.com/raw/master/_posts/pic/mybatis.png)

![](https://github.com/garydai/garydai.github.com/raw/master/_posts/pic/mybatis2.png)