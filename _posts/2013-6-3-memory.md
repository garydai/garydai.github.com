---
layout: default
title: windows内存模型

---
##windows内存模型
###进程地址空间
我称之为虚拟内存。		
####内存模型
用户模式分区    
####页交换文件
页交换文件在硬盘上，一种内存的后备存储器。    
镜像，另一种后备存储器。  
###虚拟内存
###内存映射文件
硬盘上的文件映射在进程的地址空间中。		
1.创建或打开文件，创建文件内核对象	

	HANDLE CreateFile(
		PCSTR pszFileName,
		DWORD dwDesiredAccess,
		DWORD dwShareMode,
		PSECURITY_ATTRIBUTES psa,
		DWORD dwCreationDisposition,
		DWORD dwFlagsAndAttributes,
		HANDLE hTemplateFile);
2.创建内存映射文件内核对象   

	HANDLE CreateFileMapping(
		HANDLE hFile,
		PSECURITY_ATTRIBUTES psa,
		DWORD fdwProtect,
		DWORD dwMaximumSizeHigh,
		DWORD dwMaximumSizeLow,
		PCTSTR pszName);

3.映射到进程地址空间，在地址空间中预订区域并调拨物理存储器  

	PVOID MapViewOfFile(
		HANDLE hFileMappingObject,
		DWORD dwDesiredAccess,
		DWORD dwFileOffSetHigh,
		DWORD dwFileOffSetLow,
		SIZE_T dwNumberOfBytesToMap);

	
####用内存映射文件在进程间共享数据
当启动一个应用程序，系统会先调用CreateFile打开.exe文件，接着调用CreateFileMapping创建文件映射对象，最后调用MapViewOfFileEx映射到进程的固定地址空间(有.exe的PE文件指定基地址)。打开同一个应用程序，系统发现已经存在文件映射对象，就调用MapViewOfFileEx映射.exe文件到对应进程的地址空间。所以系统把相同文件映射到不同进程中，令进程共享程序的代码与数据。   
####以页交换文件为后备存储器的内存映射文件		
不再以磁盘文件作为后备存储器，则不需要打开文件创建文件内核对象，直接创建内存映射文件对象，把页交换文件映射到内存。    
多进程可以利用页交换文件的内存映射文件来共享数据。利用对映射文件对象取别名来标记对象。       
